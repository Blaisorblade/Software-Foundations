<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>Hoare: Hoare Logic</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Hoare<span class="subtitle">Hoare Logic</span></h1>

<div class="code code-tight">
</div>

<div class="doc">

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;$Date:&nbsp;2011-06-22&nbsp;14:56:13&nbsp;-0400&nbsp;(Wed,&nbsp;22&nbsp;Jun&nbsp;2011)&nbsp;$&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Alexandre&nbsp;Pilkiewicz&nbsp;suggests&nbsp;the&nbsp;following&nbsp;alternate&nbsp;type&nbsp;for&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;decorated&nbsp;WHILE&nbsp;construct:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;DCWhile&nbsp;:&nbsp;bexp&nbsp;-&gt;&nbsp;Assertion&nbsp;-&gt;&nbsp;dcom&nbsp;-&gt;&nbsp;Assertion&nbsp;-&gt;&nbsp;dcom<br/>
&nbsp;&nbsp;&nbsp;This&nbsp;leads&nbsp;to&nbsp;a&nbsp;simpler&nbsp;rule&nbsp;in&nbsp;the&nbsp;VC&nbsp;generator,&nbsp;which&nbsp;is&nbsp;much<br/>
&nbsp;&nbsp;&nbsp;easier&nbsp;to&nbsp;explain:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;DCWhile&nbsp;b&nbsp;P'&nbsp;c&nbsp;&nbsp;=&gt;&nbsp;((fun&nbsp;st&nbsp;=&gt;&nbsp;post&nbsp;c&nbsp;st&nbsp;/\&nbsp;bassn&nbsp;b&nbsp;st)&nbsp;~~&gt;&nbsp;P')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\&nbsp;(P&nbsp;~~&gt;&nbsp;post&nbsp;c)&nbsp;&nbsp;<span class="comment">(*&nbsp;post&nbsp;c&nbsp;is&nbsp;the&nbsp;loop&nbsp;invariant&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\&nbsp;verification_conditions&nbsp;P'&nbsp;c<br/>
&nbsp;&nbsp;&nbsp;His&nbsp;full&nbsp;development&nbsp;(based&nbsp;on&nbsp;an&nbsp;old&nbsp;version&nbsp;of&nbsp;our&nbsp;formalized<br/>
&nbsp;&nbsp;&nbsp;decorated&nbsp;programs,&nbsp;unfortunately),&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;file<br/>
&nbsp;&nbsp;&nbsp;/underconstruction/PilkiewiczFormalizedDecorated.v&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Export</span> <a class="idref" href="ImpList.html#"><span class="id" type="library">ImpList</span></a>.<br/>

<br/>
</div>

<div class="doc">
We've begun applying the mathematical tools developed in the
    first part of the course to studying the theory of a small
    programming language, Imp.

<div class="paragraph"> </div>

<ul class="doclist">
<li> We defined a type of <i>abstract syntax trees</i> for Imp, together
      with an <i>evaluation relation</i> (a partial function on states)
      that specifies the <i>operational semantics</i> of programs.

<div class="paragraph"> </div>

      The language we defined, though small, captures some of the key
      features of full-blown languages like C, C++, and Java,
      including the fundamental notion of mutable state and some
      common control structures.

<div class="paragraph"> </div>


</li>
<li> We proved a number of <i>metatheoretic properties</i> &mdash; "meta" in
      the sense that they are properties of the language as a whole,
      rather than properties of particular programs in the language.
      These included:

<div class="paragraph"> </div>

<ul class="doclist">
<li> determinacy of evaluation

<div class="paragraph"> </div>


</li>
<li> equivalence of some different ways of writing down the
          definition

<div class="paragraph"> </div>


</li>
<li> guaranteed termination of certain classes of programs

<div class="paragraph"> </div>


</li>
<li> correctness (in the sense of preserving meaning) of a number
          of useful program transformations

<div class="paragraph"> </div>


</li>
<li> behavioral equivalence of programs (in the optional chapter
          <span class="inlinecode"><span class="id" type="var">Equiv.v</span></span>).

<div class="paragraph"> </div>


</li>
</ul>
      If we stopped here, we would still have something useful: a set
      of tools for defining and discussing programming languages and
      language features that are mathematically precise, flexible, and
      easy to work with, applied to a set of key properties.

<div class="paragraph"> </div>

      All of these properties are things that language designers,
      compiler writers, and users might care about knowing.  Indeed,
      many of them are so fundamental to our understanding of the
      programming languages we deal with that we might not consciously
      recognize them as "theorems."  But properties that seem
      intuitively obvious can sometimes be quite subtle &mdash; or, in some
      cases, actually even wrong!

<div class="paragraph"> </div>

      We'll return to this theme later in the course when we discuss
      <i>types</i> and <i>type soundness</i>.

<div class="paragraph"> </div>


</li>
<li> We saw a couple of examples of <i>program verification</i> &mdash; using
      the precise definition of Imp to prove formally that certain
      particular programs (e.g., factorial and slow subtraction)
      satisfied particular specifications of their behavior. 
</li>
</ul>

<div class="paragraph"> </div>

 In this chapter, we'll take this last idea further.  We'll
    develop a reasoning system called <i>Floyd-Hoare Logic</i> &mdash; commonly,
    if somewhat unfairly, shortened to just <i>Hoare Logic</i> &mdash; in which
    each of the syntactic constructs of Imp is equipped with a single,
    generic "proof rule" that can be used to reason about programs
    involving this construct.

<div class="paragraph"> </div>

    Hoare Logic originates in the 1960s, and it continues to be the
    subject of intensive research right up to the present day.  It
    lies at the core of a huge variety of tools that are now being
    used to specify and verify real software systems. 
<div class="paragraph"> </div>

<a name="lab394"></a><h1 class="section">Hoare Logic</h1>

<div class="paragraph"> </div>

 Hoare Logic offers two important things: a natural way of
    writing down <i>specifications</i> of programs, and a <i>compositional
    proof technique</i> for proving that these specifications are met &mdash;
    where by "compositional" we mean that the structure of proofs
    directly mirrors the structure of the programs that they are
    about. 
<div class="paragraph"> </div>

<a name="lab395"></a><h2 class="section">Assertions</h2>

<div class="paragraph"> </div>

 If we're going to talk about specifications of programs, the first
    thing we'll want is a way of making <i>assertions</i> about properties
    that hold at particular points in time &mdash; i.e., properties that
    may or may not be true of a given state of the memory. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="Assertion"><span class="id" type="definition">Assertion</span></a> := <a class="idref" href="ImpList.html#state"><span class="id" type="definition">state</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab396"></a><h4 class="section">Exercise: 1 star (assertions)</h4>
 Paraphrase the following assertions in English.

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;=&nbsp;3<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;=&nbsp;<span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;=&nbsp;3&nbsp;<span style="font-family: arial;">&or;</span>&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;*&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(((<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>)))&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">False</span>
<div class="paragraph"> </div>

</div>
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 This way of writing assertions is formally correct &mdash; it
    precisely captures what we mean, and it is exactly what we will
    use in Coq proofs &mdash; but it is a bit heavy to look at, for several
    reasons.  First, every single assertion that we ever write is
    going to begin with <span class="inlinecode"><span class="id" type="keyword">fun</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode">=&gt;</span> <span class="inlinecode"></span>; (2) this state <span class="inlinecode"><span class="id" type="var">st</span></span> is the only
    one that we ever use to look up variables (we never need to talk
    about two different states at the same time); and (3) all the
    variable lookups in assertions are cluttered with <span class="inlinecode"><span class="id" type="var">asnat</span></span> or
    <span class="inlinecode"><span class="id" type="var">aslist</span></span> coercions.  When we are writing down assertions
    informally, we can make some simplifications: drop the initial
    <span class="inlinecode"><span class="id" type="keyword">fun</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode">=&gt;</span>, write just <span class="inlinecode"><span class="id" type="var">X</span></span> instead of <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span>, and elide <span class="inlinecode"><span class="id" type="var">asnat</span></span>
    and <span class="inlinecode"><span class="id" type="var">aslist</span></span>.  Informally, instead of writing

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;*&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;((<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>)))&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>)))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>)
<div class="paragraph"> </div>

</div>
    we'll write just

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~((<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>).
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

<a name="lab397"></a><h2 class="section">Hoare Triples</h2>

<div class="paragraph"> </div>

 Next, we need a way of specifying &mdash; making claims about &mdash; the
    behavior of commands. 
<div class="paragraph"> </div>

 Since we've defined assertions as a way of making claims about the
    properties of states, and since the behavior of a command is to
    transform one state to another, a claim about a command takes the
    following form:

<div class="paragraph"> </div>

<ul class="doclist">
<li> "If <span class="inlinecode"><span class="id" type="var">c</span></span> is started in a state satisfying assertion <span class="inlinecode"><span class="id" type="var">P</span></span>, and if
        <span class="inlinecode"><span class="id" type="var">c</span></span> eventually terminates, then the final state is guaranteed
        to satisfy the assertion <span class="inlinecode"><span class="id" type="var">Q</span></span>."

</li>
</ul>

<div class="paragraph"> </div>

    Such a claim is called a <i>Hoare Triple</i>.  The property <span class="inlinecode"><span class="id" type="var">P</span></span> is
    called the <i>precondition</i> of <span class="inlinecode"><span class="id" type="var">c</span></span>; <span class="inlinecode"><span class="id" type="var">Q</span></span> is the <i>postcondition</i> of
    <span class="inlinecode"><span class="id" type="var">c</span></span>. 
<div class="paragraph"> </div>

 (Traditionally, Hoare triples are written <span class="inlinecode">{<span class="id" type="var">P</span>}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{<span class="id" type="var">Q</span>}</span>, but single
    braces are already used for other things in Coq.)  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="hoare_triple"><span class="id" type="definition">hoare_triple</span></a> (<span class="id" type="var">P</span>:<a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) (<span class="id" type="var">c</span>:<a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a>) (<span class="id" type="var">Q</span>:<a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">P</span> <span class="id" type="var">st</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q</span> <span class="id" type="var">st'</span>.<br/>

<br/>
</div>

<div class="doc">
Since we'll be working a lot with Hoare triples, it's useful to
    have a compact notation:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;&nbsp;<span class="id" type="var">c</span>&nbsp;&nbsp;{{<span class="id" type="var">Q</span>}}.
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c" :=          (<a class="idref" href="Hoare.html#hoare_triple"><span class="id" type="definition">hoare_triple</span></a> <span class="id" type="var">P</span> <span class="id" type="var">c</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>)) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="var">hoare_spec_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c  {{ Q }}" := (<a class="idref" href="Hoare.html#hoare_triple"><span class="id" type="definition">hoare_triple</span></a> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">c</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="var">hoare_spec_scope</span>.<br/>
<span class="id" type="keyword">Open</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">hoare_spec_scope</span>.<br/>

<br/>
</div>

<div class="doc">
(The <span class="inlinecode"><span class="id" type="var">hoare_spec_scope</span></span> annotation here tells Coq that this
    notation is not global but is intended to be used in particular
    contexts.  The <span class="inlinecode"><span class="id" type="keyword">Open</span></span> <span class="inlinecode"><span class="id" type="keyword">Scope</span></span> tells Coq that this file is one such
    context.  The first notation &mdash; with missing postcondition &mdash; will
    not actually be used here; it's just a placeholder for a notation
    that we'll want to define later, when we discuss decorated
    programs.) 
<div class="paragraph"> </div>

<a name="lab398"></a><h4 class="section">Exercise: 1 star (triples)</h4>
 Paraphrase the following Hoare triples in English.  

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;5}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;+&nbsp;5)}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">Y</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">False</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">real_fact</span>&nbsp;<span class="id" type="var">x</span>}}.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{(<span class="id" type="var">Z</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(((<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>)}}
<div class="paragraph"> </div>

</div>
  <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab399"></a><h4 class="section">Exercise: 1 star (valid_triples)</h4>
 Which of the following Hoare triples are <i>valid</i> &mdash; i.e., the
    claimed relation between <span class="inlinecode"><span class="id" type="var">P</span></span>, <span class="inlinecode"><span class="id" type="var">c</span></span>, and <span class="inlinecode"><span class="id" type="var">Q</span></span> is true?  

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;5}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;2}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;3}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;0&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;5}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;2&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;3}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;0}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">False</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">False</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">True</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">True</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">SKIP</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">False</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;0}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;==&nbsp;0&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">END</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;1}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;1}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">END</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;100}}
<div class="paragraph"> </div>

</div>
 (Note that we're using informal mathematical notations for
   expressions inside of commands, for readability.  We'll continue
   doing so throughout the chapter.)  <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 To get us warmed up, here are two simple facts about Hoare
    triples. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_post_true"><span class="id" type="lemma">hoare_post_true</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">Q</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">c</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_pre_false"><span class="id" type="lemma">hoare_pre_false</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, ~(<span class="id" type="var">P</span> <span class="id" type="var">st</span>)) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">c</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HP</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab400"></a><h2 class="section">Weakest Preconditions</h2>

<div class="paragraph"> </div>

 Some Hoare triples are more interesting than others.  For example,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">False</span>&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
    is <i>not</i> very interesting: it is perfectly valid, but it tells us
    nothing useful.  Since the precondition isn't satisfied by any
    state, it doesn't describe any situations where we can use the
    command <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> to achieve the postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>.

<div class="paragraph"> </div>

    By contrast, 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;4&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
    is useful: it tells us that, if we can somehow create a situation
    in which we know that <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">4</span> <span class="inlinecode"><span style="font-family: arial;">&and;</span></span> <span class="inlinecode"><span class="id" type="var">Z</span></span> <span class="inlinecode">=</span> <span class="inlinecode">0</span>, then running this command
    will produce a state satisfying the postcondition.  However, this
    triple is still not as useful as it could be, because the <span class="inlinecode"><span class="id" type="var">Z</span></span> <span class="inlinecode">=</span> <span class="inlinecode">0</span>
    clause in the precondition actually has nothing to do with the
    postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>.  The <i>most</i> useful triple (with the same
    command and postcondition) is this one:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;4&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
    In other words, <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">4</span> is the <i>weakest</i> valid precondition of
    the command <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> for the postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>. 
<div class="paragraph"> </div>

 In general, we say that "<span class="inlinecode"><span class="id" type="var">P</span></span> is the weakest precondition of
    <span class="inlinecode"><span class="id" type="var">c</span></span> for <span class="inlinecode"><span class="id" type="var">Q</span></span>" if

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{{<span class="id" type="var">Q</span>}}</span>, and

<div class="paragraph"> </div>


</li>
<li> whenever <span class="inlinecode"><span class="id" type="var">P'</span></span> is an assertion such that <span class="inlinecode">{{<span class="id" type="var">P'</span>}}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{{<span class="id" type="var">Q</span>}}</span>, we
      have <span class="inlinecode"><span class="id" type="var">P'</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> implies <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> for all states <span class="inlinecode"><span class="id" type="var">st</span></span>.  
</li>
</ul>

<div class="paragraph"> </div>

 That is, <span class="inlinecode"><span class="id" type="var">P</span></span> is the weakest precondition of <span class="inlinecode"><span class="id" type="var">c</span></span> for <span class="inlinecode"><span class="id" type="var">Q</span></span>
    if (a) <span class="inlinecode"><span class="id" type="var">P</span></span> <i>is</i> a precondition for <span class="inlinecode"><span class="id" type="var">Q</span></span> and <span class="inlinecode"><span class="id" type="var">c</span></span>, and (b) <span class="inlinecode"><span class="id" type="var">P</span></span> is the
    <i>weakest</i> (easiest to satisfy) assertion that guarantees <span class="inlinecode"><span class="id" type="var">Q</span></span> after
    <span class="inlinecode"><span class="id" type="var">c</span></span>. 
<div class="paragraph"> </div>

<a name="lab401"></a><h4 class="section">Exercise: 1 star (wp)</h4>
 What are the weakest preconditions of the following commands
   for the following postconditions?

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">SKIP</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">Z</span>&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">Y</span>&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">X</span>&nbsp;==&nbsp;0&nbsp;<span class="id" type="var">THEN</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">W</span>&nbsp;+&nbsp;2&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">True</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;0&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>
 <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab402"></a><h2 class="section">Proof Rules</h2>

<div class="paragraph"> </div>

 The goal of Hoare logic is to provide a <i>compositional</i>
    method for proving the validity of Hoare triples.  That is, the
    structure of a program's correctness proof should mirror the
    structure of the program itself.  To this end, in the sections
    below, we'll introduce one rule for reasoning about each of the
    different syntactic forms of commands in Imp &mdash; one for
    assignment, one for sequencing, one for conditionals, etc. &mdash; plus
    a couple of "structural" rules that are useful for gluing things
    together. 
<div class="paragraph"> </div>

<a name="lab403"></a><h3 class="section">Assignment</h3>

<div class="paragraph"> </div>

 The rule for assignment is the most fundamental of the Hoare logic
    proof rules.  Here's how it works.

<div class="paragraph"> </div>

    Consider this (valid) Hoare triple:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    In English: if we start out in a state where the value of <span class="inlinecode"><span class="id" type="var">Y</span></span>
    is <span class="inlinecode">1</span> and we assign <span class="inlinecode"><span class="id" type="var">Y</span></span> to <span class="inlinecode"><span class="id" type="var">X</span></span>, then we'll finish in a
    state where <span class="inlinecode"><span class="id" type="var">X</span></span> is <span class="inlinecode">1</span>.  That is, the property of being equal
    to <span class="inlinecode">1</span> gets transferred from <span class="inlinecode"><span class="id" type="var">Y</span></span> to <span class="inlinecode"><span class="id" type="var">X</span></span>.

<div class="paragraph"> </div>

    Similarly, in

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">Z</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    the same property (being equal to one) gets transferred to
    <span class="inlinecode"><span class="id" type="var">X</span></span> from the expression <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">Z</span></span> on the right-hand side of
    the assignment.

<div class="paragraph"> </div>

    More generally, if <span class="inlinecode"><span class="id" type="var">a</span></span> is <i>any</i> arithmetic expression, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">a</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    is a valid Hoare triple. 

<div class="paragraph"> </div>

    Even more generally, <span class="inlinecode"><span class="id" type="var">a</span></span> is <i>any</i> arithmetic expression and <span class="inlinecode"><span class="id" type="var">Q</span></span> is
    <i>any</i> property of numbers, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>(<span class="id" type="var">a</span>)&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;{{&nbsp;<span class="id" type="var">Q</span>(<span class="id" type="var">X</span>)&nbsp;}}
<div class="paragraph"> </div>

</div>
    is a valid Hoare triple.

<div class="paragraph"> </div>

    Rephrasing this a bit gives us the general Hoare rule for
    assignment:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;<span class="id" type="keyword">where</span>&nbsp;<span class="id" type="var">a</span>&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
    For example, these are valid applications of the assignment
    rule:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;3&nbsp;=&nbsp;3&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;3&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;3&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;3&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 We could try to formalize the assignment rule directly in Coq by
    treating <span class="inlinecode"><span class="id" type="var">Q</span></span> as a family of assertions indexed by arithmetic
    expressions &mdash; something like this:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Theorem</span>&nbsp;<span class="id" type="var">hoare_asgn_firsttry</span>&nbsp;:&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;(<span class="id" type="var">Q</span>&nbsp;:&nbsp;<span class="id" type="var">aexp</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<span class="id" type="var">Assertion</span>)&nbsp;<span class="id" type="var">V</span>&nbsp;<span class="id" type="var">a</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">Q</span>&nbsp;<span class="id" type="var">a</span>&nbsp;<span class="id" type="var">st</span>}}&nbsp;(<span class="id" type="var">V</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>)&nbsp;{{<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">Q</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">V</span>)&nbsp;<span class="id" type="var">st</span>}}.
<div class="paragraph"> </div>

</div>
    But this formulation is not very nice, for two reasons.
    First, it is not quite true! (As a counterexample, consider
    a <span class="inlinecode"><span class="id" type="var">Q</span></span> that inspects the <i>syntax</i> of its argument, such as 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span>&nbsp;<span class="id" type="var">Q</span>&nbsp;(<span class="id" type="var">a</span>:<span class="id" type="var">aexp</span>)&nbsp;:&nbsp;<span class="id" type="keyword">Prop</span>&nbsp;:=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span>&nbsp;<span class="id" type="var">a</span>&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">AID</span>&nbsp;(<span class="id" type="var">Id</span>&nbsp;0)&nbsp;=&gt;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">True</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.
<div class="paragraph"> </div>

</div>
    together with any <span class="inlinecode"><span class="id" type="var">V</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">Id</span></span> <span class="inlinecode">0</span> because a precondition that reduces
    to <span class="inlinecode"><span class="id" type="var">True</span></span> leads to a postcondition that is <span class="inlinecode"><span class="id" type="var">False</span></span>.)  And second,
    even if we could prove something similar to this, it would be
    awkward to use.  
<div class="paragraph"> </div>

 A much smoother way of formalizing the rule arises from the
    following observation:

<div class="paragraph"> </div>

<ul class="doclist">
<li> "<span class="inlinecode"><span class="id" type="var">Q</span></span> where a is substituted for <span class="inlinecode"><span class="id" type="var">X</span></span>" holds in a state <span class="inlinecode"><span class="id" type="var">st</span></span> iff
      <span class="inlinecode"><span class="id" type="var">Q</span></span> holds in the state <span class="inlinecode"><span class="id" type="var">update</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">(<span class="id" type="var">aeval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">a</span>)</span>. 
</li>
</ul>

<div class="paragraph"> </div>

 That is, asserting that a substituted variant of <span class="inlinecode"><span class="id" type="var">Q</span></span> holds in
    some state is the same as asserting that <span class="inlinecode"><span class="id" type="var">Q</span></span> itself holds in
    a substituted variant of the state.  
<div class="paragraph"> </div>

 Here is the definition of substitution in a state: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="assn_sub"><span class="id" type="definition">assn_sub</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> (<span class="id" type="var">st</span> : <a class="idref" href="ImpList.html#state"><span class="id" type="definition">state</span></a>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q</span> (<a class="idref" href="ImpList.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">V</span> (<a class="idref" href="ImpList.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a</span>)).<br/>

<br/>
</div>

<div class="doc">
This gives us the formal proof rule for assignment: 
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_asgn) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{assn_sub&nbsp;V&nbsp;a&nbsp;Q}}&nbsp;V::=a&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">Q</span> <span class="id" type="var">V</span> <span class="id" type="var">a</span>,<br/>
&nbsp;&nbsp;{{<a class="idref" href="Hoare.html#assn_sub"><span class="id" type="definition">assn_sub</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>}} (<span class="id" type="var">V</span> ::= <span class="id" type="var">a</span>) {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Q</span> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">HE</span> <span class="id" type="var">HQ</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HE</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Here's a first formal proof using this rule. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="assn_sub_example"><span class="id" type="definition">assn_sub_example</span></a> : <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; 3 = 3}} <br/>
&nbsp;&nbsp;(<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 3)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 3}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> ((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; 3 = 3) = <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Hoare.html#assn_sub"><span class="id" type="definition">assn_sub</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 3) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 3))).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Proof of assertion".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
This proof is a little clunky because the <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> rule
    doesn't literally apply to the initial goal: it only works with
    triples whose precondition has precisely the form <span class="inlinecode"><span class="id" type="var">assn_sub</span></span> <span class="inlinecode"><span class="id" type="var">Q</span></span> <span class="inlinecode"><span class="id" type="var">V</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span>
    for some <span class="inlinecode"><span class="id" type="var">Q</span></span>, <span class="inlinecode"><span class="id" type="var">V</span></span>, and <span class="inlinecode"><span class="id" type="var">a</span></span>.  So we have to start with asserting a
    little lemma to get the goal into this form. 

<div class="paragraph"> </div>

    Doing this kind of fiddling with the goal state every time we
    want to use <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> would get tiresome pretty quickly.
    Fortunately, there are easier alternatives.  One simple one is
    to state a slightly more general theorem that introduces an
    explicit equality hypothesis: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_asgn_eq"><span class="id" type="lemma">hoare_asgn_eq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> <span class="id" type="var">V</span> <span class="id" type="var">a</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q'</span> = <a class="idref" href="Hoare.html#assn_sub"><span class="id" type="definition">assn_sub</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">Q'</span>}} (<span class="id" type="var">V</span> ::= <span class="id" type="var">a</span>) {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
With this version of <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span>, we can do the proof much
    more smoothly. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="assn_sub_example'"><span class="id" type="definition">assn_sub_example'</span></a> : <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; 3 = 3}} <br/>
&nbsp;&nbsp;(<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 3)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 3}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn_eq"><span class="id" type="lemma">hoare_asgn_eq</span></a>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab404"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_examples)</h4>
 Translate these informal Hoare triples...

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;3&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;3&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
   ...into formal statements and use <span class="inlinecode"><span class="id" type="var">hoare_asgn_eq</span></span> to prove
   them. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab405"></a><h4 class="section">Exercise: 3 stars (hoarestate2)</h4>
 The assignment rule looks backward to almost everyone the first
    time they see it.  If it still seems backward to you, it may help
    to think a little about alternative "forward" rules.  Here is a
    seemingly natural one:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">a</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
    Explain what is wrong with this rule.

<div class="paragraph"> </div>

    <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
 <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab406"></a><h4 class="section">Exercise: 3 stars, optional (hoare_asgn_weakest)</h4>
 Show that the precondition in the rule <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> is in fact the
    weakest precondition. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_asgn_weakest"><span class="id" type="lemma">hoare_asgn_weakest</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} (<span class="id" type="var">V</span> ::= <span class="id" type="var">a</span>) {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#assn_sub"><span class="id" type="definition">assn_sub</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab407"></a><h3 class="section">Consequence</h3>

<div class="paragraph"> </div>

 The discussion above about the awkwardness of applying the
    assignment rule illustrates a more general point: sometimes the
    preconditions and postconditions we get from the Hoare rules won't
    quite be the ones we want &mdash; they may (as in the above example) be
    logically equivalent but have a different syntactic form that
    fails to unify with the goal we are trying to prove, or they
    actually may be logically weaker (for preconditions) or
    stronger (for postconditions) than what we need.

<div class="paragraph"> </div>

    For instance, while

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{3&nbsp;=&nbsp;3}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;3}},
<div class="paragraph"> </div>

</div>
    follows directly from the assignment rule, the more natural triple 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;3}}.
<div class="paragraph"> </div>

</div>
    does not.  This triple is also valid, but it is not an instance of
    <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> (or <span class="inlinecode"><span class="id" type="var">hoare_asgn_eq</span></span>) because <span class="inlinecode"><span class="id" type="var">True</span></span> and <span class="inlinecode">3</span> <span class="inlinecode">=</span> <span class="inlinecode">3</span> are
    not syntactically equal assertions.

<div class="paragraph"> </div>

    In general, if we can derive <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{{<span class="id" type="var">Q</span>}}</span>, it is valid to
    change <span class="inlinecode"><span class="id" type="var">P</span></span> to <span class="inlinecode"><span class="id" type="var">P'</span></span> as long as <span class="inlinecode"><span class="id" type="var">P'</span></span> is strong enough to imply <span class="inlinecode"><span class="id" type="var">P</span></span>,
    and change <span class="inlinecode"><span class="id" type="var">Q</span></span> to <span class="inlinecode"><span class="id" type="var">Q'</span></span> as long as <span class="inlinecode"><span class="id" type="var">Q</span></span> implies <span class="inlinecode"><span class="id" type="var">Q'</span></span>.

<div class="paragraph"> </div>

    This observation is captured by the following <i>Rule of
    Consequence</i>.
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P'}}&nbsp;c&nbsp;{{Q'}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">P&nbsp;implies&nbsp;P'&nbsp;(in&nbsp;every&nbsp;state)</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">Q'&nbsp;implies&nbsp;Q&nbsp;(in&nbsp;every&nbsp;state)</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>   For convenience, we can state two more consequence rules &mdash; one for
   situations where we want to just strengthen the precondition, and
   one for when we want to just weaken the postcondition.
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P'}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">P&nbsp;implies&nbsp;P'&nbsp;(in&nbsp;every&nbsp;state)</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence_pre) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q'}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">Q'&nbsp;implies&nbsp;Q&nbsp;(in&nbsp;every&nbsp;state)</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence_post) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center> 
<div class="paragraph"> </div>

 Here are the formal versions: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P'</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q'</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P'</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">Q'</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> <span class="id" type="var">c</span> <span class="id" type="var">Hht</span> <span class="id" type="var">HPP'</span> <span class="id" type="var">HQ'Q</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hc</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HQ'Q</span>. <span class="id" type="tactic">apply</span> (<span class="id" type="var">Hht</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>). <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HPP'</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P'</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P'</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> <span class="id" type="var">c</span> <span class="id" type="var">Hhoare</span> <span class="id" type="var">Himp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <span class="id" type="var">P'</span>) (<span class="id" type="var">Q'</span> := <span class="id" type="var">Q</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_consequence_post"><span class="id" type="lemma">hoare_consequence_post</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q'</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">Q'</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> <span class="id" type="var">c</span> <span class="id" type="var">Hhoare</span> <span class="id" type="var">Himp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <span class="id" type="var">P</span>) (<span class="id" type="var">Q'</span> := <span class="id" type="var">Q'</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
For example, we might use (the "<span class="inlinecode"><span class="id" type="var">_pre</span></span>" version of) the
    consequence rule like this:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;1&nbsp;=&nbsp;1&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    Or, formally... 

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="hoare_asgn_example1"><span class="id" type="definition">hoare_asgn_example1</span></a> :<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>}} (<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)) {{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 1}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; 1 = 1)).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn_eq"><span class="id" type="lemma">hoare_asgn_eq</span></a>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab408"></a><h3 class="section">Digression: The <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> Tactic</h3>

<div class="paragraph"> </div>

 This is a good moment to introduce another convenient feature
    of Coq.  Having to write <span class="inlinecode"><span class="id" type="var">P'</span></span> explicitly in the example above
    is a bit annoying because the very next thing we are going to
    do &mdash; applying the <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> rule &mdash; is going to determine
    exactly what it should be.  We can use <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> instead of
    <span class="inlinecode"><span class="id" type="tactic">apply</span></span> to tell Coq, essentially, "The missing part is going
    to be filled in later." 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="hoare_asgn_example1'"><span class="id" type="definition">hoare_asgn_example1'</span></a> :<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>}} <br/>
&nbsp;&nbsp;(<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 1}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn_eq"><span class="id" type="lemma">hoare_asgn_eq</span></a>. <span class="id" type="tactic">reflexivity</span>. <span class="comment">(*&nbsp;or&nbsp;just&nbsp;<span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">hoare_asgn</span>.</span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
In general, <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span> tactic works just like <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>
    except that, instead of failing if unifying the goal with the
    conclusion of <span class="inlinecode"><span class="id" type="var">H</span></span> does not determine how to instantiate all
    of the variables appearing in the premises of <span class="inlinecode"><span class="id" type="var">H</span></span>, <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>
    will replace these variables with <i>existential variables</i>
    (written <span class="inlinecode">?<span class="id" type="var">nnn</span></span>) as placeholders for expressions that will be
    determined (by further unification) later in the proof. 

<div class="paragraph"> </div>

    There is also an <span class="inlinecode"><span class="id" type="var">eassumption</span></span> tactic that works similarly. 
<div class="paragraph"> </div>

<a name="lab409"></a><h3 class="section">Skip</h3>

<div class="paragraph"> </div>

 Since <span class="inlinecode"><span class="id" type="var">SKIP</span></span> doesn't change the state, it preserves any
    property P:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_skip) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;SKIP&nbsp;{{&nbsp;P&nbsp;}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_skip"><span class="id" type="lemma">hoare_skip</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">SKIP</span> {{<span class="id" type="var">P</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H</span> <span class="id" type="var">HP</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab410"></a><h3 class="section">Sequencing</h3>

<div class="paragraph"> </div>

 More interestingly, if the command <span class="inlinecode"><span class="id" type="var">c1</span></span> takes any state where
    <span class="inlinecode"><span class="id" type="var">P</span></span> holds to a state where <span class="inlinecode"><span class="id" type="var">Q</span></span> holds, and if <span class="inlinecode"><span class="id" type="var">c2</span></span> takes any
    state where <span class="inlinecode"><span class="id" type="var">Q</span></span> holds to one where <span class="inlinecode"><span class="id" type="var">R</span></span> holds, then doing <span class="inlinecode"><span class="id" type="var">c1</span></span>
    followed by <span class="inlinecode"><span class="id" type="var">c2</span></span> will take any state where <span class="inlinecode"><span class="id" type="var">P</span></span> holds to one
    where <span class="inlinecode"><span class="id" type="var">R</span></span> holds:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;c1&nbsp;{{&nbsp;Q&nbsp;}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;Q&nbsp;}}&nbsp;c2&nbsp;{{&nbsp;R&nbsp;}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_seq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;c1;c2&nbsp;{{&nbsp;R&nbsp;}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_seq"><span class="id" type="lemma">hoare_seq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">R</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">Q</span>}} <span class="id" type="var">c2</span> {{<span class="id" type="var">R</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c1</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c1</span>;<span class="id" type="var">c2</span> {{<span class="id" type="var">R</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">R</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H12</span> <span class="id" type="var">Pre</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H12</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">st'0</span> <span class="id" type="var">st'</span>); <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'0</span>); <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Note that, in the formal rule <span class="inlinecode"><span class="id" type="var">hoare_seq</span></span>, the premises are
    given in "backwards" order (<span class="inlinecode"><span class="id" type="var">c2</span></span> before <span class="inlinecode"><span class="id" type="var">c1</span></span>).  This matches the
    natural flow of information in many of the situations where we'll
    use the rule. 
<div class="paragraph"> </div>

 Informally, a nice way of recording a proof using this rule
    is as a "decorated program" where the intermediate assertion
    <span class="inlinecode"><span class="id" type="var">Q</span></span> is written between <span class="inlinecode"><span class="id" type="var">c1</span></span> and <span class="inlinecode"><span class="id" type="var">c2</span></span>:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">a</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;----&nbsp;<span class="id" type="var">decoration</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="hoare_asgn_example3"><span class="id" type="definition">hoare_asgn_example3</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a</span> = <span class="id" type="var">n</span>}} <br/>
&nbsp;&nbsp;(<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <span class="id" type="var">a</span>; <span class="id" type="var">SKIP</span>) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> = <span class="id" type="var">n</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">n</span>. <span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "right part of seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_skip"><span class="id" type="lemma">hoare_skip</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "left part of seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab411"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_example4)</h4>
 Translate this decorated program into a formal proof:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;1&nbsp;=&nbsp;1&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;2&nbsp;=&nbsp;2&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;2&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="hoare_asgn_example4"><span class="id" type="definition">hoare_asgn_example4</span></a> :<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>}} (<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1); <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 2)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 1 <span style="font-family: arial;">&and;</span> <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) = 2}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab412"></a><h4 class="section">Exercise: 3 stars, optional (swap_exercise)</h4>
 Write an Imp program <span class="inlinecode"><span class="id" type="var">c</span></span> that swaps the values of <span class="inlinecode"><span class="id" type="var">X</span></span> and <span class="inlinecode"><span class="id" type="var">Y</span></span>
    and show (in Coq) that it satisfies the following
    specification:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">Y</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab413"></a><h4 class="section">Exercise: 3 stars, optional (hoarestate1)</h4>
 Explain why the following proposition can't be proven:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;(<span class="id" type="var">a</span>&nbsp;:&nbsp;<span class="id" type="var">aexp</span>)&nbsp;(<span class="id" type="var">n</span>&nbsp;:&nbsp;<span class="id" type="var">nat</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>}}&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;(<span class="id" type="var">ANum</span>&nbsp;3);&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">asnat</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Y</span>)&nbsp;=&nbsp;<span class="id" type="var">n</span>}}.
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab414"></a><h3 class="section">Conditionals</h3>

<div class="paragraph"> </div>

 What sort of rule do we want for reasoning about conditional
    commands?  Certainly, if the same assertion <span class="inlinecode"><span class="id" type="var">Q</span></span> holds after
    executing either branch, then it holds after the whole
    conditional.  So we might be tempted to write:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c1&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c2&nbsp;{{Q}}</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;IFB&nbsp;b&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>   However, this is rather weak. For example, using this rule,
   we cannot show that:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">X</span>&nbsp;==&nbsp;0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">Y</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
   since the rule tells us nothing about the state in which the
   assignments take place in the "then" and "else" branches.

<div class="paragraph"> </div>

   But, actually, we can say something more precise.  In the "then"
   branch, we know that the boolean expression <span class="inlinecode"><span class="id" type="var">b</span></span> evaluates to
   <span class="inlinecode"><span class="id" type="var">true</span></span>, and in the "else" branch, we know it evaluates to <span class="inlinecode"><span class="id" type="var">false</span></span>.
   Making this information available in the premises of the lemma
   gives us more information to work with when reasoning about the
   behavior of <span class="inlinecode"><span class="id" type="var">c1</span></span> and <span class="inlinecode"><span class="id" type="var">c2</span></span> (i.e., the reasons why they establish the
   postcondtion <span class="inlinecode"><span class="id" type="var">Q</span></span>).
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;&nbsp;b}}&nbsp;c1&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}&nbsp;c2&nbsp;{{Q}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_if) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;IFB&nbsp;b&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
<div class="paragraph"> </div>

 To interpret this rule formally, we need to do a little work.

<div class="paragraph"> </div>

    Strictly speaking, the assertion we've written, <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span style="font-family: arial;">&and;</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span>, is the
    conjunction of an assertion and a boolean expression, which
    doesn't typecheck.  To fix this, we need a way of formally
    "lifting" any bexp <span class="inlinecode"><span class="id" type="var">b</span></span> to an assertion.  We'll write <span class="inlinecode"><span class="id" type="var">bassn</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> for
    the assertion "the boolean expression <span class="inlinecode"><span class="id" type="var">b</span></span> evaluates to <span class="inlinecode"><span class="id" type="var">true</span></span> (in
    the given state)." 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; (<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span> = <span class="id" type="constructor">true</span>).<br/>

<br/>
</div>

<div class="doc">
A couple of useful facts about <span class="inlinecode"><span class="id" type="var">bassn</span></span>: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <a name="bexp_eval_true"><span class="id" type="lemma">bexp_eval_true</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&rarr;</span> (<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span>) <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span> <span class="id" type="var">Hbe</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="bexp_eval_false"><span class="id" type="lemma">bexp_eval_false</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span> ~ ((<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span>) <span class="id" type="var">st</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span> <span class="id" type="var">Hbe</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">contra</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hbe</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hbe</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Now we can formalize the Hoare proof rule for conditionals
    and prove it correct. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="hoare_if"><span class="id" type="lemma">hoare_if</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>}} <span class="id" type="var">c1</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~(<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)}} <span class="id" type="var">c2</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} (<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">HTrue</span> <span class="id" type="var">HFalse</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">HE</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HE</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "b is true".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">HTrue</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#bexp_eval_true"><span class="id" type="lemma">bexp_eval_true</span></a>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "b is false".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">HFalse</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#bexp_eval_false"><span class="id" type="lemma">bexp_eval_false</span></a>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Here is a formal proof that the program we used to motivate the
    rule satisfies the specification we gave. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="if_example"><span class="id" type="definition">if_example</span></a> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>}} <br/>
&nbsp;&nbsp;<span class="id" type="var">IFB</span> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span> (<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 2)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> (<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)) <br/>
&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) &lt;= <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>)}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_if"><span class="id" type="lemma">hoare_if</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Then".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">update</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="definition">beq_nat_eq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Else".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>, <span class="id" type="var">update</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab415"></a><h3 class="section">Loops</h3>

<div class="paragraph"> </div>

 Finally, we need a rule for reasoning about while loops.  Suppose
    we have a loop

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>
    and we want to find a pre-condition <span class="inlinecode"><span class="id" type="var">P</span></span> and a post-condition
    <span class="inlinecode"><span class="id" type="var">Q</span></span> such that

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">Q</span>}}&nbsp;
<div class="paragraph"> </div>

</div>
    is a valid triple.  

<div class="paragraph"> </div>

    First of all, let's think about the case where <span class="inlinecode"><span class="id" type="var">b</span></span> is false
    at the beginning, so that the loop body never executes at
    all.  In this case, the loop behaves like <span class="inlinecode"><span class="id" type="var">SKIP</span></span>, so we might
    be tempted to write

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">P</span>}}.
<div class="paragraph"> </div>

</div>
    But, as we remarked above for the conditional, we know a
    little more at the end &mdash; not just <span class="inlinecode"><span class="id" type="var">P</span></span>, but also the fact
    that <span class="inlinecode"><span class="id" type="var">b</span></span> is false in the current state.  So we can enrich the
    postcondition a little:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~<span class="id" type="var">b</span>}}
<div class="paragraph"> </div>

</div>
    What about the case where the loop body <i>does</i> get executed?
    In order to ensure that <span class="inlinecode"><span class="id" type="var">P</span></span> holds when the loop finally
    exits, we certainly need to make sure that the command <span class="inlinecode"><span class="id" type="var">c</span></span>
    guarantees that <span class="inlinecode"><span class="id" type="var">P</span></span> holds whenever <span class="inlinecode"><span class="id" type="var">c</span></span> is finished.
    Moreover, since <span class="inlinecode"><span class="id" type="var">P</span></span> holds at the beginning of the first
    execution of <span class="inlinecode"><span class="id" type="var">c</span></span>, and since each execution of <span class="inlinecode"><span class="id" type="var">c</span></span>
    re-establishes <span class="inlinecode"><span class="id" type="var">P</span></span> when it finishes, we can always assume
    that <span class="inlinecode"><span class="id" type="var">P</span></span> holds at the beginning of <span class="inlinecode"><span class="id" type="var">c</span></span>.  This leads us to the
    following rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{P}}</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;WHILE&nbsp;b&nbsp;DO&nbsp;c&nbsp;END&nbsp;{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}</td>
  <td></td>
</td>
</table></center>    The proposition <span class="inlinecode"><span class="id" type="var">P</span></span> is called an <i>invariant</i>.

<div class="paragraph"> </div>

    This is almost the rule we want, but again it can be improved
    a little: at the beginning of the loop body, we know not only
    that <span class="inlinecode"><span class="id" type="var">P</span></span> holds, but also that the guard <span class="inlinecode"><span class="id" type="var">b</span></span> is true in the
    current state.  This gives us a little more information to
    use in reasoning about <span class="inlinecode"><span class="id" type="var">c</span></span>.  Here is the final version of the
    rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;b}}&nbsp;c&nbsp;{{P}}</td>
  <td class="infrulenamecol" rowspan="3">
    [hoare_while] &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;WHILE&nbsp;b&nbsp;DO&nbsp;c&nbsp;END&nbsp;{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <a name="hoare_while"><span class="id" type="lemma">hoare_while</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">P</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span> {{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~ (<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">Hhoare</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">He</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Like&nbsp;we've&nbsp;seen&nbsp;before,&nbsp;we&nbsp;need&nbsp;to&nbsp;reason&nbsp;by&nbsp;induction&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;He,&nbsp;because,&nbsp;in&nbsp;the&nbsp;"keep&nbsp;looping"&nbsp;case,&nbsp;its&nbsp;hypotheses&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;talk&nbsp;about&nbsp;the&nbsp;whole&nbsp;loop&nbsp;instead&nbsp;of&nbsp;just&nbsp;c&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">wcom</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">ceval_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">He</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqwcom</span>); <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileEnd".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#bexp_eval_false"><span class="id" type="lemma">bexp_eval_false</span></a>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileLoop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hhoare</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>); <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#bexp_eval_true"><span class="id" type="lemma">bexp_eval_true</span></a>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <a name="while_example"><span class="id" type="definition">while_example</span></a> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) &lt;= 3}}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<a class="idref" href="ImpList.html#BLe"><span class="id" type="constructor">BLe</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 2))<br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) <span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 3}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_post"><span class="id" type="lemma">hoare_consequence_post</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>,  <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">H0</span>]. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ble_nat_true"><span class="id" type="axiom">ble_nat_true</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hle</span> <span class="id" type="var">Hb</span>]. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="SfLib.html#ble_nat"><span class="id" type="definition">ble_nat</span></a> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) 2) <span class="id" type="keyword">as</span> <span class="id" type="var">le</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">le</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hb</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqle</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ble_nat_false"><span class="id" type="axiom">ble_nat_false</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqle</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
We can also use the while rule to prove the following Hoare
    triple, which may seem surprising at first... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="always_loop_hoare"><span class="id" type="lemma">always_loop_hoare</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BTrue"><span class="id" type="constructor">BTrue</span></a> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <a class="idref" href="ImpList.html#state"><span class="id" type="definition">state</span></a> =&gt; <span class="id" type="inductive">True</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_post"><span class="id" type="lemma">hoare_consequence_post</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop body preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_post_true"><span class="id" type="lemma">hoare_post_true</span></a>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">apply</span> <span class="id" type="constructor">I</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop invariant and negated guard imply postcondition".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Hinv</span> <span class="id" type="var">Hguard</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hguard</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Precondition implies invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="var">constructor</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Actually, this result shouldn't be surprising.  If we look back at
    the definition of <span class="inlinecode"><span class="id" type="var">hoare_triple</span></span>, we can see that it asserts
    something meaningful <i>only</i> when the command terminates. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Print</span> <span class="id" type="var">hoare_triple</span>.<br/>

<br/>
</div>

<div class="doc">
If the command doesn't terminate, we can prove anything we like
    about the post-condition.  Here's a more direct proof of the same
    fact: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="always_loop_hoare'"><span class="id" type="lemma">always_loop_hoare'</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BTrue"><span class="id" type="constructor">BTrue</span></a> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="ImpList.html#loop_never_stops"><span class="id" type="lemma">loop_never_stops</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">contra</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Hoare rules that only talk about terminating commands are often
    said to describe a logic of "partial" correctness.  It is also
    possible to give Hoare rules for "total" correctness, which build
    in the fact that the commands terminate. 
<div class="paragraph"> </div>

<a name="lab416"></a><h3 class="section">Exercise: Hoare Rules for <span class="inlinecode"><span class="id" type="var">REPEAT</span></span></h3>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Module</span> <a name="RepeatExercise"><span class="id" type="module">RepeatExercise</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab417"></a><h4 class="section">Exercise: 4 stars (hoare_repeat)</h4>
 In this exercise, we'll add a new constructor to our language of
    commands: <span class="inlinecode"><span class="id" type="var">CRepeat</span></span>.  You will write the evaluation rule for
    <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> and add a new hoare logic theorem to the language for
    programs involving it.

<div class="paragraph"> </div>

    We recommend that you do this exercise before the ones that
    follow, as it should help solidify your understanding of the
    material. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="RepeatExercise.com"><span class="id" type="inductive">com</span></a> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="RepeatExercise.CSkip"><span class="id" type="constructor">CSkip</span></a> : <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.CAss"><span class="id" type="constructor">CAss</span></a> : <a class="idref" href="ImpList.html#id"><span class="id" type="inductive">id</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="ImpList.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.CSeq"><span class="id" type="constructor">CSeq</span></a> : <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.CIf"><span class="id" type="constructor">CIf</span></a> : <a class="idref" href="ImpList.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.CWhile"><span class="id" type="constructor">CWhile</span></a> : <a class="idref" href="ImpList.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.CRepeat"><span class="id" type="constructor">CRepeat</span></a> : <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="ImpList.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#com"><span class="id" type="inductive">com</span></a>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">REPEAT</span></span> behaves like <span class="inlinecode"><span class="id" type="var">WHILE</span></span>, except that the loop guard is
    checked <i>after</i> each execution of the body, with the loop
    repeating as long as the guard stays <i>false</i>.  Because of this,
    the body will always execute at least once. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "com_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "SKIP" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "::=" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> ";"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "IFB" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "WHILE" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "CRepeat" ].<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" := <br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#RepeatExercise.CSkip"><span class="id" type="constructor">CSkip</span></a>.<br/>
<span class="id" type="keyword">Notation</span> "c1 ; c2" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Hoare.html#RepeatExercise.CSeq"><span class="id" type="constructor">CSeq</span></a> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Hoare.html#RepeatExercise.CAss"><span class="id" type="constructor">CAss</span></a> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Hoare.html#RepeatExercise.CWhile"><span class="id" type="constructor">CWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Hoare.html#RepeatExercise.CIf"><span class="id" type="constructor">CIf</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'REPEAT' e1 'UNTIL' b2 'END'" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Hoare.html#RepeatExercise.CRepeat"><span class="id" type="constructor">CRepeat</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">b2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
</div>

<div class="doc">
Add new rules for <span class="inlinecode"><span class="id" type="var">REPEAT</span></span> to <span class="inlinecode"><span class="id" type="var">ceval</span></span> below.  You can use the rules
    for <span class="inlinecode"><span class="id" type="var">WHILE</span></span> as a guide, but remember that the body of a <span class="inlinecode"><span class="id" type="var">REPEAT</span></span>
    should always execute at least once, and that the loop ends when
    the guard becomes true.  Then update the <span class="inlinecode"><span class="id" type="var">ceval_cases</span></span> tactic to
    handle these added cases.  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="RepeatExercise.ceval"><span class="id" type="inductive">ceval</span></a> : <a class="idref" href="ImpList.html#state"><span class="id" type="definition">state</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#RepeatExercise.com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="ImpList.html#state"><span class="id" type="definition">state</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_Skip"><span class="id" type="constructor">E_Skip</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_Ass"><span class="id" type="constructor">E_Ass</span></a>  : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> <span class="id" type="var">n</span> <span class="id" type="var">V</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> (<span class="id" type="var">V</span> ::= <span class="id" type="var">a1</span>) (<a class="idref" href="ImpList.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_Seq"><span class="id" type="constructor">E_Seq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> (<span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>) <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_IfTrue"><span class="id" type="constructor">E_IfTrue</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_IfFalse"><span class="id" type="constructor">E_IfFalse</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c2</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_WhileEnd"><span class="id" type="constructor">E_WhileEnd</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">b1</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <a name="RepeatExercise.E_WhileLoop"><span class="id" type="constructor">E_WhileLoop</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st'</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="var">st''</span><br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "ceval_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Ass" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Seq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfFalse"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileEnd" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileLoop" <br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
].<br/>

<br/>
</div>

<div class="doc">
A couple of definitions from above, copied here so they use the
    new <span class="inlinecode"><span class="id" type="var">ceval</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<a class="idref" href="Hoare.html#RepeatExercise.ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>
<span class="id" type="keyword">Definition</span> <a name="RepeatExercise.hoare_triple"><span class="id" type="definition">hoare_triple</span></a> (<span class="id" type="var">P</span>:<a class="idref" href="Hoare.html#RepeatExercise.Assertion"><span class="id" type="definition">Assertion</span></a>) (<span class="id" type="var">c</span>:<a class="idref" href="Hoare.html#RepeatExercise.com"><span class="id" type="inductive">com</span></a>) (<span class="id" type="var">Q</span>:<a class="idref" href="Hoare.html#RepeatExercise.Assertion"><span class="id" type="definition">Assertion</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>, (<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>) <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c  {{ Q }}" := (<a class="idref" href="Hoare.html#RepeatExercise.hoare_triple"><span class="id" type="definition">hoare_triple</span></a> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">c</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>).<br/>

<br/>
</div>

<div class="doc">
Now state and prove a theorem, <span class="inlinecode"><span class="id" type="var">hoare_repeat</span></span>, that expresses an
     appropriate proof rule for <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> commands.  Use <span class="inlinecode"><span class="id" type="var">hoare_while</span></span>
     as a model. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">End</span> <a class="idref" href="Hoare.html#"><span class="id" type="module">RepeatExercise</span></a>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab418"></a><h2 class="section">Decorated Programs</h2>

<div class="paragraph"> </div>

 The whole point of Hoare Logic is that it is compositional &mdash; the
    structure of proofs exactly follows the structure of programs.
    This fact suggests that we we could record the essential ideas of
    a proof informally (leaving out some low-level calculational
    details) by decorating programs with appropriate assertions around
    each statement.  Such a <i>decorated program</i> carries with it
    an (informal) proof of its own correctness.

<div class="paragraph"> </div>

   For example, here is a complete decorated program:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">x</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">x</span>;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;=&gt;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">z</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Z</span>&nbsp;-&nbsp;1)&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0)&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;+&nbsp;1&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;+&nbsp;1&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;+&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;+&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Concretely, a decorated program consists of the program text
    interleaved with assertions.  To check that a decorated program
    represents a valid proof, we check that each individual command is
    <i>locally</i> consistent with its accompanying assertions in the
    following sense:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">SKIP</span></span> is locally consistent if its precondition and
      postcondition are the same

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;
<div class="paragraph"> </div>

</div>

</li>
<li> The sequential composition of commands <span class="inlinecode"><span class="id" type="var">c1</span></span> and <span class="inlinecode"><span class="id" type="var">c2</span></span> is locally
      consistent (with respect to assertions <span class="inlinecode"><span class="id" type="var">P</span></span> and <span class="inlinecode"><span class="id" type="var">R</span></span>) if <span class="inlinecode"><span class="id" type="var">c1</span></span>
      is (with respect to <span class="inlinecode"><span class="id" type="var">P</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>) and <span class="inlinecode"><span class="id" type="var">c2</span></span> is (with respect to
      <span class="inlinecode"><span class="id" type="var">Q</span></span> and <span class="inlinecode"><span class="id" type="var">R</span></span>):

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">R</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>


</li>
<li> An assignment is locally consistent if its precondition is
      the appropriate substitution of its postcondition:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span class="id" type="keyword">where</span>&nbsp;<span class="id" type="var">a</span>&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

</li>
<li> A conditional is locally consistent (with respect to assertions
      <span class="inlinecode"><span class="id" type="var">P</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>) if the assertions at the top of its "then" and
      "else" branches are exactly <span class="inlinecode"><span class="id" type="var">P</span><span style="font-family: arial;">&and;</span><span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">P</span>/\~<span class="id" type="var">b</span></span> and if its "then"
      branch is locally consistent (with respect to <span class="inlinecode"><span class="id" type="var">P</span><span style="font-family: arial;">&and;</span><span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>)
      and its "else" branch is locally consistent (with respect to
      <span class="inlinecode"><span class="id" type="var">P</span>/\~<span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>):

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">b</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~<span class="id" type="var">b</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>


</li>
<li> A while loop is locally consistent if its postcondition is
      <span class="inlinecode"><span class="id" type="var">P</span>/\~<span class="id" type="var">b</span></span> (where <span class="inlinecode"><span class="id" type="var">P</span></span> is its precondition) and if the pre- and
      postconditions of its body are exactly <span class="inlinecode"><span class="id" type="var">P</span><span style="font-family: arial;">&and;</span><span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">P</span></span>:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">b</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~<span class="id" type="var">b</span>&nbsp;}}&nbsp;
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>


</li>
<li> A pair of assertions separated by <span class="inlinecode">=&gt;</span> is locally consistent if
      the first implies the second (in all states):

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P'</span>&nbsp;}}&nbsp;
<div class="paragraph"> </div>

</div>

</li>
</ul>

<div class="paragraph"> </div>

<a name="lab419"></a><h1 class="section">Reasoning About Programs with Hoare Logic</h1>

<div class="paragraph"> </div>

<a name="lab420"></a><h2 class="section">Example: Slow Subtraction</h2>

<div class="paragraph"> </div>

 Informally:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Z</span>&nbsp;-&nbsp;1)&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0)&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Formally: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="subtract_slowly"><span class="id" type="definition">subtract_slowly</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="subtract_slowly_invariant"><span class="id" type="definition">subtract_slowly_invariant</span></a> <span class="id" type="var">x</span> <span class="id" type="var">z</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="definition">minus</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) = <span class="id" type="definition">minus</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="subtract_slowly_correct"><span class="id" type="lemma">subtract_slowly_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) = <span class="id" type="var">z</span>}} <br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#subtract_slowly"><span class="id" type="definition">subtract_slowly</span></a> <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) = <span class="id" type="definition">minus</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Note&nbsp;that&nbsp;we&nbsp;do&nbsp;NOT&nbsp;unfold&nbsp;the&nbsp;definition&nbsp;of&nbsp;hoare_triple<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anywhere&nbsp;in&nbsp;this&nbsp;proof!&nbsp;&nbsp;The&nbsp;goal&nbsp;is&nbsp;to&nbsp;use&nbsp;only&nbsp;the&nbsp;hoare<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rules.&nbsp;&nbsp;Your&nbsp;proofs&nbsp;should&nbsp;do&nbsp;the&nbsp;same.&nbsp;*)</span><br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;First&nbsp;we&nbsp;need&nbsp;to&nbsp;transform&nbsp;the&nbsp;pre&nbsp;and&nbsp;postconditions&nbsp;so<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;hoare_while&nbsp;will&nbsp;apply.&nbsp;&nbsp;In&nbsp;particular,&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;precondition&nbsp;should&nbsp;be&nbsp;the&nbsp;loop&nbsp;invariant.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <a class="idref" href="Hoare.html#subtract_slowly_invariant"><span class="id" type="definition">subtract_slowly_invariant</span></a> <span class="id" type="var">x</span> <span class="id" type="var">z</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop body preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Split&nbsp;up&nbsp;the&nbsp;two&nbsp;assignments&nbsp;with&nbsp;hoare_seq&nbsp;-&nbsp;using&nbsp;eapply&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lets&nbsp;us&nbsp;solve&nbsp;the&nbsp;second&nbsp;one&nbsp;immediately&nbsp;with&nbsp;hoare_asgn&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Now&nbsp;for&nbsp;the&nbsp;first&nbsp;assignment,&nbsp;transform&nbsp;the&nbsp;precondition<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;hoare_asgn&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finally,&nbsp;we&nbsp;need&nbsp;to&nbsp;justify&nbsp;the&nbsp;implication&nbsp;generated&nbsp;by<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hoare_consequence_pre&nbsp;(this&nbsp;bit&nbsp;of&nbsp;reasoning&nbsp;is&nbsp;elided&nbsp;in&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;informal&nbsp;proof)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly_invariant</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">update</span>, <span class="id" type="var">bassn</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Inv</span> <span class="id" type="var">GuardTrue</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;There&nbsp;are&nbsp;several&nbsp;ways&nbsp;to&nbsp;do&nbsp;the&nbsp;case&nbsp;analysis&nbsp;here...this&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;one&nbsp;is&nbsp;fairly&nbsp;general:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="definition">beq_nat</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) 0) <span class="id" type="keyword">as</span> <span class="id" type="var">Q</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">Q</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">GuardTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HeqQ</span>. <span class="id" type="tactic">apply</span> <span class="id" type="lemma">beq_nat_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HeqQ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>. <span class="comment">(*&nbsp;slow&nbsp;but&nbsp;effective!&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Initial state satisfies invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;is&nbsp;the&nbsp;subgoal&nbsp;generated&nbsp;by&nbsp;the&nbsp;precondition&nbsp;part&nbsp;of&nbsp;our<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first&nbsp;use&nbsp;of&nbsp;hoare_consequence.&nbsp;&nbsp;It's&nbsp;the&nbsp;first&nbsp;implication<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;written&nbsp;in&nbsp;the&nbsp;decorated&nbsp;program&nbsp;(though&nbsp;we&nbsp;elided&nbsp;the&nbsp;actual<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proof&nbsp;there).&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly_invariant</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">HX</span> <span class="id" type="var">HZ</span>]. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Invariant and negated guard imply postcondition".<br/>
&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;is&nbsp;the&nbsp;subgoal&nbsp;generated&nbsp;by&nbsp;the&nbsp;postcondition&nbsp;part&nbsp;of<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out&nbsp;first&nbsp;use&nbsp;of&nbsp;hoare_consequence.&nbsp;&nbsp;This&nbsp;implication&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;one&nbsp;written&nbsp;after&nbsp;the&nbsp;while&nbsp;loop&nbsp;in&nbsp;the&nbsp;informal&nbsp;proof.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Inv</span> <span class="id" type="var">GuardFalse</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly_invariant</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Inv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Here's&nbsp;a&nbsp;slightly&nbsp;different&nbsp;alternative&nbsp;for&nbsp;the&nbsp;case&nbsp;analysis&nbsp;that<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;works&nbsp;out&nbsp;well&nbsp;here&nbsp;(but&nbsp;is&nbsp;less&nbsp;general)...&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">GuardFalse</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab421"></a><h2 class="section">Exercise: Reduce to Zero</h2>

<div class="paragraph"> </div>

 Here is a while loop that is so simple it needs no invariant: 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>
   Your job is to translate this proof to Coq.  It may help to look
   at the <span class="inlinecode"><span class="id" type="var">slow_subtraction</span></span> proof for ideas.

<div class="paragraph"> </div>

<a name="lab422"></a><h4 class="section">Exercise: 2 stars (reduce_to_zero_correct)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Definition</span> <a name="reduce_to_zero"><span class="id" type="definition">reduce_to_zero</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="reduce_to_zero_correct"><span class="id" type="lemma">reduce_to_zero_correct</span></a> : <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>}}<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#reduce_to_zero"><span class="id" type="definition">reduce_to_zero</span></a><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 0}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab423"></a><h2 class="section">Exercise: Slow Addition</h2>

<div class="paragraph"> </div>

 The following program adds the variable X into the variable Z
    by repeatedly decrementing X and incrementing Z. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="add_slowly"><span class="id" type="definition">add_slowly</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab424"></a><h4 class="section">Exercise: 3 stars (add_slowly_decoration)</h4>
 Following the pattern of the <span class="inlinecode"><span class="id" type="var">subtract_slowly</span></span> example above, pick
    a precondition and postcondition that give an appropriate
    specification of <span class="inlinecode"><span class="id" type="var">add_slowly</span></span>; then (informally) decorate the
    program accordingly. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab425"></a><h4 class="section">Exercise: 3 stars (add_slowly_formal)</h4>
 Now write down your specification of <span class="inlinecode"><span class="id" type="var">add_slowly</span></span> formally, as a
    Coq <span class="inlinecode"><span class="id" type="var">Hoare_triple</span></span>, and prove it valid. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab426"></a><h2 class="section">Example: Parity</h2>

<div class="paragraph"> </div>

 Here's another, slightly trickier example.  Make sure you
    understand the decorated program completely.  Understanding
    all the details of the Coq proof is not required, though it
    is not actually very hard &mdash; all the required ideas are
    already in the informal version. 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;0&nbsp;=&nbsp;0&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;&gt;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(1-<span class="id" type="var">Y</span>)=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-(<span class="id" type="var">X</span>-1))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>-1&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1&nbsp;-&nbsp;<span class="id" type="var">Y</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-(<span class="id" type="var">X</span>-1))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>-1&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>)&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~(<span class="id" type="var">X</span>&lt;&gt;0)&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;<span class="id" type="var">x</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="find_parity"><span class="id" type="definition">find_parity</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0);<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0))) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="find_parity_invariant"><span class="id" type="definition">find_parity_invariant</span></a> <span class="id" type="var">x</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) &lt;= <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) = 0 <span style="font-family: arial;">&and;</span> <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="var">x</span> - <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span style="font-family: arial;">&or;</span> <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) = 1 <span style="font-family: arial;">&and;</span> ~<a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="var">x</span> - <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>))).<br/>

<br/>
<span class="comment">(*&nbsp;It&nbsp;turns&nbsp;out&nbsp;that&nbsp;we'll&nbsp;need&nbsp;the&nbsp;following&nbsp;lemma...&nbsp;*)</span><br/>
<span class="id" type="keyword">Lemma</span> <a name="not_ev_ev_S_gen"><span class="id" type="lemma">not_ev_ev_S_gen</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(~ <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="constructor">S</span> <span class="id" type="var">n</span>)) <span style="font-family: arial;">&and;</span><br/>
&nbsp;&nbsp;(~ <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="constructor">S</span> <span class="id" type="var">n</span>) <span style="font-family: arial;">&rarr;</span> <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="constructor">S</span> (<span class="id" type="constructor">S</span> <span class="id" type="var">n</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">n'</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_0"><span class="id" type="constructor">ev_0</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_SS"><span class="id" type="constructor">ev_SS</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_0"><span class="id" type="constructor">ev_0</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = S n'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">IHn'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hn</span> <span class="id" type="var">HSn</span>]. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HSn</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_SS"><span class="id" type="constructor">ev_SS</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hn</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_SS"><span class="id" type="constructor">ev_SS</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">contra</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="not_ev_ev_S"><span class="id" type="lemma">not_ev_ev_S</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;~ <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="constructor">S</span> <span class="id" type="var">n</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="Hoare.html#not_ev_ev_S_gen"><span class="id" type="lemma">not_ev_ev_S_gen</span></a> <span class="id" type="var">n</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="find_parity_correct"><span class="id" type="lemma">find_parity_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span>}} <br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#find_parity"><span class="id" type="definition">find_parity</span></a><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) = 0 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">find_parity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">Q</span> := <a class="idref" href="Hoare.html#find_parity_invariant"><span class="id" type="definition">find_parity_invariant</span></a> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <a class="idref" href="Hoare.html#find_parity_invariant"><span class="id" type="definition">find_parity_invariant</span></a> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop body preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[<span class="id" type="var">Inv1</span> <span class="id" type="var">Inv2</span>] <span class="id" type="var">GuardTrue</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">find_parity_invariant</span>, <span class="id" type="var">bassn</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardTrue</span>. <span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">GuardTrue</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Inv2</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="var">right</span>|<span class="id" type="var">left</span>]; (<span class="id" type="tactic">split</span>; <span class="id" type="tactic">simpl</span>; [<span class="id" type="tactic">omega</span> |]).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_not_ev_S"><span class="id" type="axiom">ev_not_ev_S</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="constructor">S</span> (<span class="id" type="var">x</span> - <span class="id" type="constructor">S</span> <span class="id" type="var">n</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">x</span>-<span class="id" type="var">n</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="lemma">minus_n_O</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#not_ev_ev_S"><span class="id" type="lemma">not_ev_ev_S</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="constructor">S</span> (<span class="id" type="var">x</span> - <span class="id" type="constructor">S</span> <span class="id" type="var">n</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">x</span> - <span class="id" type="var">n</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="lemma">minus_n_O</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Precondition implies invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Invariant implies postcondition".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>, <span class="id" type="var">find_parity_invariant</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[<span class="id" type="var">Inv1</span> <span class="id" type="var">Inv2</span>] <span class="id" type="var">GuardFalse</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Inv2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">H1</span>]. <span class="id" type="tactic">replace</span> (<span class="id" type="var">x</span>-0) <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H0'</span> <span class="id" type="var">_</span>]. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0'</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H0'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Inv2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">H1</span>]. <span class="id" type="tactic">replace</span> (<span class="id" type="var">x</span>-0) <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">GuardFalse</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "invariant established before loop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>, <span class="id" type="var">find_parity_invariant</span>, <span class="id" type="var">update</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) - <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">with</span> 0 <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ev_0"><span class="id" type="constructor">ev_0</span></a>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab427"></a><h4 class="section">Exercise: 3 stars (wrong_find_parity_invariant)</h4>
 A plausible first attempt at stating an invariant for <span class="inlinecode"><span class="id" type="var">find_parity</span></span>
    is the following. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="find_parity_invariant'"><span class="id" type="definition">find_parity_invariant'</span></a> <span class="id" type="var">x</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>)) = 0 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#ev"><span class="id" type="inductive">ev</span></a> (<span class="id" type="var">x</span> - <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)).<br/>

<br/>
</div>

<div class="doc">
Why doesn't this work?  (Hint: Don't waste time trying to answer
    this exercise by attempting a formal proof and seeing where it
    goes wrong.  Just think about whether the loop body actually
    preserves the property.) 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab428"></a><h2 class="section">Example: Finding Square Roots</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Definition</span> <a name="sqrt_loop"><span class="id" type="definition">sqrt_loop</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BLe"><span class="id" type="constructor">BLe</span></a> (<a class="idref" href="ImpList.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="sqrt_com"><span class="id" type="definition">sqrt_com</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0;<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#sqrt_loop"><span class="id" type="definition">sqrt_loop</span></a>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="sqrt_spec"><span class="id" type="definition">sqrt_spec</span></a> (<span class="id" type="var">x</span> : <span class="id" type="inductive">nat</span>) : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) * (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) &lt;= <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ~ (((<span class="id" type="constructor">S</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) * (<span class="id" type="constructor">S</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)))) &lt;= <span class="id" type="var">x</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="sqrt_inv"><span class="id" type="definition">sqrt_inv</span></a> (<span class="id" type="var">x</span> : <span class="id" type="inductive">nat</span>) : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ((<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) * (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) &lt;= <span class="id" type="var">x</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="random_fact_1"><span class="id" type="lemma">random_fact_1</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="constructor">S</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) * (<span class="id" type="constructor">S</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) &lt;= <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BLe"><span class="id" type="constructor">BLe</span></a> (<a class="idref" href="ImpList.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">Hle</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> [|<span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "asnat (st X) = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hle</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "asnat (st X) = S x'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hle</span>. <span class="id" type="tactic">apply</span> <span class="id" type="lemma">le_S_n</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hle</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="SfLib.html#ble_nat"><span class="id" type="definition">ble_nat</span></a> (<span class="id" type="definition">plus</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) * (<span class="id" type="constructor">S</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))))) <span class="id" type="var">x'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">as</span> <span class="id" type="var">ble</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ble</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqble</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ble_nat_false"><span class="id" type="axiom">ble_nat_false</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqble</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqble</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Heqble</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hle</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hle</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="random_fact_2"><span class="id" type="lemma">random_fact_2</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BLe"><span class="id" type="constructor">BLe</span></a> (<a class="idref" href="ImpList.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<a class="idref" href="ImpList.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> (<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<a class="idref" href="ImpList.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> (<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;= <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">Hble</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hble</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> [| <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "asnat (st X) = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hble</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "asnat (st X) = S x'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ble_nat_true"><span class="id" type="axiom">ble_nat_true</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">Hble</span>. <span class="id" type="tactic">omega</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="sqrt_com_correct"><span class="id" type="lemma">sqrt_com_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>}} (<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">x</span>; <a class="idref" href="Hoare.html#sqrt_com"><span class="id" type="definition">sqrt_com</span></a>) {{<a class="idref" href="Hoare.html#sqrt_spec"><span class="id" type="definition">sqrt_spec</span></a> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">Q</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "sqrt_com".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_com</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">Q</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) = 0).<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "sqrt_loop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_loop</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <a class="idref" href="Hoare.html#sqrt_inv"><span class="id" type="definition">sqrt_inv</span></a> <span class="id" type="var">x</span>).<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "loop preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_inv</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">HX</span> <span class="id" type="var">HZ</span>] <span class="id" type="var">HP</span>]. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSSCase</span> "X is preserved".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSSCase</span> "Z is updated correctly".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a> (<a class="idref" href="ImpList.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> (<a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>))) <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> <span class="id" type="var">st</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#random_fact_2"><span class="id" type="lemma">random_fact_2</span></a>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "invariant is true initially".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HX</span> <span class="id" type="var">HZ</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_inv</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">HZ</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">omega</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "after loop, spec is satisfied".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_spec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HX</span> <span class="id" type="var">HP</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_inv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HX</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">HX</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HX'</span> <span class="id" type="var">Harith</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">contra</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HP</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#random_fact_1"><span class="id" type="lemma">random_fact_1</span></a>. <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "Z set to 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">HX</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>; <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "assignment of X".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>; <span class="id" type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab429"></a><h4 class="section">Exercise: 3 stars, optional (sqrt_informal)</h4>
 Write a decorated program corresponding to the above
    correctness proof. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab430"></a><h2 class="section">Exercise: Factorial</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Module</span> <a name="Factorial"><span class="id" type="module">Factorial</span></a>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="Factorial.real_fact"><span class="id" type="definition">real_fact</span></a> (<span class="id" type="var">n</span>:<span class="id" type="inductive">nat</span>) : <span class="id" type="inductive">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">n</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">O</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="constructor">S</span> <span class="id" type="var">n'</span> =&gt; <span class="id" type="var">n</span> * (<a class="idref" href="Hoare.html#real_fact"><span class="id" type="definition">real_fact</span></a> <span class="id" type="var">n'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Recall the factorial Imp program: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="Factorial.fact_body"><span class="id" type="definition">fact_body</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="ImpList.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>);<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="Factorial.fact_loop"><span class="id" type="definition">fact_loop</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#Factorial.fact_body"><span class="id" type="definition">fact_body</span></a><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="Factorial.fact_com"><span class="id" type="definition">fact_com</span></a> : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>);<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1;<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#Factorial.fact_loop"><span class="id" type="definition">fact_loop</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab431"></a><h4 class="section">Exercise: 3 stars, optional (fact_informal)</h4>
 Decorate the <span class="inlinecode"><span class="id" type="var">fact_com</span></span> program to show that it satisfies the
    specification given by the pre and postconditions below.  Just as
    we have done above, you may elide the algebraic reasoning about
    arithmetic, the less-than relation, etc., that is (formally)
    required by the rule of consequence:

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">real_fact</span>&nbsp;<span class="id" type="var">x</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
 <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab432"></a><h4 class="section">Exercise: 4 stars, optional (fact_formal)</h4>
 Prove formally that fact_com satisfies this specification,
    using your informal proof as a guide.  You may want to state
    the loop invariant separately (as we did in the examples). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="Factorial.fact_com_correct"><span class="id" type="lemma">fact_com_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span>}} <a class="idref" href="Hoare.html#Factorial.fact_com"><span class="id" type="definition">fact_com</span></a><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) = <a class="idref" href="Hoare.html#Factorial.real_fact"><span class="id" type="definition">real_fact</span></a> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <a class="idref" href="Hoare.html#"><span class="id" type="module">Factorial</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab433"></a><h2 class="section">Reasoning About Programs with Lists</h2>

<div class="paragraph"> </div>

<a name="lab434"></a><h4 class="section">Exercise: 3 stars (list_sum)</h4>
 Here is a direct definition of the sum of the elements of a list,
    and an Imp program that computes the sum. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="sum"><span class="id" type="definition">sum</span></a> <span class="id" type="var">l</span> := <span class="id" type="definition">fold_right</span> <span class="id" type="definition">plus</span> 0 <span class="id" type="var">l</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="sum_program"><span class="id" type="definition">sum_program</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">DO</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="ImpList.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="ImpList.html#AHead"><span class="id" type="constructor">AHead</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#ATail"><span class="id" type="constructor">ATail</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
Provide an <i>informal</i> proof of the following specification of
    <span class="inlinecode"><span class="id" type="var">sum_program</span></span> in the form of a decorated version of the
    program. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="sum_program_spec"><span class="id" type="definition">sum_program_spec</span></a> := <span style="font-family: arial;">&forall;</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> }}<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#sum_program"><span class="id" type="definition">sum_program</span></a><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) = <a class="idref" href="Hoare.html#sum"><span class="id" type="definition">sum</span></a> <span class="id" type="var">l</span> }}.<br/>

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 Next, let's look at a <i>formal</i> Hoare Logic proof for a program
    that deals with lists.  We will verify the following program,
    which checks if the number <span class="inlinecode"><span class="id" type="var">Y</span></span> occurs in the list <span class="inlinecode"><span class="id" type="var">X</span></span>, and if so sets
    <span class="inlinecode"><span class="id" type="var">Z</span></span> to <span class="inlinecode">1</span>.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="list_member"><span class="id" type="definition">list_member</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="ImpList.html#AHead"><span class="id" type="constructor">AHead</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>))) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#ATail"><span class="id" type="constructor">ATail</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="list_member_spec"><span class="id" type="definition">list_member_spec</span></a> := <span style="font-family: arial;">&forall;</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> = <a class="idref" href="ImpList.html#VList"><span class="id" type="constructor">VList</span></a> <span class="id" type="var">l</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 0 }}<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#list_member"><span class="id" type="definition">list_member</span></a><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">l</span> }}.<br/>

<br/>
</div>

<div class="doc">
The proof we will use, written informally, looks as follows:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>)&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;(<span class="id" type="var">BIsCons</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;<br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">BIsCons</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;(<span class="id" type="var">Y</span>&nbsp;==&nbsp;<span class="id" type="var">head</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">BIsCons</span>&nbsp;<span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;==&nbsp;<span class="id" type="var">AHead</span>&nbsp;<span class="id" type="var">X</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">tail</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(1&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">tail</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">BIsCons</span>&nbsp;<span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(<span class="id" type="var">Y</span>&nbsp;==&nbsp;<span class="id" type="var">head</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">tail</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">tail</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">ATail</span>&nbsp;<span class="id" type="var">X</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>))&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(<span class="id" type="var">BIsCons</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;}}&nbsp;=&gt;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">l</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

  The only interesting part of the proof is the choice of loop invariant:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">p</span>,&nbsp;<span class="id" type="var">p</span>&nbsp;++&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">appears_in</span>&nbsp;<span class="id" type="var">n</span>&nbsp;<span class="id" type="var">p</span>)
<div class="paragraph"> </div>

</div>
  This states that at each iteration of the loop, the original list
  <span class="inlinecode"><span class="id" type="var">l</span></span> is equal to the append of the current value of <span class="inlinecode"><span class="id" type="var">X</span></span> and some
  other list <span class="inlinecode"><span class="id" type="var">p</span></span> which is not the value of any variable in the
  program, but keeps track of enough information from the original
  state to make the proof go through. (Such a <span class="inlinecode"><span class="id" type="var">p</span></span> is sometimes called
  a "ghost variable").

<div class="paragraph"> </div>

  In order to show that such a list <span class="inlinecode"><span class="id" type="var">p</span></span> exists, in each iteration we
  add the head of <span class="inlinecode"><span class="id" type="var">X</span></span> to the <i>end</i> of <span class="inlinecode"><span class="id" type="var">p</span></span>. This needs the function
  <span class="inlinecode"><span class="id" type="var">snoc</span></span>, from Poly.v. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="snoc"><span class="id" type="definition">snoc</span></a> {<span class="id" type="var">X</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">l</span>:<span class="id" type="inductive">list</span> <span class="id" type="var">X</span>) (<span class="id" type="var">v</span>:<span class="id" type="var">X</span>) : (<span class="id" type="inductive">list</span> <span class="id" type="var">X</span>) := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">nil</span>      =&gt;  [ <span class="id" type="var">v</span> ]<br/>
&nbsp;&nbsp;| <span class="id" type="constructor">cons</span> <span class="id" type="var">h</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">h</span> :: (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">t</span> <span class="id" type="var">v</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="snoc_equation"><span class="id" type="lemma">snoc_equation</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">h</span>:<span class="id" type="var">A</span>) (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="inductive">list</span> <span class="id" type="var">A</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">x</span> <span class="id" type="var">h</span> ++ <span class="id" type="var">y</span> = <span class="id" type="var">x</span> ++ <span class="id" type="var">h</span> :: <span class="id" type="var">y</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">A</span> <span class="id" type="var">h</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "x = []". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "x = cons". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHx</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
The main proof uses various lemmas. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <a name="appears_in_snoc1"><span class="id" type="lemma">appears_in_snoc1</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">a</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">l</span> <span class="id" type="var">a</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "l = []". <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ai_here"><span class="id" type="constructor">ai_here</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "l = cons". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ai_later"><span class="id" type="constructor">ai_later</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="appears_in_snoc2"><span class="id" type="lemma">appears_in_snoc2</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">a</span> <span class="id" type="var">l</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">a</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">l</span> <span class="id" type="var">b</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "l = []". <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ai_here"><span class="id" type="constructor">ai_here</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "l = cons". <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ai_later"><span class="id" type="constructor">ai_later</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="appears_in_snoc3"><span class="id" type="lemma">appears_in_snoc3</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">a</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">l</span> <span class="id" type="var">b</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;(<a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">a</span> <span class="id" type="var">l</span> <span style="font-family: arial;">&or;</span> <span class="id" type="var">a</span> = <span class="id" type="var">b</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "l = []". <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ai_here". <span class="id" type="var">right</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ai_later". <span class="id" type="var">left</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "l = cons". <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ai_here". <span class="id" type="var">left</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ai_here"><span class="id" type="constructor">ai_here</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ai_later". <span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">H1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ai_later"><span class="id" type="constructor">ai_later</span></a>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="append_singleton_equation"><span class="id" type="lemma">append_singleton_equation</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">x</span> : <span class="id" type="inductive">nat</span>) <span class="id" type="var">l</span> <span class="id" type="var">l'</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">l</span> ++ [<span class="id" type="var">x</span>]) ++ <span class="id" type="var">l'</span> = <span class="id" type="var">l</span> ++ <span class="id" type="var">x</span> :: <span class="id" type="var">l'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="append_nil"><span class="id" type="lemma">append_nil</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">l</span> : <span class="id" type="inductive">list</span> <span class="id" type="var">A</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">l</span> ++ [] = <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="beq_true__eq"><span class="id" type="lemma">beq_true__eq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span> <span class="id" type="var">n'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="definition">beq_nat</span> <span class="id" type="var">n</span> <span class="id" type="var">n'</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">n</span> = <span class="id" type="var">n'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">n'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = 0, n' = 0". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = 0, n' = S _". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = S, n' = 0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = S, n' = S". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHn</span> <span class="id" type="var">n'</span> <span class="id" type="var">H</span>). <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="beq_nat_refl"><span class="id" type="lemma">beq_nat_refl</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;<span class="id" type="definition">beq_nat</span> <span class="id" type="var">n</span> <span class="id" type="var">n</span> = <span class="id" type="constructor">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="list_member_correct"><span class="id" type="lemma">list_member_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> = <a class="idref" href="ImpList.html#VList"><span class="id" type="constructor">VList</span></a> <span class="id" type="var">l</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 0 }}<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#list_member"><span class="id" type="definition">list_member</span></a><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">l</span> }}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;loop&nbsp;body&nbsp;preserves&nbsp;the&nbsp;invariant:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_if"><span class="id" type="lemma">hoare_if</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "If taken".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[[<span class="id" type="var">H1</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]] <span class="id" type="var">H9</span>] <span class="id" type="var">H10</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;(st&nbsp;Y)&nbsp;is&nbsp;still&nbsp;n&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;and&nbsp;the&nbsp;interesting&nbsp;part&nbsp;of&nbsp;the&nbsp;invariant&nbsp;is&nbsp;preserved:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;X&nbsp;has&nbsp;to&nbsp;be&nbsp;a&nbsp;cons&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqx</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H9</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">p</span> <span class="id" type="var">h</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span>. <span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#snoc_equation"><span class="id" type="lemma">snoc_equation</span></a>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqx</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<a class="idref" href="Hoare.html#beq_true__eq"><span class="id" type="lemma">beq_true__eq</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H10</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#appears_in_snoc1"><span class="id" type="lemma">appears_in_snoc1</span></a>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "If not taken".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_skip"><span class="id" type="lemma">hoare_skip</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[[<span class="id" type="var">H1</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]] <span class="id" type="var">H9</span>] <span class="id" type="var">H10</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;(st&nbsp;Y)&nbsp;is&nbsp;still&nbsp;n&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;and&nbsp;the&nbsp;interesting&nbsp;part&nbsp;of&nbsp;the&nbsp;invariant&nbsp;is&nbsp;preserved:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;X&nbsp;has&nbsp;to&nbsp;be&nbsp;a&nbsp;cons&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqx</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H9</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H9</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">p</span> <span class="id" type="var">h</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_eq"><span class="id" type="lemma">update_eq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#snoc_equation"><span class="id" type="lemma">snoc_equation</span></a>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#appears_in_snoc2"><span class="id" type="lemma">appears_in_snoc2</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H3</span>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">destruct</span> (<a class="idref" href="Hoare.html#appears_in_snoc3"><span class="id" type="lemma">appears_in_snoc3</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "later".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">H3'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H3'</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "here (absurd)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqx</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#beq_nat_refl"><span class="id" type="lemma">beq_nat_refl</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H10</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;invariant&nbsp;holds&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;loop:&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H3</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> []. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;loop&nbsp;the&nbsp;invariant&nbsp;implies&nbsp;the&nbsp;right&nbsp;thing.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[<span class="id" type="var">H1</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]] <span class="id" type="var">H5</span>].<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;x&nbsp;must&nbsp;be&nbsp;<span class="inlinecode"></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#append_nil"><span class="id" type="lemma">append_nil</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab435"></a><h4 class="section">Exercise: 4 stars, optional (list_reverse)</h4>
 Recall the function <span class="inlinecode"><span class="id" type="var">rev</span></span> from Poly.v, for reversing lists. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="rev"><span class="id" type="definition">rev</span></a> {<span class="id" type="var">X</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">l</span>:<span class="id" type="inductive">list</span> <span class="id" type="var">X</span>) : <span class="id" type="inductive">list</span> <span class="id" type="var">X</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">nil</span>      =&gt; []<br/>
&nbsp;&nbsp;| <span class="id" type="constructor">cons</span> <span class="id" type="var">h</span> <span class="id" type="var">t</span> =&gt; <a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> (<a class="idref" href="Hoare.html#rev"><span class="id" type="definition">rev</span></a> <span class="id" type="var">t</span>) <span class="id" type="var">h</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Write an Imp program <span class="inlinecode"><span class="id" type="var">list_reverse_program</span></span> that reverses
    lists. Formally prove that it satisfies the following
    specification:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;<span class="id" type="var">l</span>&nbsp;:&nbsp;<span class="id" type="var">list</span>&nbsp;<span class="id" type="var">nat</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;&nbsp;<span class="id" type="var">l</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">nil</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list_reverse_program</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">rev</span>&nbsp;<span class="id" type="var">l</span>&nbsp;}}.
<div class="paragraph"> </div>

</div>
    You may find the lemmas <span class="inlinecode"><span class="id" type="var">append_nil</span></span> and <span class="inlinecode"><span class="id" type="var">rev_equation</span></span> useful.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <a name="rev_equation"><span class="id" type="lemma">rev_equation</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">h</span> : <span class="id" type="var">A</span>) (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="inductive">list</span> <span class="id" type="var">A</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#rev"><span class="id" type="definition">rev</span></a> (<span class="id" type="var">h</span> :: <span class="id" type="var">x</span>) ++ <span class="id" type="var">y</span> = <a class="idref" href="Hoare.html#rev"><span class="id" type="definition">rev</span></a> <span class="id" type="var">x</span> ++ <span class="id" type="var">h</span> :: <span class="id" type="var">y</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#snoc_equation"><span class="id" type="lemma">snoc_equation</span></a>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab436"></a><h1 class="section">Formalizing Decorated Programs</h1>

<div class="paragraph"> </div>

 The informal conventions for decorated programs amount to a way of
    displaying Hoare triples in which commands are annotated with
    enough embedded assertions that checking the validity of the
    triple is reduced to simple algebraic calculations showing that
    some assertions were stronger than others.

<div class="paragraph"> </div>

    In this section, we show that this informal presentation style can
    actually be made completely formal.  
<div class="paragraph"> </div>

<a name="lab437"></a><h2 class="section">Syntax</h2>

<div class="paragraph"> </div>

 The first thing we need to do is to formalize a variant of the
    syntax of commands that includes embedded assertions.  We call the
    new commands <i>decorated commands</i>, or <span class="inlinecode"><span class="id" type="var">dcom</span></span>s. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="dcom"><span class="id" type="inductive">dcom</span></a> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="DCSkip"><span class="id" type="constructor">DCSkip</span></a> :  <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a><br/>
&nbsp;&nbsp;| <a name="DCSeq"><span class="id" type="constructor">DCSeq</span></a> : <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a><br/>
&nbsp;&nbsp;| <a name="DCAsgn"><span class="id" type="constructor">DCAsgn</span></a> : <a class="idref" href="ImpList.html#id"><span class="id" type="inductive">id</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="ImpList.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span>  <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a><br/>
&nbsp;&nbsp;| <a name="DCIf"><span class="id" type="constructor">DCIf</span></a> : <a class="idref" href="ImpList.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span>  <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span>  <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a><br/>
&nbsp;&nbsp;| <a name="DCWhile"><span class="id" type="constructor">DCWhile</span></a> : <a class="idref" href="ImpList.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a><br/>
&nbsp;&nbsp;| <a name="DCPre"><span class="id" type="constructor">DCPre</span></a> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a><br/>
&nbsp;&nbsp;| <a name="DCPost"><span class="id" type="constructor">DCPost</span></a> : <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "dcom_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Seq" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Asgn"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "If" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "While"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Pre" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Post" ].<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP' {{ P }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCSkip"><span class="id" type="constructor">DCSkip</span></a> <span class="id" type="var">P</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 10) : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "l '::=' a {{ P }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCAsgn"><span class="id" type="constructor">DCAsgn</span></a> <span class="id" type="var">l</span> <span class="id" type="var">a</span> <span class="id" type="var">P</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60, <span class="id" type="var">a</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>) : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' {{ Pbody }} d 'END' {{ Ppost }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCWhile"><span class="id" type="constructor">DCWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">d</span> <span class="id" type="var">Ppost</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>) : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "'IFB' b 'THEN' {{ P }} d 'ELSE' {{ P' }} d' 'FI'" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCIf"><span class="id" type="constructor">DCIf</span></a> <span class="id" type="var">b</span> <span class="id" type="var">P</span> <span class="id" type="var">d</span> <span class="id" type="var">P'</span> <span class="id" type="var">d'</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "'=&gt;' {{ P }} d" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCPre"><span class="id" type="constructor">DCPre</span></a> <span class="id" type="var">P</span> <span class="id" type="var">d</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "{{ P }} d" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCPre"><span class="id" type="constructor">DCPre</span></a> <span class="id" type="var">P</span> <span class="id" type="var">d</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "d '=&gt;' {{ P }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCPost"><span class="id" type="constructor">DCPost</span></a> <span class="id" type="var">d</span> <span class="id" type="var">P</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 91, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> " d ; d' " <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<a class="idref" href="Hoare.html#DCSeq"><span class="id" type="constructor">DCSeq</span></a> <span class="id" type="var">d</span> <span class="id" type="var">d'</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>

<br/>
<span class="id" type="keyword">Delimit</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">dcom_scope</span> <span class="id" type="keyword">with</span> <span class="id" type="var">dcom</span>.<br/>

<br/>
</div>

<div class="doc">
To avoid clashing with the existing <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> definitions
    for ordinary <span class="inlinecode"><span class="id" type="var">com</span></span>mands, we introduce these notations in a special
    scope called <span class="inlinecode"><span class="id" type="var">dcom_scope</span></span>, and we wrap examples with the
    declaration <span class="inlinecode">%</span> <span class="inlinecode"><span class="id" type="var">dcom</span></span> to signal that we want the notations to be
    interpreted in this scope.  

<div class="paragraph"> </div>

    Careful readers will note that we've defined two notations for the
    <span class="inlinecode"><span class="id" type="var">DCPre</span></span> constructor, one with and one without a <span class="inlinecode">=&gt;</span>.  The
    "without" version is intended to be used to supply the initial
    precondition at the very top of the program. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="dec_while"><span class="id" type="definition">dec_while</span></a> : <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> := (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0))) <br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; ~(<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 0) }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="inductive">True</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = 0 }}<br/>
) % <span class="id" type="var">dcom</span>.<br/>

<br/>
</div>

<div class="doc">
It is easy to go from a <span class="inlinecode"><span class="id" type="var">dcom</span></span> to a <span class="inlinecode"><span class="id" type="var">com</span></span> by erasing all
    annotations. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="extract"><span class="id" type="definition">extract</span></a> (<span class="id" type="var">d</span>:<a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a>) : <a class="idref" href="ImpList.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSkip"><span class="id" type="constructor">DCSkip</span></a> <span class="id" type="var">_</span>          =&gt; <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSeq"><span class="id" type="constructor">DCSeq</span></a> <span class="id" type="var">d1</span> <span class="id" type="var">d2</span>       =&gt; (<a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d1</span> ; <a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d2</span>) <br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCAsgn"><span class="id" type="constructor">DCAsgn</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">_</span>      =&gt; <span class="id" type="var">V</span> ::= <span class="id" type="var">a</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCIf"><span class="id" type="constructor">DCIf</span></a> <span class="id" type="var">b</span> <span class="id" type="var">_</span> <span class="id" type="var">d1</span> <span class="id" type="var">_</span> <span class="id" type="var">d2</span>  =&gt; <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d1</span> <span class="id" type="var">ELSE</span> <a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d2</span> <span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCWhile"><span class="id" type="constructor">DCWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">_</span> <span class="id" type="var">d</span> <span class="id" type="var">_</span>   =&gt; <span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d</span> <span class="id" type="var">END</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPre"><span class="id" type="constructor">DCPre</span></a> <span class="id" type="var">_</span> <span class="id" type="var">d</span>         =&gt; <a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPost"><span class="id" type="constructor">DCPost</span></a> <span class="id" type="var">d</span> <span class="id" type="var">_</span>        =&gt; <a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
The choice of exactly where to put assertions in the definition of
    <span class="inlinecode"><span class="id" type="var">dcom</span></span> is a bit subtle.  The simplest thing to do would be to
    annotate every <span class="inlinecode"><span class="id" type="var">dcom</span></span> with a precondition and postcondition.  But
    this would result in very verbose programs with a lot of repeated
    annotations: for example, a program like <span class="inlinecode"><span class="id" type="var">SKIP</span>;<span class="id" type="var">SKIP</span></span> would have to
    be annotated as

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;({{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">P</span>}})&nbsp;;&nbsp;({{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">P</span>}})&nbsp;{{<span class="id" type="var">P</span>}},
<div class="paragraph"> </div>

</div>
    with pre- and post-conditions on each <span class="inlinecode"><span class="id" type="var">SKIP</span></span>, plus identical pre-
    and post-conditions on the semicolon!  

<div class="paragraph"> </div>

    Instead, the rule we've followed is this:

<div class="paragraph"> </div>

<ul class="doclist">
<li> The <i>post</i>-condition expected by each <span class="inlinecode"><span class="id" type="var">dcom</span></span> <span class="inlinecode"><span class="id" type="var">d</span></span> is embedded in <span class="inlinecode"><span class="id" type="var">d</span></span>

<div class="paragraph"> </div>


</li>
<li> The <i>pre</i>-condition is supplied by the context. 
</li>
</ul>

<div class="paragraph"> </div>

 In other words, the invariant of the representation is that a
    <span class="inlinecode"><span class="id" type="var">dcom</span></span> <span class="inlinecode"><span class="id" type="var">d</span></span> together with a precondition <span class="inlinecode"><span class="id" type="var">P</span></span> determines a Hoare
    triple <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode">(<span class="id" type="var">extract</span></span> <span class="inlinecode"><span class="id" type="var">d</span>)</span> <span class="inlinecode">{{<span class="id" type="var">post</span></span> <span class="inlinecode"><span class="id" type="var">d</span>}}</span>, where <span class="inlinecode"><span class="id" type="var">post</span></span> is defined as
    follows: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="post"><span class="id" type="definition">post</span></a> (<span class="id" type="var">d</span>:<a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a>) : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSkip"><span class="id" type="constructor">DCSkip</span></a> <span class="id" type="var">P</span>                =&gt; <span class="id" type="var">P</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSeq"><span class="id" type="constructor">DCSeq</span></a> <span class="id" type="var">d1</span> <span class="id" type="var">d2</span>             =&gt; <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d2</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCAsgn"><span class="id" type="constructor">DCAsgn</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>            =&gt; <span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCIf"><span class="id" type="constructor">DCIf</span></a>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">d1</span> <span class="id" type="var">_</span> <span class="id" type="var">d2</span>       =&gt; <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d1</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCWhile"><span class="id" type="constructor">DCWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">c</span> <span class="id" type="var">Ppost</span> =&gt; <span class="id" type="var">Ppost</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPre"><span class="id" type="constructor">DCPre</span></a> <span class="id" type="var">_</span> <span class="id" type="var">d</span>               =&gt; <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPost"><span class="id" type="constructor">DCPost</span></a> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>              =&gt; <span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
We can define a similar function that extracts the "initial
    precondition" from a decorated program. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="pre"><span class="id" type="definition">pre</span></a> (<span class="id" type="var">d</span>:<a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a>) : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSkip"><span class="id" type="constructor">DCSkip</span></a> <span class="id" type="var">P</span>                =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSeq"><span class="id" type="constructor">DCSeq</span></a> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>             =&gt; <a class="idref" href="Hoare.html#pre"><span class="id" type="definition">pre</span></a> <span class="id" type="var">c1</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCAsgn"><span class="id" type="constructor">DCAsgn</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>            =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCIf"><span class="id" type="constructor">DCIf</span></a>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span> <span class="id" type="var">_</span> <span class="id" type="var">e</span>         =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCWhile"><span class="id" type="constructor">DCWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">c</span> <span class="id" type="var">Ppost</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPre"><span class="id" type="constructor">DCPre</span></a> <span class="id" type="var">P</span> <span class="id" type="var">c</span>               =&gt; <span class="id" type="var">P</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPost"><span class="id" type="constructor">DCPost</span></a> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>              =&gt; <a class="idref" href="Hoare.html#pre"><span class="id" type="definition">pre</span></a> <span class="id" type="var">c</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
This function is not doing anything sophisticated like calculating
    a weakest precondition; it just recursively searches for an
    explicit annotation at the very beginning of the program,
    returning default answers for programs that lack an explicit
    precondition (like a bare assignment or <span class="inlinecode"><span class="id" type="var">SKIP</span></span>).  

<div class="paragraph"> </div>

    Using <span class="inlinecode"><span class="id" type="var">pre</span></span> and <span class="inlinecode"><span class="id" type="var">post</span></span>, and assuming that we adopt the convention
    of always supplying an explicit precondition annotation at the
    very beginning of our decorated programs, we can express what it
    means for a decorated program to be correct as follows: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="dec_correct"><span class="id" type="definition">dec_correct</span></a> (<span class="id" type="var">d</span>:<a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a>) := <br/>
&nbsp;&nbsp;{{<a class="idref" href="Hoare.html#pre"><span class="id" type="definition">pre</span></a> <span class="id" type="var">d</span>}} (<a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d</span>) {{<a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span>}}.<br/>

<br/>
</div>

<div class="doc">
To check whether this Hoare triple is <i>valid</i>, we need a way to
    extract the "proof obligations" from a decorated program.  These
    obligations are often called <i>verification conditions</i>, because
    they are the facts that must be verified (by some process looking
    at the decorated program) to see that the decorations are
    logically consistent and thus add up to a proof of correctness. 
<div class="paragraph"> </div>

<a name="lab438"></a><h2 class="section">Extracting Verification Conditions</h2>

<div class="paragraph"> </div>

 First, a bit of notation: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="assert_implies"><span class="id" type="definition">assert_implies</span></a> (<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span>.<br/>

<br/>
</div>

<div class="doc">
We will write <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8658;</span></span> <span class="inlinecode"><span class="id" type="var">Q</span></span> (in ASCII, <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode">~</span><span class="inlinecode">~&gt;</span> <span class="inlinecode"><span class="id" type="var">Q</span></span>) for <span class="inlinecode"><span class="id" type="var">assert_implies</span></span>
    <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span class="id" type="var">Q</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "P <span style="font-family: arial;">&#8658;</span> Q" := (<a class="idref" href="Hoare.html#assert_implies"><span class="id" type="definition">assert_implies</span></a> <span class="id" type="var">P</span> <span class="id" type="var">Q</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80).<br/>
<span class="id" type="keyword">Notation</span> "P <span style="font-family: arial;">&#8660;</span> Q" := (<span class="id" type="var">P</span> <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">P</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80).<br/>

<br/>
</div>

<div class="doc">
Next, the key definition.  The function <span class="inlinecode"><span class="id" type="var">verification_conditions</span></span>
    takes a <span class="inlinecode"><span class="id" type="var">dcom</span></span> <span class="inlinecode"><span class="id" type="var">d</span></span> together with a precondition <span class="inlinecode"><span class="id" type="var">P</span></span> and returns a
    <i>proposition</i> that, if it can be proved, implies that the triple
    <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode">(<span class="id" type="var">extract</span></span> <span class="inlinecode"><span class="id" type="var">d</span>)</span> <span class="inlinecode">{{<span class="id" type="var">post</span></span> <span class="inlinecode"><span class="id" type="var">d</span>}}</span> is valid.  It does this by walking
    over <span class="inlinecode"><span class="id" type="var">d</span></span> and generating a big conjunction including all the "local
    checks" that we listed when we described the informal rules for
    decorated programs.  (Strictly speaking, we need to massage the
    informal rules a little bit to add some uses of the rule of
    consequence, but the correspondence should be clear.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="verification_conditions"><span class="id" type="definition">verification_conditions</span></a> (<span class="id" type="var">P</span> : <a class="idref" href="Hoare.html#Assertion"><span class="id" type="definition">Assertion</span></a>) (<span class="id" type="var">d</span>:<a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSkip"><span class="id" type="constructor">DCSkip</span></a> <span class="id" type="var">Q</span>          =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">Q</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCSeq"><span class="id" type="constructor">DCSeq</span></a> <span class="id" type="var">d1</span> <span class="id" type="var">d2</span>      =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> <span class="id" type="var">P</span> <span class="id" type="var">d1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> (<a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d1</span>) <span class="id" type="var">d2</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCAsgn"><span class="id" type="constructor">DCAsgn</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>      =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8658;</span> <a class="idref" href="Hoare.html#assn_sub"><span class="id" type="definition">assn_sub</span></a> <span class="id" type="var">V</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCIf"><span class="id" type="constructor">DCIf</span></a> <span class="id" type="var">b</span> <span class="id" type="var">P1</span> <span class="id" type="var">t</span> <span class="id" type="var">P2</span> <span class="id" type="var">e</span>  =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">P1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~ (<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)) <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">P2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">t</span> = <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> <span class="id" type="var">P1</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> <span class="id" type="var">P2</span> <span class="id" type="var">e</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCWhile"><span class="id" type="constructor">DCWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">d</span> <span class="id" type="var">Ppost</span>      =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;post&nbsp;d&nbsp;is&nbsp;the&nbsp;loop&nbsp;invariant&nbsp;and&nbsp;the&nbsp;initial&nbsp;precondition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8658;</span> <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span>)  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&#8660;</span> <span class="id" type="var">Pbody</span>)  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~(<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)) <span style="font-family: arial;">&#8660;</span> <span class="id" type="var">Ppost</span>)  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> <span class="id" type="var">b</span> <span class="id" type="var">st</span>) <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPre"><span class="id" type="constructor">DCPre</span></a> <span class="id" type="var">P'</span> <span class="id" type="var">d</span>         =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">P'</span>) <span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> <span class="id" type="var">P'</span> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Hoare.html#DCPost"><span class="id" type="constructor">DCPost</span></a> <span class="id" type="var">d</span> <span class="id" type="var">Q</span>        =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> <span class="id" type="var">P</span> <span class="id" type="var">d</span> <span style="font-family: arial;">&and;</span> (<a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span> <span style="font-family: arial;">&#8658;</span> <span class="id" type="var">Q</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
And now, the key theorem, which captures the claim that the
    <span class="inlinecode"><span class="id" type="var">verification_conditions</span></span> function does its job correctly.  Not
    surprisingly, we need all of the Hoare Logic rules in the
    proof.  We have used <i>in</i> variants of several tactics before to
    apply them to values in the context rather than the goal. An
    extension of this idea is the syntax <span class="inlinecode"><span class="id" type="var">tactic</span></span> <span class="inlinecode"><span class="id" type="keyword">in</span></span> <span class="inlinecode">*</span>, which applies
    <span class="inlinecode"><span class="id" type="var">tactic</span></span> in the goal and every hypothesis in the context.  We most
    commonly use this facility in conjunction with the <span class="inlinecode"><span class="id" type="tactic">simpl</span></span> tactic,
    as below. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="verification_correct"><span class="id" type="lemma">verification_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">d</span> <span class="id" type="var">P</span>, <br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> <span class="id" type="var">P</span> <span class="id" type="var">d</span> <span style="font-family: arial;">&rarr;</span> {{<span class="id" type="var">P</span>}} (<a class="idref" href="Hoare.html#extract"><span class="id" type="definition">extract</span></a> <span class="id" type="var">d</span>) {{<a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">dcom_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">d</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Skip".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_skip"><span class="id" type="lemma">hoare_skip</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]. <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_seq"><span class="id" type="lemma">hoare_seq</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHd2</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHd1</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Asgn".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_asgn"><span class="id" type="lemma">hoare_asgn</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "If".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HPre1</span> [<span class="id" type="var">HPre2</span> [<span class="id" type="var">HQeq</span> [<span class="id" type="var">HThen</span> <span class="id" type="var">HElse</span>]]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_if"><span class="id" type="lemma">hoare_if</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd1</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HThen</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">HQeq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd2</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HElse</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "While".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">a</span> <span class="id" type="var">into</span> <span class="id" type="var">Pbody</span>. <span class="id" type="tactic">rename</span> <span class="id" type="var">a0</span> <span class="id" type="var">into</span> <span class="id" type="var">Ppost</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hpre</span> [<span class="id" type="var">Hbody</span> [<span class="id" type="var">Hpost</span> <span class="id" type="var">Hd</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence"><span class="id" type="lemma">hoare_consequence</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#hoare_while"><span class="id" type="lemma">hoare_while</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <a class="idref" href="Hoare.html#post"><span class="id" type="definition">post</span></a> <span class="id" type="var">d</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHd</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hpost</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Pre".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HP</span> <span class="id" type="var">Hd</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_pre"><span class="id" type="lemma">hoare_consequence_pre</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hd</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Post".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hd</span> <span class="id" type="var">HQ</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="Hoare.html#hoare_consequence_post"><span class="id" type="lemma">hoare_consequence_post</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hd</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab439"></a><h2 class="section">Examples</h2>

<div class="paragraph"> </div>

 The propositions generated by <span class="inlinecode"><span class="id" type="var">verification_conditions</span></span> are fairly
    big, and they contain many conjuncts that are essentially trivial. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Eval</span> <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> (<a class="idref" href="Hoare.html#verification_conditions"><span class="id" type="definition">verification_conditions</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="inductive">True</span>) <a class="idref" href="Hoare.html#dec_while"><span class="id" type="definition">dec_while</span></a>).<br/>
<span class="comment">(*&nbsp;====&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;((fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True)&nbsp;~~&gt;&nbsp;(fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;((fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True)&nbsp;~~&gt;&nbsp;(fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;((fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;~~&gt;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;asnat&nbsp;(st&nbsp;X)&nbsp;&lt;&gt;&nbsp;0))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;((fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;~&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;~~&gt;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;asnat&nbsp;(st&nbsp;X)&nbsp;=&nbsp;0))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~~&gt;&nbsp;assn_sub&nbsp;X&nbsp;(AMinus&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;1))&nbsp;(fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True)&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
We can certainly work with them using just the tactics we have so
    far, but we can make things much smoother with a bit of
    automation.  We first define a custom <span class="inlinecode"><span class="id" type="var">verify</span></span> tactic that applies
    splitting repeatedly to turn all the conjunctions into separate
    subgoals and then uses <span class="inlinecode"><span class="id" type="tactic">omega</span></span> and <span class="inlinecode"><span class="id" type="tactic">eauto</span></span> (a handy
    general-purpose automation tactic that we'll discuss in detail
    later) to deal with as many of them as possible. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "verify" :=<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#verification_correct"><span class="id" type="lemma">verification_correct</span></a>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">assert_implies</span>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span> [<span class="id" type="var">H</span> : <span class="id" type="var">_</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">_</span> <span style="font-family: arial;">&#8866;</span> <span class="id" type="var">_</span>] =&gt; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">end</span>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">eauto</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">omega</span>.<br/>

<br/>
</div>

<div class="doc">
What's left after <span class="inlinecode"><span class="id" type="var">verify</span></span> does its thing is "just the interesting
    parts" of checking that the decorations are correct.  For example: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="dec_while_correct"><span class="id" type="lemma">dec_while_correct</span></a> :<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#dec_correct"><span class="id" type="definition">dec_correct</span></a> <a class="idref" href="Hoare.html#dec_while"><span class="id" type="definition">dec_while</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">verify</span>; <span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Another example (formalizing a decorated program we've seen
    before): 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="subtract_slowly_dec"><span class="id" type="definition">subtract_slowly_dec</span></a> (<span class="id" type="var">x</span>:<span class="id" type="inductive">nat</span>) (<span class="id" type="var">z</span>:<span class="id" type="inductive">nat</span>) : <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> := (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">x</span> <span style="font-family: arial;">&and;</span> <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) = <span class="id" type="var">z</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0))<br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span>   {{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) - <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">z</span> - <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0))) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) - (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) - 1) = <span class="id" type="var">z</span> - <span class="id" type="var">x</span> }} ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="ImpList.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) - <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">z</span> - <span class="id" type="var">x</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt;   <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <span class="id" type="var">z</span> - <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ~ <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 0))) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) = <span class="id" type="var">z</span> - <span class="id" type="var">x</span> }}<br/>
) % <span class="id" type="var">dcom</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="subtract_slowly_dec_correct"><span class="id" type="lemma">subtract_slowly_dec_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>, <br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#dec_correct"><span class="id" type="definition">dec_correct</span></a> (<a class="idref" href="Hoare.html#subtract_slowly_dec"><span class="id" type="definition">subtract_slowly_dec</span></a> <span class="id" type="var">x</span> <span class="id" type="var">z</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="var">verify</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H1</span>: <a class="idref" href="ImpList.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> (<a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a>) - 1)) <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> = <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="ImpList.html#update_neq"><span class="id" type="lemma">update_neq</span></a>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> [| <span class="id" type="var">X'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="lemma">minus_n_O</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#asnat"><span class="id" type="definition">asnat</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab440"></a><h4 class="section">Exercise: 3 stars (slow_assignment_dec)</h4>

<div class="paragraph"> </div>

 A roundabout way of assigning a number currently stored in <span class="inlinecode"><span class="id" type="var">X</span></span> to
   the variable <span class="inlinecode"><span class="id" type="var">Y</span></span> is to start <span class="inlinecode"><span class="id" type="var">Y</span></span> at <span class="inlinecode">0</span>, then decrement <span class="inlinecode"><span class="id" type="var">X</span></span> until it
   hits <span class="inlinecode">0</span>, incrementing <span class="inlinecode"><span class="id" type="var">Y</span></span> at each step.

<div class="paragraph"> </div>

   Here is an informal decorated program that implements this idea
   given a parameter <span class="inlinecode"><span class="id" type="var">x</span></span>: 
<div class="paragraph"> </div>


<div class="paragraph"> </div>


<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&gt;&nbsp;0&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Write a corresponding function that returns a value of type <span class="inlinecode"><span class="id" type="var">dcom</span></span>
    and prove it correct. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab441"></a><h4 class="section">Exercise: 4 stars, optional (factorial_dec)</h4>
 Remember the factorial function we worked with before: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="real_fact"><span class="id" type="definition">real_fact</span></a> (<span class="id" type="var">n</span>:<span class="id" type="inductive">nat</span>) : <span class="id" type="inductive">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">n</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">O</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="constructor">S</span> <span class="id" type="var">n'</span> =&gt; <span class="id" type="var">n</span> * (<a class="idref" href="Hoare.html#real_fact"><span class="id" type="definition">real_fact</span></a> <span class="id" type="var">n'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Following the pattern of <span class="inlinecode"><span class="id" type="var">subtract_slowly_dec</span></span>, write a decorated
    Imp program that implements the factorial function, and prove it
    correct. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 Finally, for a bigger example, let's redo the proof of
    <span class="inlinecode"><span class="id" type="var">list_member_correct</span></span> from above using our new tools.

<div class="paragraph"> </div>

    Notice that the <span class="inlinecode"><span class="id" type="var">verify</span></span> tactic leaves subgoals for each use of
    <span class="inlinecode"><span class="id" type="var">hoare_consequence</span></span> &mdash; that is, for each <span class="inlinecode">=&gt;</span> that occurs in the
    decorated program. Each of these implications relies on a fact
    about lists, for example that <span class="inlinecode"><span class="id" type="var">l</span></span> <span class="inlinecode">++</span> <span class="inlinecode">[]</span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">l</span></span>. In other words, the
    Hoare logic infrastructure has taken care of the boilerplate
    reasoning about the execution of imperative programs, while the
    user has to prove lemmas that are specific to the problem
    domain (e.g. lists or numbers). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="list_member_dec"><span class="id" type="definition">list_member_dec</span></a> (<span class="id" type="var">n</span> : <span class="id" type="inductive">nat</span>) (<span class="id" type="var">l</span> : <span class="id" type="inductive">list</span> <span class="id" type="inductive">nat</span>) : <a class="idref" href="Hoare.html#dcom"><span class="id" type="inductive">dcom</span></a> := (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> = <a class="idref" href="ImpList.html#VList"><span class="id" type="constructor">VList</span></a> <span class="id" type="var">l</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 0 }}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span> {{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="ImpList.html#AHead"><span class="id" type="constructor">AHead</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>))) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">st</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="ImpList.html#AHead"><span class="id" type="constructor">AHead</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>))) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#tail"><span class="id" type="definition">tail</span></a> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)) }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="ImpList.html#ANum"><span class="id" type="constructor">ANum</span></a> 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#tail"><span class="id" type="definition">tail</span></a> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)) }}<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">st</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ~<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="ImpList.html#AHead"><span class="id" type="constructor">AHead</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>))) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#tail"><span class="id" type="definition">tail</span></a> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)) }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#tail"><span class="id" type="definition">tail</span></a> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)) }}<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span> ;<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="ImpList.html#ATail"><span class="id" type="constructor">ATail</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span>  =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <span style="font-family: arial;">&and;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span> : <span class="id" type="inductive">list</span> <span class="id" type="inductive">nat</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)) }}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span style="font-family: arial;">&exist;</span> <span class="id" type="var">p</span>, <span class="id" type="var">p</span> ++ <a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="var">l</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">p</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ~<a class="idref" href="Hoare.html#bassn"><span class="id" type="definition">bassn</span></a> (<a class="idref" href="ImpList.html#BIsCons"><span class="id" type="constructor">BIsCons</span></a> (<a class="idref" href="ImpList.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <a class="idref" href="ImpList.html#Z"><span class="id" type="definition">Z</span></a> = <a class="idref" href="ImpList.html#VNat"><span class="id" type="constructor">VNat</span></a> 1 <span style="font-family: arial;">&harr;</span> <a class="idref" href="SfLib.html#appears_in"><span class="id" type="inductive">appears_in</span></a> <span class="id" type="var">n</span> <span class="id" type="var">l</span> }}<br/>
) %<span class="id" type="var">dcom</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="list_member_correct'"><span class="id" type="lemma">list_member_correct'</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Hoare.html#dec_correct"><span class="id" type="definition">dec_correct</span></a> (<a class="idref" href="Hoare.html#list_member_dec"><span class="id" type="definition">list_member_dec</span></a> <span class="id" type="var">n</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">verify</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "The loop precondition holds.".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> []. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">inversion</span> 1.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "IF taken".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span>  [<span class="id" type="var">p</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;know&nbsp;X&nbsp;is&nbsp;non-nil.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">p</span> <span class="id" type="var">h</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#snoc_equation"><span class="id" type="lemma">snoc_equation</span></a>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<a class="idref" href="Hoare.html#beq_true__eq"><span class="id" type="lemma">beq_true__eq</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#appears_in_snoc1"><span class="id" type="lemma">appears_in_snoc1</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "If not taken".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;know&nbsp;X&nbsp;is&nbsp;non-nil.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> (<a class="idref" href="Hoare.html#snoc"><span class="id" type="definition">snoc</span></a> <span class="id" type="var">p</span> <span class="id" type="var">h</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#snoc_equation"><span class="id" type="lemma">snoc_equation</span></a>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Hoare.html#appears_in_snoc2"><span class="id" type="lemma">appears_in_snoc2</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Hai</span>. <span class="id" type="tactic">destruct</span> (<a class="idref" href="Hoare.html#appears_in_snoc3"><span class="id" type="lemma">appears_in_snoc3</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Hai</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "later". <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "here (absurd)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#beq_nat_refl"><span class="id" type="lemma">beq_nat_refl</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop postcondition implies desired conclusion (-&gt;)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#append_nil"><span class="id" type="lemma">append_nil</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H3</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "loop postcondition implies desired conclusion (&lt;-)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="ImpList.html#aslist"><span class="id" type="definition">aslist</span></a> (<span class="id" type="var">st</span> <a class="idref" href="ImpList.html#X"><span class="id" type="definition">X</span></a>)) <span class="id" type="keyword">as</span> [|<span class="id" type="var">h</span> <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="Hoare.html#append_nil"><span class="id" type="lemma">append_nil</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H3</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>