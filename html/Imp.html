<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>Imp: Simple Imperative Programs</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Imp<span class="subtitle">Simple Imperative Programs</span></h1>

<div class="code code-tight">
</div>

<div class="doc">

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;$Date:&nbsp;2011-06-22&nbsp;14:56:13&nbsp;-0400&nbsp;(Wed,&nbsp;22&nbsp;Jun&nbsp;2011)&nbsp;$&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
In this chapter, we begin a new direction that we'll
    continue for the rest of the course: up to now we've been mostly
    studying Coq itself, but from now on we'll mostly be using Coq to
    formalize other things.

<div class="paragraph"> </div>

    Our first case study is a <i>simple imperative programming language</i>
    called Imp.  Here is a familiar mathematical function written in
    Imp.

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">not</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;0)&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>
    This chapter looks at how to define the <i>syntax</i> and <i>semantics</i>
    of Imp; the chapters that follow develop a theory of <i>program
    equivalence</i> and introduce <i>Hoare Logic</i>, the best known logic for
    reasoning about imperative programs. 
<div class="paragraph"> </div>

<a name="lab284"></a><h3 class="section">Sflib</h3>

<div class="paragraph"> </div>

 A minor technical point: Instead of asking Coq to import our
    earlier definitions from <span class="inlinecode"><span class="id" type="var">Logic.v</span></span>, we import a small library
    called <span class="inlinecode"><span class="id" type="var">Sflib.v</span></span>, containing just a few definitions and theorems
    from earlier chapters that we'll actually use in the rest of the
    course.  You won't notice much difference, since most of what's
    missing from Sflib has identical definitions in the Coq standard
    library.  The main reason for doing this is to tidy the global Coq
    environment so that, for example, it is easier to search for
    relevant theorems. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Export</span> <a class="idref" href="SfLib.html#"><span class="id" type="library">SfLib</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab285"></a><h1 class="section">Arithmetic and Boolean Expressions</h1>

<div class="paragraph"> </div>

 We'll present Imp in three parts: first a core language of
    <i>arithmetic and boolean expressions</i>, then an extension of these
    expressions with <i>variables</i>, and finally a language of <i>commands</i>
    including assignment, conditions, sequencing, and loops. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <a name="AExp"><span class="id" type="module">AExp</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab286"></a><h2 class="section">Syntax</h2>

<div class="paragraph"> </div>

 These two definitions specify the <i>abstract syntax</i> of
    arithmetic and boolean expressions. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="AExp.aexp"><span class="id" type="inductive">aexp</span></a> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <a name="AExp.ANum"><span class="id" type="constructor">ANum</span></a> : <span class="id" type="inductive">nat</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.APlus"><span class="id" type="constructor">APlus</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.AMinus"><span class="id" type="constructor">AMinus</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.AMult"><span class="id" type="constructor">AMult</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <a name="AExp.bexp"><span class="id" type="inductive">bexp</span></a> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <a name="AExp.BTrue"><span class="id" type="constructor">BTrue</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.BFalse"><span class="id" type="constructor">BFalse</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.BEq"><span class="id" type="constructor">BEq</span></a> : <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.BLe"><span class="id" type="constructor">BLe</span></a> : <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.BNot"><span class="id" type="constructor">BNot</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="AExp.BAnd"><span class="id" type="constructor">BAnd</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a>.<br/>

<br/>
</div>

<div class="doc">
In this chapter, we'll elide the translation from the
    concrete syntax that a programmer would actually write to these
    abstract syntax trees &mdash; the process that, for example, would
    translate the string <span class="inlinecode">"1+2*3"</span> to the AST <span class="inlinecode"><span class="id" type="var">APlus</span></span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span>
    <span class="inlinecode">1)</span> <span class="inlinecode">(<span class="id" type="var">AMult</span></span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span> <span class="inlinecode">2)</span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span> <span class="inlinecode">3))</span>.  The file <span class="inlinecode"><span class="id" type="var">ImpParser.v</span></span> develops a
    simple implementation of a lexical analyzer and parser that can
    perform this translation.  You do <i>not</i> need to understand that
    file to understand this one, but if you haven't taken a course
    where these techniques are covered (e.g., a compilers course) you
    may want to skim it. 
<div class="paragraph"> </div>

 For comparison, here's a conventional BNF (Backus-Naur Form)
    grammar defining the same abstract syntax: 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp</span>&nbsp;::=&nbsp;<span class="id" type="var">nat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'+'&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'-'&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'*'&nbsp;<span class="id" type="var">aexp</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bexp</span>&nbsp;::=&nbsp;<span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'='&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'&lt;='&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">bexp</span>&nbsp;'<span class="id" type="var">and'</span>&nbsp;<span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;'<span class="id" type="var">not'</span>&nbsp;<span class="id" type="var">bexp</span>&nbsp;
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Compared to the Coq version above...

<div class="paragraph"> </div>

<ul class="doclist">
<li> The BNF is more informal &mdash; for example, it gives some
         suggestions about the surface syntax of expressions (like the
         fact that the addition operation is written <span class="inlinecode">+</span> and is an
         infix symbol) while leaving other aspects of lexical analysis
         and parsing (like the relative precedence of <span class="inlinecode">+</span>, <span class="inlinecode">-</span>, and
         <span class="inlinecode">*</span>) unspecified.  Some additional information &mdash; and human
         intelligence &mdash; would be required to turn this description
         into a formal definition (when implementing a compiler, for
         example).

<div class="paragraph"> </div>

         The Coq version consistently omits all this information and
         concentrates on the abstract syntax only.

<div class="paragraph"> </div>


</li>
<li> On the other hand, the BNF version is lighter and arguably
         easier to read.  Its informality makes it flexible, which is
         a huge advantage in situations like discussions at the
         blackboard, where conveying general ideas is more important
         than getting every detail nailed down precisely. 

<div class="paragraph"> </div>

         Indeed, there are dozens of BNF-like notations and people
         switch freely among them, usually without bothering to which
         form of BNF they're using because there is no need to: a
         rough-and-ready informal understanding is all that's
         needed. 
</li>
</ul>

<div class="paragraph"> </div>

 It's good to be comfortable with both sorts of notations: informal
    ones for communicating between humans and formal ones for carrying
    out implementations and proofs. 
<div class="paragraph"> </div>

<a name="lab287"></a><h2 class="section">Evaluation</h2>

<div class="paragraph"> </div>

 <i>Evaluating</i> an arithmetic expression reduces it to a single number. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="AExp.aeval"><span class="id" type="definition">aeval</span></a> (<span class="id" type="var">e</span> : <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a>) : <span class="id" type="inductive">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a1</span>) + (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.AMinus"><span class="id" type="constructor">AMinus</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  =&gt; (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a1</span>) - (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.AMult"><span class="id" type="constructor">AMult</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a1</span>) * (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <a name="AExp.test_aeval1"><span class="id" type="definition">test_aeval1</span></a>: <br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> (<a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 2) (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 2)) = 4.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Similarly, evaluating a boolean expression yields a boolean. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="AExp.beval"><span class="id" type="definition">beval</span></a> (<span class="id" type="var">e</span> : <a class="idref" href="Imp.html#AExp.bexp"><span class="id" type="inductive">bexp</span></a>) : <span class="id" type="inductive">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.BTrue"><span class="id" type="constructor">BTrue</span></a>       =&gt; <span class="id" type="constructor">true</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.BFalse"><span class="id" type="constructor">BFalse</span></a>      =&gt; <span class="id" type="constructor">false</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.BEq"><span class="id" type="constructor">BEq</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <span class="id" type="definition">beq_nat</span> (<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a1</span>) (<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.BLe"><span class="id" type="constructor">BLe</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <a class="idref" href="SfLib.html#ble_nat"><span class="id" type="definition">ble_nat</span></a> (<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a1</span>) (<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.BNot"><span class="id" type="constructor">BNot</span></a> <span class="id" type="var">b1</span>     =&gt; <span class="id" type="definition">negb</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">b1</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.BAnd"><span class="id" type="constructor">BAnd</span></a> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span>  =&gt; <span class="id" type="definition">andb</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">b1</span>) (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">b2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab288"></a><h2 class="section">Optimization</h2>

<div class="paragraph"> </div>

 We haven't defined very much yet, but we can already get
    some mileage out of the definitions.  Suppose we define a function
    that takes an arithmetic expression and slightly simplifies it,
    changing every occurrence of <span class="inlinecode">0+<span class="id" type="var">e</span></span> (i.e., <span class="inlinecode">(<span class="id" type="var">APlus</span></span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span> <span class="inlinecode">0)</span> <span class="inlinecode"><span class="id" type="var">e</span></span>)
    into just <span class="inlinecode"><span class="id" type="var">e</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="AExp.optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> (<span class="id" type="var">e</span>:<a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a>) : <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">n</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 0) <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e2</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e1</span>) (<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.AMinus"><span class="id" type="constructor">AMinus</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e1</span>) (<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AExp.AMult"><span class="id" type="constructor">AMult</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e1</span>) (<a class="idref" href="Imp.html#optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
To make sure our optimization is doing the right thing we
    can test it on some examples and see if the output looks OK. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="AExp.test_optimize_0plus"><span class="id" type="definition">test_optimize_0plus</span></a>: <br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> (<a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 2) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 0) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 0) (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 1)))) <br/>
&nbsp;&nbsp;= <a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 2) (<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> 1).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
But if we want to be sure the optimization is correct &mdash;
    i.e., that evaluating an optimized expression gives the same
    result as the original &mdash; we should prove it. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="AExp.optimize_0plus_sound"><span class="id" type="lemma">optimize_0plus_sound</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> (<a class="idref" href="Imp.html#AExp.optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e</span>) = <a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "ANum". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus". <span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = ANum n". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "n = 0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHe2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "n &lt;&gt; 0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = APlus e1_1 e1_2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = AMinus e1_1 e1_2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = AMult e1_1 e1_2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "AMinus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "AMult".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab289"></a><h1 class="section">Coq Automation</h1>

<div class="paragraph"> </div>

 The repetition in this last proof is starting to be a little
    annoying.  It's still just about bearable, but if either the
    language of arithmetic expressions or the optimization being
    proved sound were significantly more complex, it would begin to be
    a real problem.

<div class="paragraph"> </div>

    So far, we've been doing all our proofs using just a small handful
    of Coq's tactics and completely ignoring its very powerful
    facilities for constructing proofs automatically.  This section
    introduces some of these facilities, and we will see more over the
    next several chapters.  Getting used to them will take some 
    energy &mdash; Coq's automation is a power tool &mdash; but it will allow us to
    scale up our efforts to more complex definitions and more
    interesting properties without becoming overwhelmed by boring,
    repetitive, or low-level details. 
<div class="paragraph"> </div>

<a name="lab290"></a><h2 class="section">Tacticals</h2>

<div class="paragraph"> </div>

 <i>Tactical</i> is Coq's term for tactics that take other tactics as
    arguments &mdash; "higher-order tactics," if you will.  
<div class="paragraph"> </div>

<a name="lab291"></a><h3 class="section">The <span class="inlinecode"><span class="id" type="tactic">try</span></span> Tactical</h3>

<div class="paragraph"> </div>

 One very simple tactical is <span class="inlinecode"><span class="id" type="tactic">try</span></span>: If <span class="inlinecode"><span class="id" type="var">T</span></span> is a tactic, then <span class="inlinecode"><span class="id" type="tactic">try</span></span>
    <span class="inlinecode"><span class="id" type="var">T</span></span> is a tactic that is just like <span class="inlinecode"><span class="id" type="var">T</span></span> except that, if <span class="inlinecode"><span class="id" type="var">T</span></span> fails,
    <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> does nothing at all (instead of failing). 
<div class="paragraph"> </div>

<a name="lab292"></a><h3 class="section">The <span class="inlinecode">;</span> Tactical</h3>

<div class="paragraph"> </div>

 Another very basic tactical is written <span class="inlinecode">;</span>.  If <span class="inlinecode"><span class="id" type="var">T</span></span>, <span class="inlinecode"><span class="id" type="var">T1</span></span>, ...,
    <span class="inlinecode"><span class="id" type="var">Tn</span></span> are tactics, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>;&nbsp;[<span class="id" type="var">T1</span>&nbsp;|&nbsp;<span class="id" type="var">T2</span>&nbsp;|&nbsp;... |&nbsp;<span class="id" type="var">Tn</span>]&nbsp;
<div class="paragraph"> </div>

</div>
   is a tactic that first performs <span class="inlinecode"><span class="id" type="var">T</span></span> and then performs <span class="inlinecode"><span class="id" type="var">T1</span></span> on the
   first subgoal generated by <span class="inlinecode"><span class="id" type="var">T</span></span>, performs <span class="inlinecode"><span class="id" type="var">T2</span></span> on the second
   subgoal, etc.

<div class="paragraph"> </div>

   In the special case where all of the <span class="inlinecode"><span class="id" type="var">Ti</span></span>'s are the same tactic
   <span class="inlinecode"><span class="id" type="var">T'</span></span>, we can just write <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> instead of:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>;&nbsp;[<span class="id" type="var">T'</span>&nbsp;|&nbsp;<span class="id" type="var">T'</span>&nbsp;|&nbsp;... |&nbsp;<span class="id" type="var">T'</span>]&nbsp;
<div class="paragraph"> </div>

</div>
   That is, if <span class="inlinecode"><span class="id" type="var">T</span></span> and <span class="inlinecode"><span class="id" type="var">T'</span></span> are tactics, then <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> is a tactic that
   first performs <span class="inlinecode"><span class="id" type="var">T</span></span> and then performs <span class="inlinecode"><span class="id" type="var">T'</span></span> on <i>each subgoal</i>
   generated by <span class="inlinecode"><span class="id" type="var">T</span></span>.  This is the form of <span class="inlinecode">;</span> that is used most often
   in practice. 
<div class="paragraph"> </div>

 For example, consider the following trivial lemma: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <a name="AExp.foo"><span class="id" type="lemma">foo</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span>, <a class="idref" href="SfLib.html#ble_nat"><span class="id" type="definition">ble_nat</span></a> 0 <span class="id" type="var">n</span> = <span class="id" type="constructor">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Leaves&nbsp;two&nbsp;subgoals...&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "n=0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "n=Sn'". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;...&nbsp;which&nbsp;are&nbsp;discharged&nbsp;similarly&nbsp;*)</span><br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
We can simplify the proof above using the <span class="inlinecode">;</span> tactical. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <a name="AExp.foo'"><span class="id" type="lemma">foo'</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span>, <a class="idref" href="SfLib.html#ble_nat"><span class="id" type="definition">ble_nat</span></a> 0 <span class="id" type="var">n</span> = <span class="id" type="constructor">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Apply&nbsp;<span class="inlinecode"><span class="id" type="tactic">destruct</span></span>&nbsp;to&nbsp;the&nbsp;current&nbsp;goal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>; <br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;then&nbsp;apply&nbsp;<span class="inlinecode"><span class="id" type="tactic">simpl</span></span>&nbsp;to&nbsp;each&nbsp;resulting&nbsp;subgoal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;then&nbsp;apply&nbsp;<span class="inlinecode"><span class="id" type="tactic">reflexivity</span></span>&nbsp;to&nbsp;each&nbsp;resulting&nbsp;subgoal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Using <span class="inlinecode"><span class="id" type="tactic">try</span></span> and <span class="inlinecode">;</span> together, we can get rid of the repetition in
    the proof that was bothering us a little while ago. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="AExp.optimize_0plus_sound'"><span class="id" type="lemma">optimize_0plus_sound'</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> (<a class="idref" href="Imp.html#AExp.optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e</span>) = <a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Most&nbsp;cases&nbsp;follow&nbsp;directly&nbsp;by&nbsp;the&nbsp;IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "ANum". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Most&nbsp;cases&nbsp;follow&nbsp;directly&nbsp;by&nbsp;the&nbsp;IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;interesting&nbsp;case,&nbsp;on&nbsp;which&nbsp;the&nbsp;above&nbsp;fails,&nbsp;is&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;<span class="inlinecode"><span class="id" type="var">e1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span>.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;have&nbsp;to&nbsp;destruct&nbsp;<span class="inlinecode"><span class="id" type="var">n</span></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to&nbsp;see&nbsp;whether&nbsp;the&nbsp;optimization&nbsp;applies)&nbsp;and&nbsp;rewrite&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;induction&nbsp;hypothesis.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = ANum n". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
In practice, Coq experts often use <span class="inlinecode"><span class="id" type="tactic">try</span></span> with a tactic like
    <span class="inlinecode"><span class="id" type="tactic">induction</span></span> to take care of many similar "straightforward" cases
    all at once.  Naturally, this practice has an analog in informal
    proofs.  Here is an informal proof of this theorem that
    matches the structure of the formal one:

<div class="paragraph"> </div>

    <i>Theorem</i>: For all arithmetic expressions <span class="inlinecode"><span class="id" type="var">e</span></span>,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e</span>)&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">e</span>.
<div class="paragraph"> </div>

</div>
    <i>Proof</i>: By induction on <span class="inlinecode"><span class="id" type="var">e</span></span>.  The <span class="inlinecode"><span class="id" type="var">AMinus</span></span> and <span class="inlinecode"><span class="id" type="var">AMult</span></span> cases
    follow directly from the IH.  The remaining cases are as follows:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Suppose <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span> for some <span class="inlinecode"><span class="id" type="var">n</span></span>.  We must show 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;(<span class="id" type="var">ANum</span>&nbsp;<span class="id" type="var">n</span>))&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;(<span class="id" type="var">ANum</span>&nbsp;<span class="id" type="var">n</span>).
<div class="paragraph"> </div>

</div>
        This is immediate from the definition of <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span>.

<div class="paragraph"> </div>


</li>
<li> Suppose <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">APlus</span></span> <span class="inlinecode"><span class="id" type="var">e1</span></span> <span class="inlinecode"><span class="id" type="var">e2</span></span> for some <span class="inlinecode"><span class="id" type="var">e1</span></span> and <span class="inlinecode"><span class="id" type="var">e2</span></span>.  We
        must show

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;(<span class="id" type="var">APlus</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>))&nbsp;<br/>
=&nbsp;<span class="id" type="var">aeval</span>&nbsp;(<span class="id" type="var">APlus</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>).
<div class="paragraph"> </div>

</div>
        Consider the possible forms of <span class="inlinecode"><span class="id" type="var">e1</span></span>.  For most of them,
        <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> simply calls itself recursively for the
        subexpressions and rebuilds a new expression of the same form
        as <span class="inlinecode"><span class="id" type="var">e1</span></span>; in these cases, the result follows directly from the
        IH.

<div class="paragraph"> </div>

        The interesting case is when <span class="inlinecode"><span class="id" type="var">e1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span> for some <span class="inlinecode"><span class="id" type="var">n</span></span>.
        If <span class="inlinecode"><span class="id" type="var">n</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode">0</span>, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;<span class="id" type="var">optimize_0plus</span>&nbsp;(<span class="id" type="var">APlus</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>)&nbsp;=&nbsp;<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e2</span>
<div class="paragraph"> </div>

</div>
        and the IH for <span class="inlinecode"><span class="id" type="var">e2</span></span> is exactly what we need.  On the other
        hand, if <span class="inlinecode"><span class="id" type="var">n</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">S</span></span> <span class="inlinecode"><span class="id" type="var">n'</span></span> for some <span class="inlinecode"><span class="id" type="var">n'</span></span>, then again <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span>
        simply calls itself recursively, and the result follows from
        the IH.  <font size=-2>&#9744;</font> 
</li>
</ul>

<div class="paragraph"> </div>

 This proof can still be improved: the first case (for <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span>
    <span class="inlinecode"><span class="id" type="var">n</span></span>) is very trivial &mdash; even more trivial than the cases that we
    said simply followed from the IH &mdash; yet we have chosen to write it
    out in full.  It would be better and clearer to drop it and just
    say, at the top, "Most cases are either immediate or direct from
    the IH.  The only interesting case is the one for <span class="inlinecode"><span class="id" type="var">APlus</span></span>..."  We
    can make the same improvement in our formal proof too.  Here's how
    it looks: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="AExp.optimize_0plus_sound''"><span class="id" type="lemma">optimize_0plus_sound''</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> (<a class="idref" href="Imp.html#AExp.optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e</span>) = <a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Most&nbsp;cases&nbsp;follow&nbsp;directly&nbsp;by&nbsp;the&nbsp;IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;...&nbsp;or&nbsp;are&nbsp;immediate&nbsp;by&nbsp;definition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;interesting&nbsp;case&nbsp;is&nbsp;when&nbsp;e&nbsp;=&nbsp;APlus&nbsp;e1&nbsp;e2.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>; <span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = ANum n". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab293"></a><h2 class="section">Defining New Tactic Notations</h2>

<div class="paragraph"> </div>

 Coq also provides several ways of "programming" tactic scripts. 

<div class="paragraph"> </div>

<ul class="doclist">
<li> The <span class="inlinecode"><span class="id" type="keyword">Tactic</span></span> <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> command gives a handy way to define
        "shorthand tactics" that, when invoked, apply several tactics
        at the same time.

<div class="paragraph"> </div>


</li>
<li> For more sophisticated programming, Coq offers a small
        built-in programming language called <span class="inlinecode"><span class="id" type="keyword">Ltac</span></span> with primitives
        that can examine and modify the proof state.  The details are
        a bit too complicated to get into here (and it is generally
        agreed that <span class="inlinecode"><span class="id" type="keyword">Ltac</span></span> is not the most beautiful part of Coq's
        design!), but they can be found in the reference manual, and
        there are many examples of <span class="inlinecode"><span class="id" type="keyword">Ltac</span></span> definitions in the Coq
        standard library that you can use as examples.

<div class="paragraph"> </div>


</li>
<li> There is also an OCaml API that can be used to build new
        tactics that access Coq's internal structures at a lower
        level, but this is seldom worth the trouble for ordinary Coq
        users. 

</li>
</ul>

<div class="paragraph"> </div>

The <span class="inlinecode"><span class="id" type="keyword">Tactic</span></span> <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> mechanism is the easiest to come to grips with,
and it offers plenty of power for many purposes.  Here's an example. 

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "simpl_and_try" <span class="id" type="var">tactic</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">c</span>.<br/>

<br/>
</div>

<div class="doc">
This defines a new tactical called <span class="inlinecode"><span class="id" type="var">simpl_and_try</span></span> which
    takes one tactic <span class="inlinecode"><span class="id" type="var">c</span></span> as an argument, and is defined to be
    equivalent to the tactic <span class="inlinecode"><span class="id" type="tactic">simpl</span>;</span> <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span>.  For example, writing
    "<span class="inlinecode"><span class="id" type="var">simpl_and_try</span></span> <span class="inlinecode"><span class="id" type="tactic">reflexivity</span>.</span>" in a proof would be the same as
    writing "<span class="inlinecode"><span class="id" type="tactic">simpl</span>;</span> <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="tactic">reflexivity</span>.</span>" 
<div class="paragraph"> </div>

 The next subsection gives a more sophisticated use of this
    feature... 
<div class="paragraph"> </div>

<a name="lab294"></a><h3 class="section">Bulletproofing Case Analyses</h3>

<div class="paragraph"> </div>

 Being able to deal with most of the cases of an <span class="inlinecode"><span class="id" type="tactic">induction</span></span> or
    <span class="inlinecode"><span class="id" type="tactic">destruct</span></span> all at the same time is very convenient, but it can
    also be a little confusing.  One problem that often comes up is
    that <i>maintaining</i> proofs written in this style can be difficult.
    For example, suppose that, later, we extended the definition of
    <span class="inlinecode"><span class="id" type="var">aexp</span></span> with another constructor that also required a special
    argument.  The above proof might break because Coq generated the
    subgoals for this constructor before the one for <span class="inlinecode"><span class="id" type="var">APlus</span></span>, so that,
    at the point when we start working on the <span class="inlinecode"><span class="id" type="var">APlus</span></span> case, Coq is
    actually expecting the argument for a completely different
    constructor.  What we'd like is to get a sensible error message
    saying "I was expecting the <span class="inlinecode"><span class="id" type="var">AFoo</span></span> case at this point, but the
    proof script is talking about <span class="inlinecode"><span class="id" type="var">APlus</span></span>."  Here's a nice little
    trick that smoothly achieves this. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "aexp_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ANum" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "APlus"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMinus" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMult" ].<br/>

<br/>
</div>

<div class="doc">
(<span class="inlinecode"><span class="id" type="var">Case_aux</span></span> implements the common functionality of <span class="inlinecode"><span class="id" type="var">Case</span></span>,
    <span class="inlinecode"><span class="id" type="var">SCase</span></span>, <span class="inlinecode"><span class="id" type="var">SSCase</span></span>, etc.  For example, <span class="inlinecode"><span class="id" type="var">Case</span></span> <span class="inlinecode">"<span class="id" type="var">foo</span>"</span> is defined as
    <span class="inlinecode"><span class="id" type="var">Case_aux</span></span> <span class="inlinecode"><span class="id" type="var">Case</span></span> <span class="inlinecode">"<span class="id" type="var">foo</span>".)</span> <span class="inlinecode"></span>
<div class="paragraph"> </div>

 For example, if <span class="inlinecode"><span class="id" type="var">e</span></span> is a variable of type <span class="inlinecode"><span class="id" type="var">aexp</span></span>, then doing

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span>&nbsp;(<span class="id" type="tactic">induction</span>&nbsp;<span class="id" type="var">e</span>)&nbsp;<span class="id" type="var">Case</span>
<div class="paragraph"> </div>

</div>
    will perform an induction on <span class="inlinecode"><span class="id" type="var">e</span></span> (the same as if we had just typed
    <span class="inlinecode"><span class="id" type="tactic">induction</span></span> <span class="inlinecode"><span class="id" type="var">e</span></span>) and <i>also</i> add a <span class="inlinecode"><span class="id" type="var">Case</span></span> tag to each subgoal
    generated by the <span class="inlinecode"><span class="id" type="tactic">induction</span></span>, labeling which constructor it comes
    from.  For example, here is yet another proof of
    optimize_0plus_sound, using <span class="inlinecode"><span class="id" type="var">aexp_cases</span></span>: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="AExp.optimize_0plus_sound'''"><span class="id" type="lemma">optimize_0plus_sound'''</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> (<a class="idref" href="Imp.html#AExp.optimize_0plus"><span class="id" type="definition">optimize_0plus</span></a> <span class="id" type="var">e</span>) = <a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>) <span class="id" type="var">Case</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;At&nbsp;this&nbsp;point,&nbsp;there&nbsp;is&nbsp;already&nbsp;an&nbsp;<span class="inlinecode">"<span class="id" type="var">APlus</span>"</span>&nbsp;case&nbsp;name&nbsp;in&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.&nbsp;&nbsp;The&nbsp;<span class="inlinecode"><span class="id" type="var">Case</span></span> <span class="inlinecode">"<span class="id" type="var">APlus</span>"</span>&nbsp;here&nbsp;in&nbsp;the&nbsp;proof&nbsp;text&nbsp;has&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;effect&nbsp;of&nbsp;a&nbsp;sanity&nbsp;check:&nbsp;if&nbsp;the&nbsp;"Case"&nbsp;string&nbsp;in&nbsp;the&nbsp;context&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anything&nbsp;_other_&nbsp;than&nbsp;<span class="inlinecode">"<span class="id" type="var">APlus</span>"</span>&nbsp;(for&nbsp;example,&nbsp;because&nbsp;we&nbsp;added&nbsp;a<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clause&nbsp;to&nbsp;the&nbsp;definition&nbsp;of&nbsp;<span class="inlinecode"><span class="id" type="var">aexp</span></span>&nbsp;and&nbsp;forgot&nbsp;to&nbsp;change&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proof)&nbsp;we'll&nbsp;get&nbsp;a&nbsp;helpful&nbsp;error&nbsp;at&nbsp;this&nbsp;point&nbsp;telling&nbsp;us&nbsp;that<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;is&nbsp;now&nbsp;the&nbsp;wrong&nbsp;case.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span> (<span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>) <span class="id" type="var">SCase</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ANum". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab295"></a><h4 class="section">Exercise: 3 stars (optimize_0plus_b)</h4>
 Since the <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> tranformation doesn't change the value
    of <span class="inlinecode"><span class="id" type="var">aexp</span></span>s, we should be able to apply it to all the <span class="inlinecode"><span class="id" type="var">aexp</span></span>s that
    appear in a <span class="inlinecode"><span class="id" type="var">bexp</span></span> without changing the <span class="inlinecode"><span class="id" type="var">bexp</span></span>'s value.  Write a
    function which performs that transformation on <span class="inlinecode"><span class="id" type="var">bexp</span></span>s, and prove
    it is sound.  Use the tacticals we've just seen to make the proof
    as elegant as possible. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab296"></a><h4 class="section">Exercise: 4 stars, optional (optimizer)</h4>
 <i>Design exercise</i>: The optimization implemented by our
    <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> function is only one of many imaginable
    optimizations on arithmetic and boolean expressions.  Write a more
    sophisticated optimizer and prove it correct.

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
 <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab297"></a><h2 class="section">The <span class="inlinecode"><span class="id" type="tactic">omega</span></span> Tactic</h2>

<div class="paragraph"> </div>

 The <span class="inlinecode"><span class="id" type="tactic">omega</span></span> tactic implements a decision procedure for a subset of
    first-order logic called <i>Presburger arithmetic</i>.  It is based on
    the Omega algorithm invented in 1992 by William Pugh.

<div class="paragraph"> </div>

    If the goal is a universally quantified formula made out of

<div class="paragraph"> </div>

<ul class="doclist">
<li> numeric constants, addition (<span class="inlinecode">+</span> and <span class="inlinecode"><span class="id" type="var">S</span></span>), subtraction (<span class="inlinecode">-</span>
        and <span class="inlinecode"><span class="id" type="var">pred</span></span>), and multiplication by constants (this is what
        makes it Presburger arithmetic), 

<div class="paragraph"> </div>


</li>
<li> equality (<span class="inlinecode">=</span> and <span class="inlinecode">&lt;&gt;</span>) and inequality (<span class="inlinecode">&lt;=</span>), and

<div class="paragraph"> </div>


</li>
<li> the logical connectives <span class="inlinecode"><span style="font-family: arial;">&and;</span></span>, <span class="inlinecode"><span style="font-family: arial;">&or;</span></span>, <span class="inlinecode">~</span>, and <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span>,

</li>
</ul>

<div class="paragraph"> </div>

    then invoking <span class="inlinecode"><span class="id" type="tactic">omega</span></span> will either solve the goal or tell you that
    it is actually false. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="AExp.silly_presburger_example"><span class="id" type="definition">silly_presburger_example</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">m</span> <span class="id" type="var">n</span> <span class="id" type="var">o</span> <span class="id" type="var">p</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">m</span> + <span class="id" type="var">n</span> &lt;= <span class="id" type="var">n</span> + <span class="id" type="var">o</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">o</span> + 3 = <span class="id" type="var">p</span> + 3 <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">m</span> &lt;= <span class="id" type="var">p</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Andrew Appel calls this the "Santa Claus tactic." 
<div class="paragraph"> </div>

<a name="lab298"></a><h2 class="section">A Few More Handy Tactics</h2>

<div class="paragraph"> </div>

 Finally, here are some miscellaneous tactics that you may find
    convenient.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="tactic">clear</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>: Delete hypothesis <span class="inlinecode"><span class="id" type="var">H</span></span> from the context.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">subst</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span>: Find an assumption <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">e</span></span> or <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span> in the
       context, replace <span class="inlinecode"><span class="id" type="var">x</span></span> with <span class="inlinecode"><span class="id" type="var">e</span></span> throughout the context and
       current goal, and clear the assumption.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">subst</span></span>: Substitute away <i>all</i> assumptions of the form <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">e</span></span>
       or <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">rename</span>...</span> <span class="inlinecode"><span class="id" type="var">into</span>...</span>: Change the name of a hypothesis in the
       proof context.  For example, if the context includes a variable
       named <span class="inlinecode"><span class="id" type="var">x</span></span>, then <span class="inlinecode"><span class="id" type="tactic">rename</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">into</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> will change all occurrences
       of <span class="inlinecode"><span class="id" type="var">x</span></span> to <span class="inlinecode"><span class="id" type="var">y</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">assumption</span></span>: Try to find a hypothesis <span class="inlinecode"><span class="id" type="var">H</span></span> in the context that
       exactly matches the goal; if one is found, behave just like
       <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="var">contradiction</span></span>: Try to find a hypothesis <span class="inlinecode"><span class="id" type="var">H</span></span> in the current
       context that is equivalent to <span class="inlinecode"><span class="id" type="var">False</span></span>.  If one is found, solve
       the goal.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="var">constructor</span></span>: Try to find a constructor <span class="inlinecode"><span class="id" type="var">c</span></span> (from some
       <span class="inlinecode"><span class="id" type="keyword">Inductive</span></span> definition in the current environment) that can be
       applied to solve the current goal.  If one is found, behave
       like <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span>.

</li>
</ul>

<div class="paragraph"> </div>

    We'll see many examples of these in the proofs below. 
<div class="paragraph"> </div>

<a name="lab299"></a><h1 class="section">Evaluation as a Relation</h1>

<div class="paragraph"> </div>

 We have presented <span class="inlinecode"><span class="id" type="var">aeval</span></span> and <span class="inlinecode"><span class="id" type="var">beval</span></span> as functions defined by
    <span class="inlinecode"><span class="id" type="var">Fixpoints</span></span>. An alternative way to think about evaluation is as a
    <i>relation</i> between expressions and their values.

<div class="paragraph"> </div>

    This leads naturally to Coq <span class="inlinecode"><span class="id" type="keyword">Inductive</span></span> definitions like the
    following one for arithmetic expressions... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <a name="AExp.aevalR_first_try"><span class="id" type="module">aevalR_first_try</span></a>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <a name="AExp.aevalR_first_try.aevalR"><span class="id" type="inductive">aevalR</span></a> : <a class="idref" href="Imp.html#AExp.aevalR_first_try.aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="inductive">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="AExp.aevalR_first_try.E_ANum"><span class="id" type="constructor">E_ANum</span></a>  : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">n</span>: <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> (<a class="idref" href="Imp.html#AExp.aevalR_first_try.ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">n</span>) <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <a name="AExp.aevalR_first_try.E_APlus"><span class="id" type="constructor">E_APlus</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <a class="idref" href="Imp.html#AExp.aevalR_first_try.aexp"><span class="id" type="inductive">aexp</span></a>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span>: <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">n1</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e2</span> <span class="id" type="var">n2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> (<a class="idref" href="Imp.html#AExp.aevalR_first_try.APlus"><span class="id" type="constructor">APlus</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) (<span class="id" type="var">n1</span> + <span class="id" type="var">n2</span>)<br/>
&nbsp;&nbsp;| <a name="AExp.aevalR_first_try.E_AMinus"><span class="id" type="constructor">E_AMinus</span></a>: <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <a class="idref" href="Imp.html#AExp.aevalR_first_try.aexp"><span class="id" type="inductive">aexp</span></a>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span>: <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">n1</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e2</span> <span class="id" type="var">n2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> (<a class="idref" href="Imp.html#AExp.aevalR_first_try.AMinus"><span class="id" type="constructor">AMinus</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) (<span class="id" type="var">n1</span> - <span class="id" type="var">n2</span>)<br/>
&nbsp;&nbsp;| <a name="AExp.aevalR_first_try.E_AMult"><span class="id" type="constructor">E_AMult</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <a class="idref" href="Imp.html#AExp.aevalR_first_try.aexp"><span class="id" type="inductive">aexp</span></a>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span>: <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">n1</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e2</span> <span class="id" type="var">n2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> (<a class="idref" href="Imp.html#AExp.aevalR_first_try.AMult"><span class="id" type="constructor">AMult</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) (<span class="id" type="var">n1</span> * <span class="id" type="var">n2</span>).<br/>

<br/>
</div>

<div class="doc">
As is often the case with relations, we'll find it
    convenient to define infix notation for <span class="inlinecode"><span class="id" type="var">aevalR</span></span>.  We'll write <span class="inlinecode"><span class="id" type="var">e</span></span>
    <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span> to mean that arithmetic expression <span class="inlinecode"><span class="id" type="var">e</span></span> evaluates to value
    <span class="inlinecode"><span class="id" type="var">n</span></span>.  (This notation is one place where the limitation to ascii
    symbols becomes a little bothersome.  The standard notation for
    the evaluation relation is a double down-arrow.  We'll typeset it
    like this in the HTML version of the notes and use a double
    vertical bar as the closest approximation in ascii .v files.)  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "e '<span style="font-family: arial;">&dArr;</span>' n" := (<a class="idref" href="Imp.html#AExp.aevalR_first_try.aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e</span> <span class="id" type="var">n</span>) : <span class="id" type="var">type_scope</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <a class="idref" href="Imp.html#aevalR_first_try"><span class="id" type="module">aevalR_first_try</span></a>.<br/>

<br/>
</div>

<div class="doc">
In fact, Coq provides a way to use this notation in the definition
    of <span class="inlinecode"><span class="id" type="var">aevalR</span></span> itself.  This avoids situations where we're working on
    a proof involving statements in the form <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span> but we have to
    refer back to a definition written using the form <span class="inlinecode"><span class="id" type="var">aevalR</span></span> <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span>.

<div class="paragraph"> </div>

    We do this by first "reserving" the notation, then giving the
    definition together with a declaration of what the notation
    means. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "e '<span style="font-family: arial;">&dArr;</span>' n" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 50, <span class="id" type="var">left</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <a name="AExp.aevalR"><span class="id" type="inductive">aevalR</span></a> : <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="inductive">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="AExp.E_ANum"><span class="id" type="constructor">E_ANum</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">n</span>:<span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#AExp.ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">n</span>) <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <a name="AExp.E_APlus"><span class="id" type="constructor">E_APlus</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span> : <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">e1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n1</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">e2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n2</span>) <span style="font-family: arial;">&rarr;</span> (<a class="idref" href="Imp.html#AExp.APlus"><span class="id" type="constructor">APlus</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">n1</span> + <span class="id" type="var">n2</span>) <br/>
&nbsp;&nbsp;| <a name="AExp.E_AMinus"><span class="id" type="constructor">E_AMinus</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span> : <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">e1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n1</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">e2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n2</span>) <span style="font-family: arial;">&rarr;</span> (<a class="idref" href="Imp.html#AExp.AMinus"><span class="id" type="constructor">AMinus</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">n1</span> - <span class="id" type="var">n2</span>) <br/>
&nbsp;&nbsp;| <a name="AExp.E_AMult"><span class="id" type="constructor">E_AMult</span></a> :  <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <a class="idref" href="Imp.html#AExp.aexp"><span class="id" type="inductive">aexp</span></a>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span> : <span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">e1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n1</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">e2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n2</span>) <span style="font-family: arial;">&rarr;</span> (<a class="idref" href="Imp.html#AExp.AMult"><span class="id" type="constructor">AMult</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">n1</span> * <span class="id" type="var">n2</span>)<br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "e '<span style="font-family: arial;">&dArr;</span>' n" := (<a class="idref" href="Imp.html#aevalR"><span class="id" type="inductive">aevalR</span></a> <span class="id" type="var">e</span> <span class="id" type="var">n</span>) : <span class="id" type="var">type_scope</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "aevalR_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_ANum" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_APlus"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_AMinus" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_AMult" ].<br/>

<br/>
</div>

<div class="doc">
It is straightforward to prove that the relational and functional
    definitions of evaluation agree on all possible arithmetic
    expressions... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="AExp.aeval_iff_aevalR"><span class="id" type="lemma">aeval_iff_aevalR</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">a</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n</span>) <span style="font-family: arial;">&harr;</span> <a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a</span> = <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;<span class="id" type="var">Case</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">aevalR_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>) <span class="id" type="var">SCase</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_ANum".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_AMinus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_AMult".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;<span class="id" type="var">Case</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>) <span class="id" type="var">SCase</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ANum".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#AExp.E_ANum"><span class="id" type="constructor">E_ANum</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#AExp.E_APlus"><span class="id" type="constructor">E_APlus</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "AMinus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#AExp.E_AMinus"><span class="id" type="constructor">E_AMinus</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "AMult".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#AExp.E_AMult"><span class="id" type="constructor">E_AMult</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
A shorter proof making more aggressive use of tacticals: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="AExp.aeval_iff_aevalR'"><span class="id" type="lemma">aeval_iff_aevalR'</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">a</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n</span>) <span style="font-family: arial;">&harr;</span> <a class="idref" href="Imp.html#AExp.aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">a</span> = <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="var">constructor</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab300"></a><h4 class="section">Exercise: 2 stars, optional (bevalR)</h4>
 Write a relation <span class="inlinecode"><span class="id" type="var">bevalR</span></span> in the same style as
    <span class="inlinecode"><span class="id" type="var">aevalR</span></span>, and prove that it is equivalent to <span class="inlinecode"><span class="id" type="var">beval</span></span>.
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;<br/>
Inductive&nbsp;bevalR:<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
<span class="comment">(**&nbsp;<span class="inlinecode"></span>&nbsp;*)</span><br/>
*)</span><br/>

<br/>
</div>

<div class="doc">
For the definitions of evaluation for arithmetic and boolean
    expressions, the choice of whether to use functional or relational
    definitions is mainly a matter of taste.  In general, Coq has
    somewhat better support for working with relations; in particular,
    we can more readily do induction over them.  On the other hand, in
    some sense function definitions carry more information, because
    functions are necessarily deterministic and defined on all
    arguments; for a relation we have to show these properties
    explicitly if we need them.

<div class="paragraph"> </div>

    However, there are circumstances where relational definitions of
    evaluation are greatly preferable to functional ones, as we'll see
    shortly. 
<div class="paragraph"> </div>

<a name="lab301"></a><h2 class="section">Inference Rule Notation</h2>

<div class="paragraph"> </div>

 In informal discussions, it is convenient write the rules for
    <span class="inlinecode"><span class="id" type="var">aevalR</span></span> and similar relations in a more readable "graphical" form
    called <i>inference rules</i>, where the premises above the line allow
    you to derive the conclusion below the line.  For example, the
    constructor <span class="inlinecode"><span class="id" type="var">E_APlus</span></span>...

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">E_APlus</span>&nbsp;:&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;(<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>:&nbsp;<span class="id" type="var">aexp</span>)&nbsp;(<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>:&nbsp;<span class="id" type="var">nat</span>),&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aevalR</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aevalR</span>&nbsp;<span class="id" type="var">e2</span>&nbsp;<span class="id" type="var">n2</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aevalR</span>&nbsp;(<span class="id" type="var">APlus</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>)&nbsp;(<span class="id" type="var">n1</span>&nbsp;+&nbsp;<span class="id" type="var">n2</span>)
<div class="paragraph"> </div>

</div>
    ...would be written like this as an inference rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">e1&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n2</td>
  <td class="infrulenamecol" rowspan="3">
    (E_APlus) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">APlus&nbsp;e1&nbsp;e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1+n2</td>
  <td></td>
</td>
</table></center>    Formally, there is nothing very deep about inference rules: they
    are just implications.  You can read the rule name on the right as
    the name of the constructor and read each of the linebreaks
    between the premises above the line and the line itself as <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span>.
    All the variables mentioned in the rule (<span class="inlinecode"><span class="id" type="var">e1</span></span>, <span class="inlinecode"><span class="id" type="var">n1</span></span>, etc.) are
    implicitly bound by universal quantifiers at the beginning.  The
    whole collection of rules is understood as being wrapped in an
    <span class="inlinecode"><span class="id" type="keyword">Inductive</span></span> declaration (this is either left completely implicit
    or else indicated informally by saying something like "Let
    <span class="inlinecode"><span class="id" type="var">aevalR</span></span> be the smallest relation closed under the following
    rules...").

<div class="paragraph"> </div>

    For example, <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> is the smallest relation closed under these
    rules:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (E_ANum) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">ANum&nbsp;n&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">e1&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n2</td>
  <td class="infrulenamecol" rowspan="3">
    (E_APlus) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">APlus&nbsp;e1&nbsp;e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1+n2</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">e1&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n2</td>
  <td class="infrulenamecol" rowspan="3">
    (E_AMinus) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">AMinus&nbsp;e1&nbsp;e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1-n2</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">e1&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n2</td>
  <td class="infrulenamecol" rowspan="3">
    (E_AMult) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">AMult&nbsp;e1&nbsp;e2&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;n1*n2</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <a class="idref" href="Imp.html#"><span class="id" type="module">AExp</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab302"></a><h1 class="section">Expressions With Variables</h1>

<div class="paragraph"> </div>

 Now let's turn our attention back to defining Imp.  The next thing
    we need to do is to enrich our arithmetic and boolean expressions
    with variables.  To keep things simple, we'll assume that all
    variables are global and that they only hold numbers. 
<div class="paragraph"> </div>

<a name="lab303"></a><h2 class="section">Identifiers</h2>

<div class="paragraph"> </div>

 To begin, we'll need to formalize <i>identifiers</i>, such as program
    variables.  We could use strings for this, or (in a real compiler)
    some kind of fancier structures like pointers into a symbol table.
    But for simplicity let's just use natural numbers as identifiers.

<div class="paragraph"> </div>

    (We hide this section in a module because these definitions are
    actually in <span class="inlinecode"><span class="id" type="var">SfLib.v</span></span>, but we want to repeat them here so that we
    can explain them.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <a name="Id"><span class="id" type="module">Id</span></a>.<br/>

<br/>
</div>

<div class="doc">
We define a new inductive datatype <span class="inlinecode"><span class="id" type="var">Id</span></span> so that we won't confuse
    identifiers and numbers. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="Id.id"><span class="id" type="inductive">id</span></a> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;<a name="Id.Id"><span class="id" type="constructor">Id</span></a> : <span class="id" type="inductive">nat</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#id"><span class="id" type="inductive">id</span></a>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">X1</span> <span class="id" type="var">X2</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">X1</span>, <span class="id" type="var">X2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#Id.Id"><span class="id" type="constructor">Id</span></a> <span class="id" type="var">n1</span>, <a class="idref" href="Imp.html#Id.Id"><span class="id" type="constructor">Id</span></a> <span class="id" type="var">n2</span>) =&gt; <span class="id" type="definition">beq_nat</span> <span class="id" type="var">n1</span> <span class="id" type="var">n2</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Now, having "wrapped" numbers as identifiers in this way, it
    is convenient to recapitulate a few properties of numbers as
    analogous properties of identifiers, so that we can work with
    identifiers in definitions and proofs abstractly, without
    unwrapping them to expose the underlying numbers.  Since all we
    need to know about identifiers is whether they are the same or
    different, just a few basic facts are all we need. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="Id.beq_id_refl"><span class="id" type="lemma">beq_id_refl</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">X</span>,<br/>
&nbsp;&nbsp;<span class="id" type="constructor">true</span> = <a class="idref" href="Imp.html#Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">X</span> <span class="id" type="var">X</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">X</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="lemma">beq_nat_refl</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab304"></a><h4 class="section">Exercise: 1 star, optional (beq_id_eq)</h4>
 For this and the following exercises, do not use induction, but
    rather apply similar results already proved for natural numbers.
    Some of the tactics mentioned above may prove useful. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="Id.beq_id_eq"><span class="id" type="lemma">beq_id_eq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="constructor">true</span> = <a class="idref" href="Imp.html#Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">i1</span> = <span class="id" type="var">i2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab305"></a><h4 class="section">Exercise: 1 star, optional (beq_id_false_not_eq)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="Id.beq_id_false_not_eq"><span class="id" type="lemma">beq_id_false_not_eq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">i1</span> &lt;&gt; <span class="id" type="var">i2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab306"></a><h4 class="section">Exercise: 1 star, optional (not_eq_beq_id_false)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="Id.not_eq_beq_id_false"><span class="id" type="lemma">not_eq_beq_id_false</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">i1</span> &lt;&gt; <span class="id" type="var">i2</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span> = <span class="id" type="constructor">false</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab307"></a><h4 class="section">Exercise: 1 star, optional (beq_id_sym)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="Id.beq_id_sym"><span class="id" type="lemma">beq_id_sym</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span> = <a class="idref" href="Imp.html#Id.beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">i2</span> <span class="id" type="var">i1</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <a class="idref" href="Imp.html#"><span class="id" type="module">Id</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab308"></a><h2 class="section">States</h2>

<div class="paragraph"> </div>

 A <i>state</i> represents the current values of all the variables at
    some point in the execution of a program.  For simplicity (to avoid dealing with partial functions), we
    let the state be defined for <i>all</i> variables, even though any
    given program is only going tomention a finite number of them. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="state"><span class="id" type="definition">state</span></a> := <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="inductive">nat</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="empty_state"><span class="id" type="definition">empty_state</span></a> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; 0.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="update"><span class="id" type="definition">update</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">X</span>:<a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a>) (<span class="id" type="var">n</span> : <span class="id" type="inductive">nat</span>) : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">X'</span> =&gt; <span class="id" type="keyword">if</span> <a class="idref" href="SfLib.html#beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">X</span> <span class="id" type="var">X'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">n</span> <span class="id" type="keyword">else</span> <span class="id" type="var">st</span> <span class="id" type="var">X'</span>.<br/>

<br/>
</div>

<div class="doc">
We'll need a few simple properties of <span class="inlinecode"><span class="id" type="var">update</span></span>. 
<div class="paragraph"> </div>

<a name="lab309"></a><h4 class="section">Exercise: 2 stars, optional (update_eq)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="update_eq"><span class="id" type="lemma">update_eq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">n</span> <span class="id" type="var">X</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span>) <span class="id" type="var">X</span> = <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab310"></a><h4 class="section">Exercise: 2 stars, optional (update_neq)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="update_neq"><span class="id" type="lemma">update_neq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">V2</span> <span class="id" type="var">V1</span> <span class="id" type="var">n</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SfLib.html#beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">V2</span> <span class="id" type="var">V1</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">V2</span> <span class="id" type="var">n</span>) <span class="id" type="var">V1</span> = (<span class="id" type="var">st</span> <span class="id" type="var">V1</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab311"></a><h4 class="section">Exercise: 2 stars, optional (update_example)</h4>
 Before starting to play with tactics, make sure you understand
    exactly what the theorem is saying! 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="update_example"><span class="id" type="lemma">update_example</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">n</span>:<span class="id" type="inductive">nat</span>), <br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> (<a class="idref" href="SfLib.html#Id"><span class="id" type="constructor">Id</span></a> 2) <span class="id" type="var">n</span>) (<a class="idref" href="SfLib.html#Id"><span class="id" type="constructor">Id</span></a> 3) = 0.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab312"></a><h4 class="section">Exercise: 2 stars (update_shadow)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="update_shadow"><span class="id" type="lemma">update_shadow</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x1</span> <span class="id" type="var">x2</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> (<span class="id" type="var">f</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>),<br/>
&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a>  (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">f</span> <span class="id" type="var">k2</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k2</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k1</span> = (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">f</span> <span class="id" type="var">k2</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k1</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab313"></a><h4 class="section">Exercise: 2 stars, optional (update_same)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="update_same"><span class="id" type="lemma">update_same</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x1</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> (<span class="id" type="var">f</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>),<br/>
&nbsp;&nbsp;<span class="id" type="var">f</span> <span class="id" type="var">k1</span> = <span class="id" type="var">x1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">f</span> <span class="id" type="var">k1</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k2</span> = <span class="id" type="var">f</span> <span class="id" type="var">k2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab314"></a><h4 class="section">Exercise: 2 stars, optional (update_permute)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="update_permute"><span class="id" type="lemma">update_permute</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">x1</span> <span class="id" type="var">x2</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">k3</span> <span class="id" type="var">f</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SfLib.html#beq_id"><span class="id" type="definition">beq_id</span></a> <span class="id" type="var">k2</span> <span class="id" type="var">k1</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">f</span> <span class="id" type="var">k2</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k1</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k3</span> = (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">f</span> <span class="id" type="var">k1</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k2</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k3</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab315"></a><h2 class="section">Syntax</h2>

<div class="paragraph"> </div>

 We can add variables to the arithmetic expressions we had before by
    simply adding one more constructor: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="aexp"><span class="id" type="inductive">aexp</span></a> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <a name="ANum"><span class="id" type="constructor">ANum</span></a> : <span class="id" type="inductive">nat</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a><br/>
&nbsp;&nbsp;| <a name="AId"><span class="id" type="constructor">AId</span></a> : <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a>                <span class="comment">(*&nbsp;&lt;-----&nbsp;NEW&nbsp;*)</span><br/>
&nbsp;&nbsp;| <a name="APlus"><span class="id" type="constructor">APlus</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a><br/>
&nbsp;&nbsp;| <a name="AMinus"><span class="id" type="constructor">AMinus</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a><br/>
&nbsp;&nbsp;| <a name="AMult"><span class="id" type="constructor">AMult</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "aexp_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ANum" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AId" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "APlus"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMinus" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMult" ].<br/>

<br/>
</div>

<div class="doc">
Shorthands for variables: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="X"><span class="id" type="definition">X</span></a> : <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> := <a class="idref" href="SfLib.html#Id"><span class="id" type="constructor">Id</span></a> 0.<br/>
<span class="id" type="keyword">Definition</span> <a name="Y"><span class="id" type="definition">Y</span></a> : <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> := <a class="idref" href="SfLib.html#Id"><span class="id" type="constructor">Id</span></a> 1.<br/>
<span class="id" type="keyword">Definition</span> <a name="Z"><span class="id" type="definition">Z</span></a> : <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> := <a class="idref" href="SfLib.html#Id"><span class="id" type="constructor">Id</span></a> 2.<br/>

<br/>
</div>

<div class="doc">
(This convention for naming program variables (<span class="inlinecode"><span class="id" type="var">X</span></span>, <span class="inlinecode"><span class="id" type="var">Y</span></span>,
    <span class="inlinecode"><span class="id" type="var">Z</span></span>) clashes a bit with our earlier use of uppercase letters for
    types.  Since we're not using polymorphism heavily in this part of
    the course, this overloading should not cause confusion.) 
<div class="paragraph"> </div>

 The definition of <span class="inlinecode"><span class="id" type="var">bexp</span></span>s is the same as before (using the new
    <span class="inlinecode"><span class="id" type="var">aexp</span></span>s): 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="bexp"><span class="id" type="inductive">bexp</span></a> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <a name="BTrue"><span class="id" type="constructor">BTrue</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="BFalse"><span class="id" type="constructor">BFalse</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="BEq"><span class="id" type="constructor">BEq</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="BLe"><span class="id" type="constructor">BLe</span></a> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="BNot"><span class="id" type="constructor">BNot</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a><br/>
&nbsp;&nbsp;| <a name="BAnd"><span class="id" type="constructor">BAnd</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "bexp_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BFalse" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BEq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BLe" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BNot" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BAnd" ].<br/>

<br/>
</div>

<div class="doc">
<a name="lab316"></a><h2 class="section">Evaluation</h2>

<div class="paragraph"> </div>

 The arith and boolean evaluators are extended to handle
    variables in the obvious way: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="aeval"><span class="id" type="definition">aeval</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a>) : <span class="id" type="inductive">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <span class="id" type="var">X</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span>                                        <span class="comment">(*&nbsp;&lt;-----&nbsp;NEW&nbsp;*)</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#APlus"><span class="id" type="constructor">APlus</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) + (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AMinus"><span class="id" type="constructor">AMinus</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  =&gt; (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) - (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#AMult"><span class="id" type="constructor">AMult</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) * (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="beval"><span class="id" type="definition">beval</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a>) : <span class="id" type="inductive">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#BTrue"><span class="id" type="constructor">BTrue</span></a>       =&gt; <span class="id" type="constructor">true</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#BFalse"><span class="id" type="constructor">BFalse</span></a>      =&gt; <span class="id" type="constructor">false</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#BEq"><span class="id" type="constructor">BEq</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <span class="id" type="definition">beq_nat</span> (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#BLe"><span class="id" type="constructor">BLe</span></a> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <a class="idref" href="SfLib.html#ble_nat"><span class="id" type="definition">ble_nat</span></a> (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#BNot"><span class="id" type="constructor">BNot</span></a> <span class="id" type="var">b1</span>     =&gt; <span class="id" type="definition">negb</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="Imp.html#BAnd"><span class="id" type="constructor">BAnd</span></a> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span>  =&gt; <span class="id" type="definition">andb</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>) (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <a name="aexp1"><span class="id" type="definition">aexp1</span></a> : <br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> 5) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 3) (<a class="idref" href="Imp.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 2))) <br/>
&nbsp;&nbsp;= 13.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <a name="bexp1"><span class="id" type="definition">bexp1</span></a> :<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> 5) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#BAnd"><span class="id" type="constructor">BAnd</span></a> <a class="idref" href="Imp.html#BTrue"><span class="id" type="constructor">BTrue</span></a> (<a class="idref" href="Imp.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="Imp.html#BLe"><span class="id" type="constructor">BLe</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 4))))<br/>
&nbsp;&nbsp;= <span class="id" type="constructor">true</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab317"></a><h1 class="section">Commands</h1>

<div class="paragraph"> </div>

 Now we are ready define the syntax and behavior of Imp
    <i>commands</i> (or <i>statements</i>). 
<div class="paragraph"> </div>

<a name="lab318"></a><h2 class="section">Syntax</h2>

<div class="paragraph"> </div>

 Informally, commands are described by the following BNF
    grammar: 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">com</span>&nbsp;::=&nbsp;'<span class="id" type="var">SKIP'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">X</span>&nbsp;'::='&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">com</span>&nbsp;';'&nbsp;<span class="id" type="var">com</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;'<span class="id" type="var">WHILE'</span>&nbsp;<span class="id" type="var">bexp</span>&nbsp;'<span class="id" type="var">DO'</span>&nbsp;<span class="id" type="var">com</span>&nbsp;'<span class="id" type="var">END'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;'<span class="id" type="var">IFB'</span>&nbsp;<span class="id" type="var">bexp</span>&nbsp;'<span class="id" type="var">THEN'</span>&nbsp;<span class="id" type="var">com</span>&nbsp;'<span class="id" type="var">ELSE'</span>&nbsp;<span class="id" type="var">com</span>&nbsp;'<span class="id" type="var">FI'</span>
<div class="paragraph"> </div>

</div>
    For example, here's the factorial function in Imp. 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">not</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;0)&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>
   When this command terminates, the variable <span class="inlinecode"><span class="id" type="var">Y</span></span> will contain the
   factorial of the variable <span class="inlinecode"><span class="id" type="var">X</span></span>.

<div class="paragraph"> </div>

 Here is the formal definition of the syntax of commands: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="com"><span class="id" type="inductive">com</span></a> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="CSkip"><span class="id" type="constructor">CSkip</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CAss"><span class="id" type="constructor">CAss</span></a> : <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CSeq"><span class="id" type="constructor">CSeq</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CIf"><span class="id" type="constructor">CIf</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CWhile"><span class="id" type="constructor">CWhile</span></a> : <a class="idref" href="Imp.html#bexp"><span class="id" type="inductive">bexp</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "com_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "SKIP" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "::=" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> ";"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "IFB" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "WHILE" ].<br/>

<br/>
</div>

<div class="doc">
As usual, we can use a few <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> declarations to make things
    more readable.  However, we need to be a bit careful to avoid
    conflicts with Coq's built-in notations, so we'll keep this
    light &mdash; in particular, we won't introduce any notations for
    <span class="inlinecode"><span class="id" type="var">aexps</span></span> and <span class="inlinecode"><span class="id" type="var">bexps</span></span> to avoid confusion with the numerical and
    boolean operators we've already defined.  (We use the keyword
    <span class="inlinecode"><span class="id" type="var">IFB</span></span> for conditionals instead of the usual <span class="inlinecode"><span class="id" type="var">IF</span></span> for similar
    reasons.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" := <br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#CSkip"><span class="id" type="constructor">CSkip</span></a>.<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#CAss"><span class="id" type="constructor">CAss</span></a> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "c1 ; c2" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#CSeq"><span class="id" type="constructor">CSeq</span></a> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#CWhile"><span class="id" type="constructor">CWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" := <br/>
&nbsp;&nbsp;(<a class="idref" href="Imp.html#CIf"><span class="id" type="constructor">CIf</span></a> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
</div>

<div class="doc">
For example, here is the factorial function again, written as a
    formal definition to Coq: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="fact_in_coq"><span class="id" type="definition">fact_in_coq</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="Imp.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="Imp.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="Imp.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab319"></a><h2 class="section">Examples</h2>

<div class="paragraph"> </div>

 Here are some more examples... 
<div class="paragraph"> </div>

 Assignment: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="plus2"><span class="id" type="definition">plus2</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> ::= (<a class="idref" href="Imp.html#APlus"><span class="id" type="constructor">APlus</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 2)).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="XtimesYinZ"><span class="id" type="definition">XtimesYinZ</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= (<a class="idref" href="Imp.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a>)).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="subtract_slowly_body"><span class="id" type="definition">subtract_slowly_body</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) ;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="Imp.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1).<br/>

<br/>
</div>

<div class="doc">
Loops: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="subtract_slowly"><span class="id" type="definition">subtract_slowly</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="Imp.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="Imp.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#subtract_slowly_body"><span class="id" type="definition">subtract_slowly_body</span></a><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="subtract_3_from_5_slowly"><span class="id" type="definition">subtract_3_from_5_slowly</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 3 ;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 5 ;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#subtract_slowly"><span class="id" type="definition">subtract_slowly</span></a>.<br/>

<br/>
</div>

<div class="doc">
An infinite loop: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="loop"><span class="id" type="definition">loop</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="Imp.html#BTrue"><span class="id" type="constructor">BTrue</span></a> <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
Factorial again (broken up into smaller pieces this time, for
    convenience when we come back to proving things about it
    later).  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="fact_body"><span class="id" type="definition">fact_body</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="Imp.html#AMult"><span class="id" type="constructor">AMult</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a>) (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) ;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#AMinus"><span class="id" type="constructor">AMinus</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="fact_loop"><span class="id" type="definition">fact_loop</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <a class="idref" href="Imp.html#BNot"><span class="id" type="constructor">BNot</span></a> (<a class="idref" href="Imp.html#BEq"><span class="id" type="constructor">BEq</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_body"><span class="id" type="definition">fact_body</span></a><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="fact_com"><span class="id" type="definition">fact_com</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> ;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1 ;<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_loop"><span class="id" type="definition">fact_loop</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab320"></a><h1 class="section">Evaluation</h1>

<div class="paragraph"> </div>

 Next we need to define what it means to evaluate an Imp command.
    <span class="inlinecode"><span class="id" type="var">WHILE</span></span> loops actually make this a bit tricky... 
<div class="paragraph"> </div>

<a name="lab321"></a><h2 class="section">Evaluation Function</h2>

<div class="paragraph"> </div>

 Here's a first try at an evaluation function for commands,
    omitting <span class="inlinecode"><span class="id" type="var">WHILE</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="ceval_step1"><span class="id" type="definition">ceval_step1</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">c</span> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>) : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">SKIP</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">l</span> ::= <span class="id" type="var">a1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">l</span> (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">st'</span> := <a class="idref" href="Imp.html#ceval_step1"><span class="id" type="definition">ceval_step1</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step1"><span class="id" type="definition">ceval_step1</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <a class="idref" href="Imp.html#ceval_step1"><span class="id" type="definition">ceval_step1</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <a class="idref" href="Imp.html#ceval_step1"><span class="id" type="definition">ceval_step1</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span>  <span class="comment">(*&nbsp;bogus&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Second try, using an extra numeric argument as a "step index" to
    ensure that evaluation always terminates. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="ceval_step2"><span class="id" type="definition">ceval_step2</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">c</span> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>) (<span class="id" type="var">i</span> : <span class="id" type="inductive">nat</span>) : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" type="constructor">O</span> =&gt; <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">S</span> <span class="id" type="var">i'</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">SKIP</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">l</span> ::= <span class="id" type="var">a1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">l</span> (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">st'</span> := <a class="idref" href="Imp.html#ceval_step2"><span class="id" type="definition">ceval_step2</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step2"><span class="id" type="definition">ceval_step2</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span> <span class="id" type="var">i'</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <a class="idref" href="Imp.html#ceval_step2"><span class="id" type="definition">ceval_step2</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <a class="idref" href="Imp.html#ceval_step2"><span class="id" type="definition">ceval_step2</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c2</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="keyword">let</span> <span class="id" type="var">st'</span> := <a class="idref" href="Imp.html#ceval_step2"><span class="id" type="definition">ceval_step2</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step2"><span class="id" type="definition">ceval_step2</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<i>Note</i>: It is tempting to think that the index <span class="inlinecode"><span class="id" type="var">i</span></span> here is
    counting the "number of steps of evaluation."  But if you look
    closely you'll see that this is not the case: for example, in the
    rule for sequencing, the same <span class="inlinecode"><span class="id" type="var">i</span></span> is passed to both recursive
    calls.  Understanding the exact way that <span class="inlinecode"><span class="id" type="var">i</span></span> is treated will be
    important in the proof of <span class="inlinecode"><span class="id" type="var">ceval__ceval_step</span></span>, which is given as
    an exercise below. 
<div class="paragraph"> </div>

 Third try, returning an <span class="inlinecode"><span class="id" type="var">option</span></span> <span class="inlinecode"><span class="id" type="var">state</span></span> instead of just a <span class="inlinecode"><span class="id" type="var">state</span></span>
    so that we can distinguish between normal and abnormal
    termination. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="ceval_step3"><span class="id" type="definition">ceval_step3</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">c</span> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>) (<span class="id" type="var">i</span> : <span class="id" type="inductive">nat</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="inductive">option</span> <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" type="constructor">O</span> =&gt; <span class="id" type="constructor">None</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">S</span> <span class="id" type="var">i'</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">SKIP</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="constructor">Some</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">l</span> ::= <span class="id" type="var">a1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="constructor">Some</span> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">l</span> (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<a class="idref" href="Imp.html#ceval_step3"><span class="id" type="definition">ceval_step3</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span> =&gt; <a class="idref" href="Imp.html#ceval_step3"><span class="id" type="definition">ceval_step3</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="constructor">None</span> =&gt; <span class="id" type="constructor">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <a class="idref" href="Imp.html#ceval_step3"><span class="id" type="definition">ceval_step3</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <a class="idref" href="Imp.html#ceval_step3"><span class="id" type="definition">ceval_step3</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c2</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>)           <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="keyword">match</span> (<a class="idref" href="Imp.html#ceval_step3"><span class="id" type="definition">ceval_step3</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span> =&gt; <a class="idref" href="Imp.html#ceval_step3"><span class="id" type="definition">ceval_step3</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="constructor">None</span> =&gt; <span class="id" type="constructor">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="constructor">Some</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
We can improve the readability of this definition by introducing a
    bit of auxiliary notation to hide the "plumbing" involved in
    repeatedly matching against optional states. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "'LETOPT' x &lt;== e1 'IN' e2" <br/>
&nbsp;&nbsp;&nbsp;:= (<span class="id" type="keyword">match</span> <span class="id" type="var">e1</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="constructor">Some</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">e2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="constructor">None</span> =&gt; <span class="id" type="constructor">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">right</span> <span class="id" type="var">associativity</span>, <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="ceval_step"><span class="id" type="definition">ceval_step</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">c</span> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>) (<span class="id" type="var">i</span> : <span class="id" type="inductive">nat</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="inductive">option</span> <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" type="constructor">O</span> =&gt; <span class="id" type="constructor">None</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">S</span> <span class="id" type="var">i'</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">SKIP</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="constructor">Some</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">l</span> ::= <span class="id" type="var">a1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="constructor">Some</span> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">l</span> (<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">LETOPT</span> <span class="id" type="var">st'</span> &lt;== <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <span class="id" type="var">IN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c2</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>)           <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">LETOPT</span> <span class="id" type="var">st'</span> &lt;== <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span> <span class="id" type="var">IN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">c</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="constructor">Some</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <a name="test_ceval"><span class="id" type="definition">test_ceval</span></a> (<span class="id" type="var">st</span>:<a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">c</span>:<a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>) := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> 500 <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">None</span>    =&gt; <span class="id" type="constructor">None</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">Some</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="constructor">Some</span> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>, <span class="id" type="var">st</span> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a>, <span class="id" type="var">st</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="comment">(*<br/>
Eval&nbsp;compute&nbsp;in&nbsp;<br/>
&nbsp;&nbsp;(test_ceval&nbsp;empty_state&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(X&nbsp;::=&nbsp;ANum&nbsp;2;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IFB&nbsp;BLe&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;THEN&nbsp;Y&nbsp;::=&nbsp;ANum&nbsp;3&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;Z&nbsp;::=&nbsp;ANum&nbsp;4<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FI)).<br/>
====&gt;<br/>
&nbsp;&nbsp;&nbsp;Some&nbsp;(2,&nbsp;0,&nbsp;4)<br/>
*)</span><br/>

<br/>
</div>

<div class="doc">
<a name="lab322"></a><h4 class="section">Exercise: 2 stars, recommended (pup_to_n)</h4>
 Write an Imp program that sums the numbers from <span class="inlinecode">1</span> to
   <span class="inlinecode"><span class="id" type="var">X</span></span> (inclusive: <span class="inlinecode">1</span> <span class="inlinecode">+</span> <span class="inlinecode">2</span> <span class="inlinecode">+</span> <span class="inlinecode">...</span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">X</span></span>) in the variable <span class="inlinecode"><span class="id" type="var">Y</span></span>.  Make sure
   your solution satisfies the test that follows. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="pup_to_n"><span class="id" type="definition">pup_to_n</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> := <br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <a class="idref" href="SfLib.html#admit"><span class="id" type="axiom">admit</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;<br/>
Example&nbsp;pup_to_n_1&nbsp;:&nbsp;<br/>
&nbsp;&nbsp;test_ceval&nbsp;(update&nbsp;empty_state&nbsp;X&nbsp;5)&nbsp;pup_to_n<br/>
&nbsp;&nbsp;=&nbsp;Some&nbsp;(0,&nbsp;15,&nbsp;0).<br/>
Proof.&nbsp;reflexivity.&nbsp;Qed.<br/>
*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab323"></a><h4 class="section">Exercise: 2 stars, optional (peven)</h4>
 Write a <span class="inlinecode"><span class="id" type="var">While</span></span> program that sets <span class="inlinecode"><span class="id" type="var">Z</span></span> to <span class="inlinecode">0</span> if <span class="inlinecode"><span class="id" type="var">X</span></span> is even and
    sets <span class="inlinecode"><span class="id" type="var">Z</span></span> to <span class="inlinecode">1</span> otherwise.  Use <span class="inlinecode"><span class="id" type="var">ceval_test</span></span> to test your
    program. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab324"></a><h2 class="section">Evaluation as a Relation</h2>

<div class="paragraph"> </div>

 Here's a better way: define <span class="inlinecode"><span class="id" type="var">ceval</span></span> as a <i>relation</i> rather than a
    <i>function</i> &mdash; i.e., define it in <span class="inlinecode"><span class="id" type="keyword">Prop</span></span> instead of <span class="inlinecode"><span class="id" type="keyword">Type</span></span>, as we
    did for <span class="inlinecode"><span class="id" type="var">aevalR</span></span> and <span class="inlinecode"><span class="id" type="var">bevalR</span></span> above.

<div class="paragraph"> </div>

    This is an important change.  Besides freeing us from the
    silliness of passing around step indices all over the place, it
    gives us a lot more flexibility in the definition.  For example,
    if we added concurrency features to the language, we'd want the
    definition of evaluation to be non-deterministic &mdash; i.e., not only
    would it not be total, it would not even be a partial function! 
<div class="paragraph"> </div>

 We'll use the notation <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> for our <span class="inlinecode"><span class="id" type="var">ceval</span></span> relation,
    that is <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> means that executing program <span class="inlinecode"><span class="id" type="var">c</span></span> in a
    starting state <span class="inlinecode"><span class="id" type="var">st</span></span> results in an ending state <span class="inlinecode"><span class="id" type="var">st'</span></span>.  This can be
    pronounced "<span class="inlinecode"><span class="id" type="var">c</span></span> takes state <span class="inlinecode"><span class="id" type="var">st</span></span> to <span class="inlinecode"><span class="id" type="var">st'</span></span>". 
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (E_Skip) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">SKIP&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">aeval&nbsp;st&nbsp;a1&nbsp;=&nbsp;n</td>
  <td class="infrulenamecol" rowspan="3">
    (E_Ass) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">l&nbsp;:=&nbsp;a1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;(update&nbsp;st&nbsp;l&nbsp;n)</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">c1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c2&nbsp;/&nbsp;st'&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td class="infrulenamecol" rowspan="3">
    (E_Seq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">c1;c2&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;true</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td class="infrulenamecol" rowspan="3">
    (E_IfTrue) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">IF&nbsp;b1&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;false</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c2&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td class="infrulenamecol" rowspan="3">
    (E_IfFalse) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">IF&nbsp;b1&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;false</td>
  <td class="infrulenamecol" rowspan="3">
    (E_WhileEnd) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">WHILE&nbsp;b1&nbsp;DO&nbsp;c1&nbsp;END&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;true</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">WHILE&nbsp;b1&nbsp;DO&nbsp;c1&nbsp;END&nbsp;/&nbsp;st'&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td class="infrulenamecol" rowspan="3">
    (E_WhileLoop) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">WHILE&nbsp;b1&nbsp;DO&nbsp;c1&nbsp;END&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td></td>
</td>
</table></center>
<div class="paragraph"> </div>

 Here is the formal definition.  (Make sure you understand
    how it corresponds to the inference rules.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <a name="ceval"><span class="id" type="inductive">ceval</span></a> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="E_Skip"><span class="id" type="constructor">E_Skip</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <a name="E_Ass"><span class="id" type="constructor">E_Ass</span></a>  : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> <span class="id" type="var">n</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span> ::= <span class="id" type="var">a1</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <a name="E_Seq"><span class="id" type="constructor">E_Seq</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span>  <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <a name="E_IfTrue"><span class="id" type="constructor">E_IfTrue</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <a name="E_IfFalse"><span class="id" type="constructor">E_IfFalse</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <a name="E_WhileEnd"><span class="id" type="constructor">E_WhileEnd</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">b1</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <a name="E_WhileLoop"><span class="id" type="constructor">E_WhileLoop</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<a class="idref" href="Imp.html#ceval"><span class="id" type="inductive">ceval</span></a> <span class="id" type="var">c1</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "ceval_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Ass" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Seq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfFalse"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileEnd" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileLoop" ].<br/>

<br/>
</div>

<div class="doc">
The cost of defining evaluation as a relation instead of a
    function is that we now need to construct <i>proofs</i> that some
    program evaluates to some result state, rather than just letting
    Coq's computation mechanism do it for us. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <a name="ceval_example1"><span class="id" type="definition">ceval_example1</span></a>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 2; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <a class="idref" href="Imp.html#BLe"><span class="id" type="constructor">BLe</span></a> (<a class="idref" href="Imp.html#AId"><span class="id" type="constructor">AId</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) (<a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 3 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 4 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>) <br/>
&nbsp;&nbsp;&nbsp;/ <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <br/>
&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&dArr;</span> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> 2) <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> 4).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;must&nbsp;supply&nbsp;the&nbsp;intermediate&nbsp;state&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_Seq"><span class="id" type="constructor">E_Seq</span></a> <span class="id" type="keyword">with</span> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> 2).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "assignment command".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_Ass"><span class="id" type="constructor">E_Ass</span></a>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "if command".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_IfFalse"><span class="id" type="constructor">E_IfFalse</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_Ass"><span class="id" type="constructor">E_Ass</span></a>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab325"></a><h4 class="section">Exercise: 2 stars (ceval_example2)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Example</span> <a name="ceval_example2"><span class="id" type="definition">ceval_example2</span></a>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 0; <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 1; <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> ::= <a class="idref" href="Imp.html#ANum"><span class="id" type="constructor">ANum</span></a> 2) / <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <span style="font-family: arial;">&dArr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> 0) <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> 1) <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> 2).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab326"></a><h2 class="section">Equivalence of Relational and Step-Indexed Evaluation</h2>

<div class="paragraph"> </div>

 As with arithmetic and boolean expressions, we'd hope that
    the two alternative definitions of evaluation actually boil down
    to the same thing.  This section shows that this is the case.
    Make sure you understand the statements of the theorems and can
    follow the structure of the proofs. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="ceval_step__ceval"><span class="id" type="lemma">ceval_step__ceval</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="font-family: arial;">&exist;</span> <span class="id" type="var">i</span>, <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i</span> = <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">i</span> <span class="id" type="var">E</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">c</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">i'</span> ].<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "i = 0 -- contradictory".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "i = S i'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">com_cases</span> (<span class="id" type="tactic">destruct</span> <span class="id" type="var">c</span>) <span class="id" type="var">SCase</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "SKIP". <span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_Skip"><span class="id" type="constructor">E_Skip</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "::=". <span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_Ass"><span class="id" type="constructor">E_Ass</span></a>. <span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> ";".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i'</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">r1</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">r1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "Evaluation of r1 terminates normally".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_Seq"><span class="id" type="constructor">E_Seq</span></a> <span class="id" type="keyword">with</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHi'</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqr1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHi'</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "Otherwise -- contradiction".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "IFB".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">r</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "r = true".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_IfTrue"><span class="id" type="constructor">E_IfTrue</span></a>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqr</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHi'</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "r = false".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_IfFalse"><span class="id" type="constructor">E_IfFalse</span></a>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqr</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHi'</span>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "WHILE". <span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">r</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "r = true".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i'</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">r1</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">r1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSSCase</span> "r1 = Some s".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_WhileLoop"><span class="id" type="constructor">E_WhileLoop</span></a> <span class="id" type="keyword">with</span> <span class="id" type="var">s</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqr</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHi'</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqr1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHi'</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSSCase</span> "r1 = None".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "r = false".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#E_WhileEnd"><span class="id" type="constructor">E_WhileEnd</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqr</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab327"></a><h4 class="section">Exercise: 4 stars (ceval_step__ceval_inf)</h4>
 Write an informal proof of <span class="inlinecode"><span class="id" type="var">ceval_step__ceval</span></span>, following the
    usual template.  (The template for case analysis on an inductively
    defined value should look the same as for induction, except that
    there is no induction hypothesis.)  Make your proof communicate
    the main ideas to a human reader; do not simply transcribe the
    steps of the formal proof.

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
<font size=-2>&#9744;</font>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="ceval_step_more"><span class="id" type="lemma">ceval_step_more</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">i1</span> <span class="id" type="var">i2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">i1</span> &lt;= <span class="id" type="var">i2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i1</span> = <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i2</span> = <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">i1</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">i1'</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">i2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">c</span> <span class="id" type="var">Hle</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "i1 = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "i1 = S i1'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">i2</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">i2'</span>]. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hle</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hle'</span>: <span class="id" type="var">i1'</span> &lt;= <span class="id" type="var">i2'</span>) <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">com_cases</span> (<span class="id" type="tactic">destruct</span> <span class="id" type="var">c</span>) <span class="id" type="var">SCase</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "SKIP".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "::=".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> ";".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">i1'</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">st1'o</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">st1'o</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "st1'o = Some".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqst1'o</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHi1'</span> <span class="id" type="var">i2'</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">Heqst1'o</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqst1'o</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHi1'</span> <span class="id" type="var">i2'</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "st1'o = None".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "IFB".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">bval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">bval</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHi1'</span> <span class="id" type="var">i2'</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "WHILE".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i1'</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">st1'o</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">st1'o</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "st1'o = Some".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqst1'o</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHi1'</span> <span class="id" type="var">i2'</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">Heqst1'o</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Heqst1'o</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHi1'</span> <span class="id" type="var">i2'</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "i1'o = None".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab328"></a><h4 class="section">Exercise: 3 stars, recommended (ceval__ceval_step)</h4>
 Finish the following proof.  You'll need <span class="inlinecode"><span class="id" type="var">ceval_step_more</span></span> in a
    few places, as well as some basic facts about <span class="inlinecode">&lt;=</span> and <span class="inlinecode"><span class="id" type="var">plus</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="ceval__ceval_step"><span class="id" type="lemma">ceval__ceval_step</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span> <span class="id" type="var">i</span>, <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i</span> = <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">ceval_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">Hce</span>) <span class="id" type="var">Case</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="ceval_and_ceval_step_coincide"><span class="id" type="lemma">ceval_and_ceval_step_coincide</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&harr;</span> <span style="font-family: arial;">&exist;</span> <span class="id" type="var">i</span>, <a class="idref" href="Imp.html#ceval_step"><span class="id" type="definition">ceval_step</span></a> <span class="id" type="var">st</span> <span class="id" type="var">c</span> <span class="id" type="var">i</span> = <span class="id" type="constructor">Some</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#ceval__ceval_step"><span class="id" type="axiom">ceval__ceval_step</span></a>. <span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#ceval_step__ceval"><span class="id" type="lemma">ceval_step__ceval</span></a>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab329"></a><h2 class="section">Determinacy of Evaluation</h2>

<div class="paragraph"> </div>

 Changing from a computational to a relational definition of
    evaluation is a good move because it allows us to escape from the
    artificial requirement (imposed by Coq's restrictions on Fixpoint
    definitions) that evaluation should be a total function.  But it
    also raises a question: Is the second definition of evaluation
    actually a partial function?  That is, is it possible that,
    beginning from the same state <span class="inlinecode"><span class="id" type="var">st</span></span>, we could evaluate some command
    <span class="inlinecode"><span class="id" type="var">c</span></span> in different ways to reach two different output states <span class="inlinecode"><span class="id" type="var">st'</span></span>
    and <span class="inlinecode"><span class="id" type="var">st''</span></span>?

<div class="paragraph"> </div>

    In fact, this cannot happen: the evaluation relation <span class="inlinecode"><span class="id" type="var">ceval</span></span> is a
    partial function.  Here's the proof: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="ceval_deterministic"><span class="id" type="lemma">ceval_deterministic</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st1</span> <span class="id" type="var">st2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st1</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st1</span> = <span class="id" type="var">st2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st1</span> <span class="id" type="var">st2</span> <span class="id" type="var">E1</span> <span class="id" type="var">E2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">ceval_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">E1</span>) <span class="id" type="var">Case</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st2</span> <span class="id" type="var">E2</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">E2</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_Skip". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_Ass". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_Seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">st'</span> = <span class="id" type="var">st'0</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">EQ1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "Proof of assertion". <span class="id" type="tactic">apply</span> <span class="id" type="var">IHE1_1</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">st'0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHE1_2</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_IfTrue".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to true".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHE1</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to false (contradiction)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_IfFalse".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to true (contradiction)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to false".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHE1</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileEnd".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to true".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to false (contradiction)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileLoop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to true (contradiction)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H4</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "b1 evaluates to false".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">st'</span> = <span class="id" type="var">st'0</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">EQ1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "Proof of assertion". <span class="id" type="tactic">apply</span> <span class="id" type="var">IHE1_1</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">st'0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHE1_2</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Here's a slicker proof, using the fact that the relational and
    step-indexed definition of evaluation are the same. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="ceval_deterministic'"><span class="id" type="lemma">ceval_deterministic'</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st1</span> <span class="id" type="var">st2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st1</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st1</span> = <span class="id" type="var">st2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st1</span> <span class="id" type="var">st2</span> <span class="id" type="var">He1</span> <span class="id" type="var">He2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#ceval__ceval_step"><span class="id" type="axiom">ceval__ceval_step</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">He1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#ceval__ceval_step"><span class="id" type="axiom">ceval__ceval_step</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">He2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">He1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">i1</span> <span class="id" type="var">E1</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">He2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">i2</span> <span class="id" type="var">E2</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#ceval_step_more"><span class="id" type="lemma">ceval_step_more</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">i2</span> := <span class="id" type="var">i1</span> + <span class="id" type="var">i2</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">E1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#ceval_step_more"><span class="id" type="lemma">ceval_step_more</span></a> <span class="id" type="keyword">with</span> (<span class="id" type="var">i2</span> := <span class="id" type="var">i1</span> + <span class="id" type="var">i2</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">E2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">E1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">E2</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">E2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">omega</span>. <span class="id" type="tactic">omega</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab330"></a><h1 class="section">Reasoning About Programs</h1>

<div class="paragraph"> </div>

 We'll get much deeper into systematic techniques for reasoning
    about programs in Imp in the following chapters, but we can do
    quite a bit just working with the bare definitions.  This section
    explores some examples. 
<div class="paragraph"> </div>

<a name="lab331"></a><h2 class="section">Basic Examples</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="plus2_spec"><span class="id" type="lemma">plus2_spec</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">n</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#plus2"><span class="id" type="definition">plus2</span></a> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">st'</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> = <span class="id" type="var">n</span> + 2.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">n</span> <span class="id" type="var">st'</span> <span class="id" type="var">HX</span> <span class="id" type="var">Heval</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Inverting&nbsp;Heval&nbsp;essentially&nbsp;forces&nbsp;Coq&nbsp;to&nbsp;expand&nbsp;one&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;of&nbsp;the&nbsp;ceval&nbsp;computation&nbsp;-&nbsp;in&nbsp;this&nbsp;case&nbsp;revealing&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;st'&nbsp;must&nbsp;be&nbsp;st&nbsp;extended&nbsp;with&nbsp;the&nbsp;new&nbsp;value&nbsp;of&nbsp;X,&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;since&nbsp;plus2&nbsp;is&nbsp;an&nbsp;assignment&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#update_eq"><span class="id" type="axiom">update_eq</span></a>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab332"></a><h4 class="section">Exercise: 3 stars, recommended (XtimesYinZ_spec)</h4>
 State and prove a specification of the XtimesYinZ Imp program. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab333"></a><h4 class="section">Exercise: 3 stars, recommended (loop_never_stops)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <a name="loop_never_stops"><span class="id" type="lemma">loop_never_stops</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;~(<a class="idref" href="Imp.html#loop"><span class="id" type="definition">loop</span></a> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">contra</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">loop</span> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <a class="idref" href="Imp.html#BTrue"><span class="id" type="constructor">BTrue</span></a> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">loopdef</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Proceed&nbsp;by&nbsp;induction&nbsp;on&nbsp;the&nbsp;assumed&nbsp;derivation&nbsp;showing&nbsp;that<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loopdef&nbsp;terminates.&nbsp;&nbsp;Most&nbsp;of&nbsp;the&nbsp;cases&nbsp;are&nbsp;immediately<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contradictory&nbsp;(and&nbsp;so&nbsp;can&nbsp;be&nbsp;solved&nbsp;in&nbsp;one&nbsp;step&nbsp;with<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="inlinecode"><span class="id" type="tactic">inversion</span></span>).&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="no_whiles"><span class="id" type="definition">no_whiles</span></a> (<span class="id" type="var">c</span> : <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a>) : <span class="id" type="inductive">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">SKIP</span>       =&gt; <span class="id" type="constructor">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ::= <span class="id" type="var">_</span>    =&gt; <span class="id" type="constructor">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>  =&gt; <span class="id" type="definition">andb</span> (<a class="idref" href="Imp.html#no_whiles"><span class="id" type="definition">no_whiles</span></a> <span class="id" type="var">c1</span>) (<a class="idref" href="Imp.html#no_whiles"><span class="id" type="definition">no_whiles</span></a> <span class="id" type="var">c2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">_</span> <span class="id" type="var">THEN</span> <span class="id" type="var">ct</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">cf</span> <span class="id" type="var">FI</span> =&gt; <span class="id" type="definition">andb</span> (<a class="idref" href="Imp.html#no_whiles"><span class="id" type="definition">no_whiles</span></a> <span class="id" type="var">ct</span>) (<a class="idref" href="Imp.html#no_whiles"><span class="id" type="definition">no_whiles</span></a> <span class="id" type="var">cf</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">_</span> <span class="id" type="var">DO</span> <span class="id" type="var">_</span> <span class="id" type="var">END</span>  =&gt; <span class="id" type="constructor">false</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab334"></a><h4 class="section">Exercise: 2 stars, optional (no_whilesR)</h4>
 The <span class="inlinecode"><span class="id" type="var">no_whiles</span></span> property yields <span class="inlinecode"><span class="id" type="var">true</span></span> on just those programs that
    have no while loops.  Using <span class="inlinecode"><span class="id" type="keyword">Inductive</span></span>, write a property
    <span class="inlinecode"><span class="id" type="var">no_whilesR</span></span> such that <span class="inlinecode"><span class="id" type="var">no_whilesR</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> is provable exactly when <span class="inlinecode"><span class="id" type="var">c</span></span>
    is a program with no while loops.  Then prove its equivalence
    with <span class="inlinecode"><span class="id" type="var">no_whiles</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="no_whilesR"><span class="id" type="inductive">no_whilesR</span></a>: <a class="idref" href="Imp.html#com"><span class="id" type="inductive">com</span></a> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> := <br/>
&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
&nbsp;&nbsp;.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="no_whiles_eqv"><span class="id" type="lemma">no_whiles_eqv</span></a>:<br/>
&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span> <span class="id" type="var">c</span>, <a class="idref" href="Imp.html#no_whiles"><span class="id" type="definition">no_whiles</span></a> <span class="id" type="var">c</span> = <span class="id" type="constructor">true</span> <span style="font-family: arial;">&harr;</span> <a class="idref" href="Imp.html#no_whilesR"><span class="id" type="inductive">no_whilesR</span></a> <span class="id" type="var">c</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab335"></a><h4 class="section">Exercise: 4 stars, optional (no_whiles_terminating)</h4>
 Imp programs that don't involve while loops always terminate.
    State and prove a theorem that says this.  (Use either <span class="inlinecode"><span class="id" type="var">no_whiles</span></span> or <span class="inlinecode"><span class="id" type="var">no_whilesR</span></span>, as you prefer.) 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab336"></a><h2 class="section">Proving a Program Correct (Optional)</h2>

<div class="paragraph"> </div>

 Recall the factorial program: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Print</span> <span class="id" type="var">fact_body</span>. <span class="id" type="keyword">Print</span> <span class="id" type="var">fact_loop</span>. <span class="id" type="keyword">Print</span> <span class="id" type="var">fact_com</span>.<br/>

<br/>
</div>

<div class="doc">
Here is an alternative "mathematical" definition of the factorial
    function: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="real_fact"><span class="id" type="definition">real_fact</span></a> (<span class="id" type="var">n</span>:<span class="id" type="inductive">nat</span>) : <span class="id" type="inductive">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">n</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="constructor">O</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="constructor">S</span> <span class="id" type="var">n'</span> =&gt; <span class="id" type="var">n</span> * (<a class="idref" href="Imp.html#real_fact"><span class="id" type="definition">real_fact</span></a> <span class="id" type="var">n'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
We would like to show that they agree &mdash; if we start <span class="inlinecode"><span class="id" type="var">fact_com</span></span> in
    a state where variable <span class="inlinecode"><span class="id" type="var">X</span></span> contains some number <span class="inlinecode"><span class="id" type="var">x</span></span>, then it will
    terminate in a state where variable <span class="inlinecode"><span class="id" type="var">Y</span></span> contains the factorial of
    <span class="inlinecode"><span class="id" type="var">x</span></span>.

<div class="paragraph"> </div>

    To show this, we rely on the critical idea of a <i>loop
    invariant</i>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="fact_invariant"><span class="id" type="definition">fact_invariant</span></a> (<span class="id" type="var">x</span>:<span class="id" type="inductive">nat</span>) (<span class="id" type="var">st</span>:<a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">st</span> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a>) * (<a class="idref" href="Imp.html#real_fact"><span class="id" type="definition">real_fact</span></a> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>)) = <a class="idref" href="Imp.html#real_fact"><span class="id" type="definition">real_fact</span></a> <span class="id" type="var">x</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="fact_body_preserves_invariant"><span class="id" type="lemma">fact_body_preserves_invariant</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_invariant"><span class="id" type="definition">fact_invariant</span></a> <span class="id" type="var">x</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> &lt;&gt; 0 <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_body"><span class="id" type="definition">fact_body</span></a> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_invariant"><span class="id" type="definition">fact_invariant</span></a> <span class="id" type="var">x</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">fact_invariant</span>, <span class="id" type="var">fact_body</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">x</span> <span class="id" type="var">Hm</span> <span class="id" type="var">HZnz</span> <span class="id" type="var">He</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">He</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">He</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">update</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Show&nbsp;that&nbsp;st&nbsp;Z&nbsp;=&nbsp;S&nbsp;z'&nbsp;for&nbsp;some&nbsp;z'&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) <span class="id" type="keyword">as</span> [| <span class="id" type="var">z'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="SfLib.html#ex_falso_quodlibet"><span class="id" type="lemma">ex_falso_quodlibet</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HZnz</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Hm</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="lemma">mult_assoc</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="constructor">S</span> <span class="id" type="var">z'</span> - 1) <span class="id" type="keyword">with</span> <span class="id" type="var">z'</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="fact_loop_preserves_invariant"><span class="id" type="lemma">fact_loop_preserves_invariant</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_invariant"><span class="id" type="definition">fact_invariant</span></a> <span class="id" type="var">x</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_loop"><span class="id" type="definition">fact_loop</span></a> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_invariant"><span class="id" type="definition">fact_invariant</span></a> <span class="id" type="var">x</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">x</span> <span class="id" type="var">H</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> <a class="idref" href="Imp.html#fact_loop"><span class="id" type="definition">fact_loop</span></a> <span class="id" type="keyword">as</span> <span class="id" type="var">c</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">ceval_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">Hce</span>) <span class="id" type="var">Case</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqc</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heqc</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileEnd".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;trivial&nbsp;when&nbsp;the&nbsp;loop&nbsp;doesn't&nbsp;run...&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileLoop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;the&nbsp;loop&nbsp;does&nbsp;run,&nbsp;we&nbsp;know&nbsp;that&nbsp;fact_body&nbsp;preserves<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fact_invariant&nbsp;--&nbsp;we&nbsp;just&nbsp;need&nbsp;to&nbsp;assemble&nbsp;the&nbsp;pieces&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHHce2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#fact_body_preserves_invariant"><span class="id" type="lemma">fact_body_preserves_invariant</span></a> <span class="id" type="keyword">with</span> <span class="id" type="var">st</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Contra</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Contra</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="guard_false_after_loop"><span class="id" type="lemma">guard_false_after_loop</span></a>: <span style="font-family: arial;">&forall;</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#beval"><span class="id" type="definition">beval</span></a> <span class="id" type="var">st'</span> <span class="id" type="var">b</span> = <span class="id" type="constructor">false</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">cloop</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">ceval_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">Hce</span>) <span class="id" type="var">Case</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqcloop</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heqcloop</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileEnd".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileLoop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHHce2</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Patching it all together... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <a name="fact_com_correct"><span class="id" type="lemma">fact_com_correct</span></a> : <span style="font-family: arial;">&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> = <span class="id" type="var">x</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#fact_com"><span class="id" type="definition">fact_com</span></a> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st'</span> <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> = <a class="idref" href="Imp.html#real_fact"><span class="id" type="definition">real_fact</span></a> <span class="id" type="var">x</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">x</span> <span class="id" type="var">HX</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hce</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">st'</span> <span class="id" type="var">into</span> <span class="id" type="var">st''</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;invariant&nbsp;is&nbsp;true&nbsp;before&nbsp;the&nbsp;loop&nbsp;runs...&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <span class="id" type="var">st</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>)) <a class="idref" href="Imp.html#Y"><span class="id" type="definition">Y</span></a> 1) <span class="id" type="keyword">as</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<a class="idref" href="Imp.html#fact_invariant"><span class="id" type="definition">fact_invariant</span></a> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">fact_invariant</span>, <span class="id" type="var">update</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;...so&nbsp;when&nbsp;the&nbsp;loop&nbsp;is&nbsp;done&nbsp;running,&nbsp;the&nbsp;invariant&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;maintained&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<a class="idref" href="Imp.html#fact_invariant"><span class="id" type="definition">fact_invariant</span></a> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) <span class="id" type="var">st''</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#fact_loop_preserves_invariant"><span class="id" type="lemma">fact_loop_preserves_invariant</span></a> <span class="id" type="keyword">with</span> <span class="id" type="var">st'</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">fact_invariant</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Finally,&nbsp;if&nbsp;the&nbsp;loop&nbsp;terminated,&nbsp;then&nbsp;Z&nbsp;is&nbsp;0;&nbsp;so&nbsp;Y&nbsp;must&nbsp;be<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factorial&nbsp;of&nbsp;X&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <a class="idref" href="Imp.html#guard_false_after_loop"><span class="id" type="lemma">guard_false_after_loop</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">st''</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "st'' Z = 0". <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "st'' Z &gt; 0 (impossible)". <span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
One might wonder whether all this work with poking at states and
    unfolding definitions could be ameliorated with some more powerful
    lemmas and/or more uniform reasoning principles... Indeed, this is
    exactly the topic of the next chapter (<span class="inlinecode"><span class="id" type="var">Hoare.v</span></span>)! 
<div class="paragraph"> </div>

<a name="lab337"></a><h4 class="section">Exercise: 4 stars, optional (subtract_slowly_spec)</h4>
 Prove a specification for subtract_slowly, using the above
    specification of <span class="inlinecode"><span class="id" type="var">fact_com</span></span> and the invariant below as
    guides. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <a name="ss_invariant"><span class="id" type="definition">ss_invariant</span></a> (<span class="id" type="var">x</span>:<span class="id" type="inductive">nat</span>) (<span class="id" type="var">z</span>:<span class="id" type="inductive">nat</span>) (<span class="id" type="var">st</span>:<a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" type="definition">minus</span> (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#Z"><span class="id" type="definition">Z</span></a>) (<span class="id" type="var">st</span> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>) = <span class="id" type="definition">minus</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>.<br/>

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab338"></a><h1 class="section">Additional Exercises</h1>

<div class="paragraph"> </div>

<a name="lab339"></a><h4 class="section">Exercise: 4 stars, optional (add_for_loop)</h4>
 Add C-style <span class="inlinecode"><span class="id" type="keyword">for</span></span> loops to the language of commands, update the
    <span class="inlinecode"><span class="id" type="var">ceval</span></span> definition to define the semantics of <span class="inlinecode"><span class="id" type="keyword">for</span></span> loops, and add
    cases for <span class="inlinecode"><span class="id" type="keyword">for</span></span> loops as needed so that all the proofs in this file
    are accepted by Coq.

<div class="paragraph"> </div>

    A <span class="inlinecode"><span class="id" type="keyword">for</span></span> loop should be parameterized by (a) a statement executed
    initially, (b) a test that is run on each iteration of the loop to
    determine whether the loop should continue, (c) a statement
    executed at the end of each loop iteration, and (d) a statement
    that makes up the body of the loop.  (You don't need to worry
    about making up a concrete Notation for <span class="inlinecode"><span class="id" type="keyword">for</span></span> loops, but feel free
    to play with this too if you like.) 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab340"></a><h4 class="section">Exercise: 3 stars, optional (short_circuit)</h4>
 Most modern programming languages use a "short-circuit" evaluation
    rule for boolean <span class="inlinecode"><span class="id" type="var">and</span></span>: to evaluate <span class="inlinecode"><span class="id" type="var">BAnd</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode"><span class="id" type="var">b2</span></span>, first evaluate
    <span class="inlinecode"><span class="id" type="var">b1</span></span>.  If it evaluates to <span class="inlinecode"><span class="id" type="var">false</span></span>, then the entire <span class="inlinecode"><span class="id" type="var">BAnd</span></span>
    expression evaluates to <span class="inlinecode"><span class="id" type="var">false</span></span> immediately, without evaluating
    <span class="inlinecode"><span class="id" type="var">b2</span></span>.  Otherwise, <span class="inlinecode"><span class="id" type="var">b2</span></span> is evaluated to determine the result of the
    <span class="inlinecode"><span class="id" type="var">BAnd</span></span> expression.

<div class="paragraph"> </div>

    Write an alternate version of <span class="inlinecode"><span class="id" type="var">beval</span></span> that performs short-circuit
    evaluation of <span class="inlinecode"><span class="id" type="var">BAnd</span></span> in this manner, and prove that it is
    equivalent to <span class="inlinecode"><span class="id" type="var">beval</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
<a name="lab341"></a><h4 class="section">Exercise: 4 stars, recommended (stack_compiler)</h4>
 HP Calculators, programming languages like Forth and Postscript,
    and abstract machines like the Java Virtual Machine all evaluate
    arithmetic expressions using a stack. For instance, the expression
<pre>
   (2*3)+(3*(4-2))
</pre>
   would be entered as
<pre>
   2 3 * 3 4 2 - * +
</pre>
   and evaluated like this:
<pre>
  []            |    2 3 * 3 4 2 - * +
  [2]           |    3 * 3 4 2 - * +
  [3, 2]        |    * 3 4 2 - * +
  [6]           |    3 4 2 - * +
  [3, 6]        |    4 2 - * +
  [4, 3, 6]     |    2 - * +
  [2, 4, 3, 6]  |    - * +
  [2, 3, 6]     |    * +
  [6, 6]        |    +
  [12]          | 
</pre>

<div class="paragraph"> </div>

  The task of this exercise is to write a small compiler that
  translates <span class="inlinecode"><span class="id" type="var">aexp</span></span>s into stack machine instructions, and to prove its
  correctness.

<div class="paragraph"> </div>

  The instruction set for our stack language will consist of the
  following instructions:    

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">SPush</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span>: Push the number <span class="inlinecode"><span class="id" type="var">n</span></span> on the stack.

</li>
<li> <span class="inlinecode"><span class="id" type="var">SLoad</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span>: Load the identifier <span class="inlinecode"><span class="id" type="var">X</span></span> from the store and push it
                  on the stack

</li>
<li> <span class="inlinecode"><span class="id" type="var">SPlus</span></span>:   Pop the two top numbers from the stack, add them, and
                  push the result onto the stack.

</li>
<li> <span class="inlinecode"><span class="id" type="var">SMinus</span></span>:  Similar, but subtract.

</li>
<li> <span class="inlinecode"><span class="id" type="var">SMult</span></span>:   Similar, but multiply.

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <a name="sinstr"><span class="id" type="inductive">sinstr</span></a> : <span class="id" type="keyword">Type</span> :=<br/>
| <a name="SPush"><span class="id" type="constructor">SPush</span></a> : <span class="id" type="inductive">nat</span> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a><br/>
| <a name="SLoad"><span class="id" type="constructor">SLoad</span></a> : <a class="idref" href="SfLib.html#id"><span class="id" type="inductive">id</span></a> <span style="font-family: arial;">&rarr;</span> <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a><br/>
| <a name="SPlus"><span class="id" type="constructor">SPlus</span></a> : <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a><br/>
| <a name="SMinus"><span class="id" type="constructor">SMinus</span></a> : <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a><br/>
| <a name="SMult"><span class="id" type="constructor">SMult</span></a> : <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a>.<br/>

<br/>
</div>

<div class="doc">
Write a function to evaluate programs in the stack language. It
    takes as input a state, a stack represented as a list of
    numbers (top stack item is the head of the list), and a program
    represented as a list of instructions, and returns the stack after
    executing the program. Test your function on the examples below.

<div class="paragraph"> </div>

    Note that the specification leaves unspecified what to do when
    encountering an <span class="inlinecode"><span class="id" type="var">SPlus</span></span>, <span class="inlinecode"><span class="id" type="var">SMinus</span></span>, or <span class="inlinecode"><span class="id" type="var">SMult</span></span> instruction if the
    stack contains less than two elements.  In a sense it is
    immaterial, since our compiler will never emit such a malformed
    program. However, when you do the correctness proof you may find
    some choices makes the proof easier than others. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="s_execute"><span class="id" type="definition">s_execute</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">stack</span> : <span class="id" type="inductive">list</span> <span class="id" type="inductive">nat</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">prog</span> : <span class="id" type="inductive">list</span> <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="inductive">list</span> <span class="id" type="inductive">nat</span> :=<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <a class="idref" href="SfLib.html#admit"><span class="id" type="axiom">admit</span></a>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <a name="s_execute1"><span class="id" type="definition">s_execute1</span></a> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#s_execute"><span class="id" type="definition">s_execute</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> [] <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<a class="idref" href="Imp.html#SPush"><span class="id" type="constructor">SPush</span></a> 5, <a class="idref" href="Imp.html#SPush"><span class="id" type="constructor">SPush</span></a> 3, <a class="idref" href="Imp.html#SPush"><span class="id" type="constructor">SPush</span></a> 1, <a class="idref" href="Imp.html#SMinus"><span class="id" type="constructor">SMinus</span></a>]<br/>
&nbsp;&nbsp;&nbsp;= [2, 5].<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <a name="s_execute2"><span class="id" type="definition">s_execute2</span></a> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Imp.html#s_execute"><span class="id" type="definition">s_execute</span></a> (<a class="idref" href="Imp.html#update"><span class="id" type="definition">update</span></a> <a class="idref" href="Imp.html#empty_state"><span class="id" type="definition">empty_state</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a> 3) [3,4] <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<a class="idref" href="Imp.html#SPush"><span class="id" type="constructor">SPush</span></a> 4, <a class="idref" href="Imp.html#SLoad"><span class="id" type="constructor">SLoad</span></a> <a class="idref" href="Imp.html#X"><span class="id" type="definition">X</span></a>, <a class="idref" href="Imp.html#SMult"><span class="id" type="constructor">SMult</span></a>, <a class="idref" href="Imp.html#SPlus"><span class="id" type="constructor">SPlus</span></a>]<br/>
&nbsp;&nbsp;&nbsp;= [15, 4].<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
Next, write a function which compiles an <span class="inlinecode"><span class="id" type="var">aexp</span></span> into a stack
    machine program. The effect of running the program should be the
    same as pushing the value of the expression on the stack. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <a name="s_compile"><span class="id" type="definition">s_compile</span></a> (<span class="id" type="var">e</span> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a>) : <span class="id" type="inductive">list</span> <a class="idref" href="Imp.html#sinstr"><span class="id" type="inductive">sinstr</span></a> :=<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <a class="idref" href="SfLib.html#admit"><span class="id" type="axiom">admit</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;<br/>
Example&nbsp;s_compile1&nbsp;:&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;s_compile&nbsp;(AMinus&nbsp;(AId&nbsp;X)&nbsp;(AMult&nbsp;(ANum&nbsp;2)&nbsp;(AId&nbsp;Y)))<br/>
&nbsp;&nbsp;=&nbsp;<span class="inlinecode"><span class="id" type="var">SLoad</span></span> <span class="inlinecode"><span class="id" type="var">X</span>,</span> <span class="inlinecode"><span class="id" type="var">SPush</span></span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" type="var">SLoad</span></span> <span class="inlinecode"><span class="id" type="var">Y</span>,</span> <span class="inlinecode"><span class="id" type="var">SMult</span>,</span> <span class="inlinecode"><span class="id" type="var">SMinus</span></span>.<br/>
Proof.&nbsp;reflexivity.&nbsp;Qed.<br/>
*)</span><br/>

<br/>
</div>

<div class="doc">
Finally, prove the following theorem, stating that the <span class="inlinecode"><span class="id" type="var">compile</span></span>
    function behaves correctly.  You will need to start by stating a
    more general lemma to get a usable induction hypothesis. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Theorem</span> <a name="s_compile_correct"><span class="id" type="lemma">s_compile_correct</span></a> : <span style="font-family: arial;">&forall;</span> (<span class="id" type="var">st</span> : <a class="idref" href="Imp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="Imp.html#aexp"><span class="id" type="inductive">aexp</span></a>),<br/>
&nbsp;&nbsp;<a class="idref" href="Imp.html#s_execute"><span class="id" type="definition">s_execute</span></a> <span class="id" type="var">st</span> [] (<a class="idref" href="Imp.html#s_compile"><span class="id" type="definition">s_compile</span></a> <span class="id" type="var">e</span>) = [ <a class="idref" href="Imp.html#aeval"><span class="id" type="definition">aeval</span></a> <span class="id" type="var">st</span> <span class="id" type="var">e</span> ].<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>